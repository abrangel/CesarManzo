<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Programaci贸n Cient铆fica y Linux - M谩ster Bioinform谩tica</title>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- CONFIGURACIN BASE --- */
        :root {
            --bg-dark: #1e1e1e;
            --bg-panel: #252526;
            --text-main: #d4d4d4;
            --accent: #007acc;
            --keyword: #c586c0;
            --function: #dcdcaa;
            --string: #ce9178;
            --comment: #6a9955;
            --sidebar-w: 300px;
            --success: #4CAF50;
            --warning: #FF9800;
            --danger: #f44336;
            --info: #2196F3;
            --linux-green: #4CAF50;
            --perl-blue: #0073e6;
            --git-orange: #f1502f;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            background: var(--bg-dark); 
            font-family: 'Roboto', sans-serif; 
            color: var(--text-main); 
            height: 100vh; 
            display: flex; 
            overflow: hidden; 
        }

        /* --- SIDEBAR --- */
        .sidebar { 
            width: var(--sidebar-w); 
            background: #2d2d2d; 
            display: flex; 
            flex-direction: column; 
            border-right: 1px solid #000;
            min-width: 250px;
        }
        
        .header { 
            padding: 20px 15px; 
            background: linear-gradient(135deg, var(--linux-green) 0%, #2e7d32 100%); 
            color: white; 
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .header h2 { 
            margin: 0 0 5px 0; 
            font-size: 1.1rem; 
            font-weight: 700; 
        }
        
        .header span { 
            font-size: 0.8rem; 
            opacity: 0.9; 
            display: block;
        }
        
        .menu { 
            flex: 1; 
            overflow-y: auto; 
            padding: 10px 0;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            color: #ccc;
            cursor: pointer;
            border-left: 4px solid transparent;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            transition: all 0.3s ease;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }
        
        .menu-item:hover { 
            background: rgba(255,255,255,0.05); 
            color: white; 
            padding-left: 18px;
        }
        
        .menu-item.active { 
            background: rgba(76, 175, 80, 0.15); 
            border-left-color: var(--linux-green); 
            color: white; 
            font-weight: 600;
        }
        
        .menu-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: var(--linux-green);
            box-shadow: 0 0 10px var(--linux-green);
        }
        
        .menu-icon {
            font-size: 1rem;
            width: 24px;
            text-align: center;
            color: var(--linux-green);
        }
        
        .menu-item.active .menu-icon {
            color: white;
        }
        
        .menu-text h4 {
            margin: 0 0 4px 0;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .menu-text p {
            margin: 0;
            font-size: 0.75rem;
            color: #aaa;
            line-height: 1.3;
        }

        /* --- REA PRINCIPAL --- */
        .main { 
            flex: 1;
            display: flex; 
            flex-direction: row;
            height: 100%; 
            overflow: hidden;
        }

        .left-column {
            flex: 4;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255,255,255,0.1);
            min-width: 350px;
        }
        
        .code-panel { 
            flex: 3;
            display: flex; 
            flex-direction: column; 
            background: #1e1e1e; 
            border-bottom: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
        }
        
        .panel-title { 
            background: #2d2d2d; 
            padding: 10px 15px; 
            font-size: 0.8rem; 
            text-transform: uppercase; 
            font-weight: 600; 
            color: #bbb; 
            display: flex; 
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .panel-title span:last-child {
            color: var(--success);
            font-weight: 500;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        .editor { 
            flex: 1; 
            padding: 20px; 
            font-family: 'Fira Code', monospace; 
            font-size: 0.9rem; 
            overflow: auto; 
            line-height: 1.6; 
            white-space: pre-wrap;
            background: #1e1e1e;
        }
        
        .c-kwd { color: var(--keyword); font-weight: 500; } 
        .c-fn { color: var(--function); } 
        .c-str { color: var(--string); } 
        .c-com { color: var(--comment); font-style: italic; opacity: 0.9; }
        .c-arg { color: #9cdcfe; } 
        .c-num { color: #b5cea8; }
        .c-var { color: #569cd6; }
        .c-op { color: #d4d4d4; }
        .c-perl { color: var(--perl-blue); }
        .c-git { color: var(--git-orange); }
        .c-linux { color: var(--linux-green); }

        .explanation-panel { 
            flex: 2;
            background: #252526; 
            padding: 15px; 
            overflow-y: auto; 
            font-family: 'Segoe UI', sans-serif; 
            border-top: 2px solid var(--linux-green);
        }
        
        .exp-title { 
            color: var(--linux-green); 
            font-weight: 600; 
            font-size: 1.2rem; 
            margin-bottom: 15px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .exp-text { 
            line-height: 1.7; 
            color: #e9ecef; 
            font-size: 0.95rem; 
        }
        
        .exp-text b {
            color: var(--linux-green);
            font-weight: 600;
        }
        
        .exp-highlight { 
            background: rgba(76, 175, 80, 0.15); 
            padding: 8px 12px; 
            border-radius: 6px; 
            color: #e9ecef; 
            border-left: 3px solid var(--linux-green);
            margin: 10px 0;
        }
        
        .exp-note {
            background: rgba(255, 152, 0, 0.1);
            padding: 8px 12px;
            border-radius: 6px;
            color: #ffcc80;
            border-left: 3px solid #FF9800;
            margin: 10px 0;
            font-size: 0.9rem;
        }

        /* --- PANEL DE VISUALIZACIN --- */
        .viz-panel {
            flex: 5;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .controls {
            background: #e6e6e6;
            padding: 6px 12px;
            border-bottom: 1px solid #bfbfbf;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            min-height: 38px;
            font-family: 'Segoe UI', sans-serif;
            font-size: 0.75rem;
            color: #333;
            box-shadow: none;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 6px;
            border-right: 1px solid #dcdcdc;
            padding-right: 15px;
        }
        
        .control-group:last-child {
            border-right: none;
        }
        
        .control-label {
            font-weight: 700;
            text-transform: uppercase;
            color: #555;
            font-size: 0.65rem;
            letter-spacing: 0.5px;
        }
        
        .controls select, 
        .controls input[type="range"], 
        .controls input[type="text"] {
            background: #fff;
            border: 1px solid #aaa;
            border-radius: 3px;
            padding: 2px 5px;
            font-size: 0.75rem;
            color: #333;
            cursor: pointer;
            height: 24px;
        }
        
        .controls select:hover,
        .controls input:hover {
            border-color: #666;
        }
        
        .controls input[type="checkbox"] {
            cursor: pointer;
            margin: 0;
            width: 14px;
            height: 14px;
        }
        
        .canvas {
            flex: 1;
            background: #fff;
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .terminal {
            width: 90%;
            height: 80%;
            background: #1e1e1e;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            font-family: 'Fira Code', monospace;
        }
        
        .terminal-header {
            background: #2d2d2d;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #444;
        }
        
        .terminal-title {
            font-weight: bold;
            color: #ddd;
        }
        
        .terminal-buttons {
            display: flex;
            gap: 8px;
        }
        
        .terminal-btn {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .terminal-btn.close { background: #ff5f56; }
        .terminal-btn.minimize { background: #ffbd2e; }
        .terminal-btn.maximize { background: #27c93f; }
        
        .terminal-body {
            padding: 15px;
            height: calc(100% - 45px);
            overflow-y: auto;
            color: #0f0;
        }
        
        .terminal-line {
            margin: 5px 0;
            line-height: 1.4;
        }
        
        .terminal-prompt {
            color: #4CAF50;
        }
        
        .terminal-cursor {
            background: #0f0;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .git-node {
            position: absolute;
            width: 100px;
            height: 60px;
            background: white;
            border: 2px solid var(--git-orange);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 2;
        }
        
        .git-commit {
            font-weight: bold;
            font-size: 0.8rem;
            color: var(--git-orange);
        }
        
        .git-hash {
            font-size: 0.7rem;
            color: #777;
            font-family: 'Fira Code', monospace;
        }
        
        .git-branch {
            position: absolute;
            background: #f1502f20;
            border: 1px dashed var(--git-orange);
            border-radius: 4px;
            padding: 3px 8px;
            font-size: 0.7rem;
            color: var(--git-orange);
            font-weight: bold;
        }
        
        .os-process {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            animation: processFloat 3s infinite alternate;
        }
        
        @keyframes processFloat {
            0% { transform: translateY(0); }
            100% { transform: translateY(-10px); }
        }
        
        .file-system-node {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .file-icon {
            color: #4CAF50;
        }
        
        .perl-code-block {
            background: #f8f9fa;
            border-left: 4px solid var(--perl-blue);
            padding: 15px;
            border-radius: 0 4px 4px 0;
            font-family: 'Fira Code', monospace;
            font-size: 0.9rem;
            margin: 10px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #2d2d2d;
            position: relative;
            margin: 10px 0;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--linux-green);
            width: 0%;
            transition: width 0.5s ease-out;
            border-radius: 2px;
        }
        
        /* Scrollbar personalizado */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #2d2d2d;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        @media (max-width: 1000px) {
            .main { flex-direction: column; }
            .left-column { width: 100%; height: 50%; border-right: none; }
            .viz-panel { width: 100%; height: 50%; }
            
            .code-panel {
                border-right: none;
                border-bottom: 1px solid rgba(255,255,255,0.1);
            }
        }

        /* Bot贸n de volver */
        .sidebar-footer {
            margin-top: auto;
            padding: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .back-button-elegant {
            width: 100%;
            padding: 12px;
            background: rgba(0, 122, 204, 0.2);
            border: 1px solid #007acc;
            color: #007acc;
            font-family: 'Roboto', sans-serif;
            font-weight: 700;
            font-size: 0.9rem;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        .back-button-elegant:hover {
            background: #007acc;
            color: white;
            box-shadow: 0 0 15px rgba(0, 122, 204, 0.5);
        }

    </style>
</head>
<body>

    <div class="sidebar">
        <div class="header">
            <h2>Programaci贸n Cient铆fica y Linux</h2>
            <span>MSTER BIOINFORMTICA</span>
        </div>
        <div class="menu" id="menuList"></div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="sidebar-footer">
            <button onclick="window.close()" class="back-button-elegant">
                <i class="fas fa-arrow-left"></i> VOLVER
            </button>
        </div>
    </div>

    <div class="main">
        
        <div class="left-column">
            
            <div class="code-panel">
                <div class="panel-title">
                    <span><i class="fas fa-file-code"></i> C贸digo Ejemplo</span>
                    <span><i class="fas fa-circle"></i> INTERACTIVO</span>
                </div>
                <div class="editor" id="codeEditor"></div>
            </div>

            <div class="explanation-panel">
                <div class="exp-title"><i class="fas fa-chalkboard-teacher"></i> Explicaci贸n del Profesor</div>
                <div class="exp-text" id="explanationText"></div>
            </div>

        </div>

        <div class="viz-panel">
            <div class="controls" id="controlsArea"></div>
            <div class="canvas" id="canvasArea"></div>
        </div>

    </div>

    <script>
        // --- BASE DE DATOS DE LOS 10 TEMAS ---
        const lessons = [
                        {
                id: 1,
                title: "Tema 1. Introducci贸n Bioinform谩tica",
                desc: "Fundamentos, herramientas y flujo de trabajo avanzado",
                icon: "fa-dna",
                controls: [
                    {id: 'workflow', type: 'select', label: 'Flujo de Trabajo', options: ['An谩lisis Gen贸mico', 'Transcript贸mica', 'Prote贸mica', 'Metagen贸mica', 'Farmacogen贸mica', 'Bioinform谩tica Estructural']},
                    {id: 'stage_detail', type: 'select', label: 'Nivel de Detalle', options: ['B谩sico', 'Intermedio', 'Avanzado']},
                    {id: 'animation_speed', type: 'range', label: 'Velocidad Animaci贸n', min: 1, max: 10, step: 1, val: 5}
                ],
                code: (p) => {
                    const workflow = p.workflow;
                    const detail = p.stage_detail;
                    
                    // Mapeo de niveles en espa帽ol a ingl茅s
                    const detailMap = {
                        'B谩sico': 'basic',
                        'Intermedio': 'intermediate', 
                        'Avanzado': 'advanced'
                    };
                    
                    const detailLevel = detailMap[detail] || 'intermediate';
                    
                    // Definir templates para cada workflow
                    const workflowTemplates = {
                        'An谩lisis Gen贸mico': {
                            basic: `# ANLISIS GENMICO - Pipeline b谩sico
# Objetivo: Identificar variantes gen茅ticas

1. Control calidad (FastQC)
2. Alineamiento (BWA, Bowtie2)
3. Procesamiento BAM (samtools)
4. Llamado variantes (GATK, bcftools)
5. Anotaci贸n (SnpEff, ANNOVAR)`,
                            intermediate: `<span class="c-com"># ANLISIS GENMICO COMPLETO</span>
<span class="c-com"># Pipeline para WGS/WES</span>

<span class="c-kwd"># 1. Control de calidad y preprocesamiento</span>
<span class="c-linux">$ fastqc *.fastq.gz -o qc/</span>
<span class="c-linux">$ trim_galore --paired --quality 20 *.fastq.gz</span>

<span class="c-kwd"># 2. Alineamiento a referencia</span>
<span class="c-linux">$ bwa index referencia.fasta</span>
<span class="c-linux">$ bwa mem -t 8 referencia.fasta R1.fastq.gz R2.fastq.gz | \\</span>
<span class="c-linux">  samtools sort -@ 4 -o alineado.bam -</span>

<span class="c-kwd"># 3. Post-procesamiento BAM</span>
<span class="c-linux">$ samtools index alineado.bam</span>
<span class="c-linux">$ gatk MarkDuplicates -I alineado.bam -O marcados.bam -M metrics.txt</span>

<span class="c-kwd"># 4. Llamado de variantes</span>
<span class="c-linux">$ gatk HaplotypeCaller -R referencia.fasta -I marcados.bam \\</span>
<span class="c-linux">  -O variantes.vcf --emit-ref-confidence GVCF</span>`,
                            advanced: `<span class="c-com"># ANLISIS GENMICO AVANZADO</span>
<span class="c-com"># An谩lisis multi-muestra con controles de calidad estrictos</span>

<span class="c-kwd">#!/bin/bash</span>
<span class="c-com"># Configuraci贸n</span>
<span class="c-var">REF</span>=<span class="c-str">"hg38.fasta"</span>
<span class="c-var">DBSNP</span>=<span class="c-str">"dbsnp_138.hg38.vcf.gz"</span>
<span class="c-var">KNOWN_INDELS</span>=<span class="c-str">"Mills_and_1000G_gold_standard.indels.hg38.vcf.gz"</span>
<span class="c-var">THREADS</span>=<span class="c-num">16</span>

<span class="c-kwd">function</span> <span class="c-fn">qc_pipeline</span>() {
    <span class="c-var">sample</span>=<span class="c-str">"$1"</span>
    <span class="c-fn">echo</span> <span class="c-str">"Procesando muestra: $sample"</span>
    
    <span class="c-com"># FastQC + MultiQC</span>
    <span class="c-linux">fastqc \${sample}_R1.fastq.gz \${sample}_R2.fastq.gz -t $THREADS</span>
    <span class="c-linux">multiqc . -n "\${sample}_qc_report"</span>
    
    <span class="c-com"># Alineamiento con BWA-MEM2 (m谩s r谩pido)</span>
    <span class="c-linux">bwa-mem2 mem -t $THREADS -R "@RG\\tID:\${sample}\\tSM:\${sample}\\tPL:ILLUMINA" \\</span>
    <span class="c-linux">  $REF \${sample}_R1.fastq.gz \${sample}_R2.fastq.gz | \\</span>
    <span class="c-linux">  samtools sort -@ 4 -o \${sample}.sorted.bam -</span>
    
    <span class="c-com"># M茅tricas de alineamiento</span>
    <span class="c-linux">samtools flagstat \${sample}.sorted.bam > \${sample}.flagstat.txt</span>
    <span class="c-linux">samtools stats \${sample}.sorted.bam > \${sample}.stats.txt</span>
}

<span class="c-com"># Anotaci贸n avanzada con VEP</span>
<span class="c-kwd">vep</span> --input_file variantes_filtradas.vcf \\
    --output_file variantes_anotadas.vcf \\
    --format vcf --species homo_sapiens \\
    --cache --dir_cache /path/to/vep_cache \\
    --assembly GRCh38 --offline \\
    --plugin CADD,/path/to/CADD_scores.tsv.gz \\
    --plugin dbNSFP,/path/to/dbNSFP.gz,ALL \\
    --custom /path/to/clinvar.vcf.gz,ClinVar,vcf,exact,0,CLNSIG`
                        },
                        'Transcript贸mica': {
                            basic: `# ANLISIS TRANSCRIPTOMICO (RNA-seq)
# Objetivo: Expresi贸n g茅nica diferencial

1. Control calidad (FastQC, RSeQC)
2. Alineamiento (STAR, HISAT2)
3. Cuantificaci贸n (featureCounts, HTSeq)
4. DEA (DESeq2, edgeR, limma)
5. Enriquecimiento funcional (GO, KEGG)`,
                            intermediate: `<span class="c-com"># RNA-SEQ ANALYSIS PIPELINE</span>

<span class="c-com"># 1. Quality control and trimming</span>
<span class="c-linux">$ fastqc *.fastq.gz -t 4</span>
<span class="c-linux">$ trimmomatic PE -threads 4 input_R1.fastq.gz input_R2.fastq.gz \\</span>
<span class="c-linux">  output_R1_paired.fastq.gz output_R1_unpaired.fastq.gz \\</span>
<span class="c-linux">  output_R2_paired.fastq.gz output_R2_unpaired.fastq.gz \\</span>
<span class="c-linux">  ILLUMINACLIP:adapters.fa:2:30:10 LEADING:3 TRAILING:3 SLIDINGWINDOW:4:15 MINLEN:36</span>

<span class="c-com"># 2. Alignment with STAR</span>
<span class="c-linux">$ STAR --runThreadN 8 --genomeDir /path/to/genome_index \\</span>
<span class="c-linux">  --readFilesIn R1_paired.fastq.gz R2_paired.fastq.gz \\</span>
<span class="c-linux">  --readFilesCommand zcat --outSAMtype BAM SortedByCoordinate \\</span>
<span class="c-linux">  --outFileNamePrefix aligned.</span>

<span class="c-com"># 3. Quantification with featureCounts</span>
<span class="c-linux">$ featureCounts -T 8 -p -a annotation.gtf -o counts.txt \\</span>
<span class="c-linux">  aligned*.bam</span>`,
                            advanced: `<span class="c-com"># TRANSCRIPTOMICA AVANZADA</span>
<span class="c-com"># An谩lisis completo con control de batch effects y an谩lisis alternativo</span>

<span class="c-kwd">library</span>(DESeq2)
<span class="c-kwd">library</span>(tximport)
<span class="c-kwd">library</span>(limma)
<span class="c-kwd">library</span>(sva)

<span class="c-com"># 1. Importar datos de Salmon</span>
<span class="c-var">files</span> <span class="c-op"><-</span> <span class="c-fn">file.path</span>(<span class="c-str">"quants"</span>, <span class="c-fn">dir</span>(<span class="c-str">"quants"</span>), <span class="c-str">"quant.sf"</span>)
<span class="c-var">names</span>(<span class="c-var">files</span>) <span class="c-op"><-</span> <span class="c-fn">dir</span>(<span class="c-str">"quants"</span>)

<span class="c-var">txi</span> <span class="c-op"><-</span> <span class="c-fn">tximport</span>(<span class="c-var">files</span>, <span class="c-arg">type</span>=<span class="c-str">"salmon"</span>, <span class="c-arg">tx2gene</span>=<span class="c-var">tx2gene</span>)

<span class="c-com"># 2. Crear objeto DESeq2 con dise帽o experimental</span>
<span class="c-var">coldata</span> <span class="c-op"><-</span> <span class="c-fn">data.frame</span>(
  <span class="c-arg">condition</span> = <span class="c-fn">factor</span>(<span class="c-fn">rep</span>(<span class="c-fn">c</span>(<span class="c-str">"control"</span>, <span class="c-str">"treatment"</span>), <span class="c-num">3</span>)),
  <span class="c-arg">batch</span> = <span class="c-fn">factor</span>(<span class="c-fn">c</span>(<span class="c-num">1</span>,<span class="c-num">1</span>,<span class="c-num">2</span>,<span class="c-num">2</span>,<span class="c-num">3</span>,<span class="c-num">3</span>))
)

<span class="c-var">dds</span> <span class="c-op"><-</span> <span class="c-fn">DESeqDataSetFromTximport</span>(<span class="c-var">txi</span>, <span class="c-var">coldata</span>, 
                                  <span class="c-arg">design</span> = ~ <span class="c-var">batch</span> + <span class="c-var">condition</span>)

<span class="c-com"># 3. Correcci贸n de efectos de batch con Combat-seq</span>
<span class="c-var">adjusted_counts</span> <span class="c-op"><-</span> <span class="c-fn">ComBat_seq</span>(<span class="c-fn">counts</span>(<span class="c-var">dds</span>), 
                                   <span class="c-arg">batch</span>=<span class="c-var">coldata</span>$<span class="c-var">batch</span>,
                                   <span class="c-arg">group</span>=<span class="c-var">coldata</span>$<span class="c-var">condition</span>)

<span class="c-com"># 4. An谩lisis de expresi贸n diferencial</span>
<span class="c-var">dds</span> <span class="c-op"><-</span> <span class="c-fn">DESeq</span>(<span class="c-var">dds</span>)
<span class="c-var">res</span> <span class="c-op"><-</span> <span class="c-fn">results</span>(<span class="c-var">dds</span>, <span class="c-arg">contrast</span>=<span class="c-fn">c</span>(<span class="c-str">"condition"</span>, <span class="c-str">"treatment"</span>, <span class="c-str">"control"</span>))

<span class="c-com"># 5. An谩lisis de rutas y GSEA</span>
<span class="c-kwd">library</span>(clusterProfiler)
<span class="c-kwd">library</span>(org.Hs.eg.db)

<span class="c-var">geneList</span> <span class="c-op"><-</span> <span class="c-var">res</span>$<span class="c-var">log2FoldChange</span>
<span class="c-var">names</span>(<span class="c-var">geneList</span>) <span class="c-op"><-</span> <span class="c-fn">rownames</span>(<span class="c-var">res</span>)
<span class="c-var">geneList</span> <span class="c-op"><-</span> <span class="c-fn">sort</span>(<span class="c-var">geneList</span>, <span class="c-arg">decreasing</span> = <span class="c-kwd">TRUE</span>)

<span class="c-var">gsea_result</span> <span class="c-op"><-</span> <span class="c-fn">gseGO</span>(<span class="c-var">geneList</span>, <span class="c-arg">ont</span>=<span class="c-str">"BP"</span>, <span class="c-arg">OrgDb</span>=org.Hs.eg.db,
                       <span class="c-arg">keyType</span> = <span class="c-str">"ENSEMBL"</span>, <span class="c-arg">nPerm</span> = <span class="c-num">1000</span>)`
                        },
                        'Prote贸mica': {
                            basic: `# ANLISIS PROTEMICO
# Objetivo: Identificaci贸n y cuantificaci贸n de prote铆nas

1. Datos espectrometr铆a de masas
2. Identificaci贸n de p茅ptidos (MaxQuant, PD)
3. Cuantificaci贸n proteica
4. An谩lisis estad铆stico
5. Enriquecimiento funcional`,
                            intermediate: `<span class="c-com"># ANLISIS PROTEMICO BSICO</span>
<span class="c-com"># Pipeline para espectrometr铆a de masas</span>

<span class="c-com"># 1. Procesamiento de archivos RAW</span>
<span class="c-linux">$ msconvert *.raw --mzXML --filter "peakPicking true 1-"</span>

<span class="c-com"># 2. B煤squeda de base de datos con Comet</span>
<span class="c-linux">$ comet -Pcomet.params *.mzXML</span>

<span class="c-com"># 3. An谩lisis de resultados</span>
<span class="c-linux">$ percolator *.pep.xml</span>`,
                            advanced: `<span class="c-com"># ANLISIS PROTEMICO AVANZADO</span>
<span class="c-com"># An谩lisis cuantitativo con espectrometr铆a de masas</span>

<span class="c-kwd">library</span>(MSnbase)
<span class="c-kwd">library</span>(DEP)

<span class="c-com"># Cargar datos de expresi贸n proteica</span>
<span class="c-var">data</span> <span class="c-op"><-</span> <span class="c-fn">read.csv</span>(<span class="c-str">"protein_quantification.csv"</span>)
<span class="c-var">experimental_design</span> <span class="c-op"><-</span> <span class="c-fn">data.frame</span>(
  <span class="c-arg">label</span> = <span class="c-fn">colnames</span>(<span class="c-var">data</span>)[<span class="c-num">2</span>:<span class="c-num">7</span>],
  <span class="c-arg">condition</span> = <span class="c-fn">rep</span>(<span class="c-fn">c</span>(<span class="c-str">"control"</span>, <span class="c-str">"treatment"</span>), <span class="c-num">3</span>),
  <span class="c-arg">replicate</span> = <span class="c-fn">rep</span>(<span class="c-num">1</span>:<span class="c-num">3</span>, <span class="c-num">2</span>)
)

<span class="c-com"># An谩lisis diferencial</span>
<span class="c-var">results</span> <span class="c-op"><-</span> <span class="c-fn">test_diff</span>(<span class="c-var">data</span>, <span class="c-arg">type</span> = <span class="c-str">"control"</span>, <span class="c-arg">control</span> = <span class="c-str">"control"</span>)`
                        },
                        'Metagen贸mica': {
                            basic: `# ANLISIS METAGENMICO
# Objetivo: Estudio de comunidades microbianas

1. Control calidad lecturas
2. Ensamblaje (MEGAHIT, metaSPAdes)
3. Binning (MaxBin, MetaBAT2)
4. Anotaci贸n taxon贸mica
5. An谩lisis de diversidad`,
                            intermediate: `<span class="c-com"># PIPELINE METAGENMICO BSICO</span>
<span class="c-com"># An谩lisis de microbioma con QIIME2</span>

<span class="c-linux">$ qiime tools import --type 'SampleData[PairedEndSequencesWithQuality]' \\</span>
<span class="c-linux">  --input-path manifest.tsv --output-path demux.qza</span>

<span class="c-linux">$ qiime dada2 denoise-paired --i-demultiplexed-seqs demux.qza \\</span>
<span class="c-linux">  --p-trunc-len-f 220 --p-trunc-len-r 200 --o-table table.qza</span>

<span class="c-linux">$ qiime feature-classifier classify-sklearn --i-classifier classifier.qza \\</span>
<span class="c-linux">  --i-reads rep-seqs.qza --o-classification taxonomy.qza</span>`,
                            advanced: `<span class="c-com"># METAGENMICA AVANZADA</span>
<span class="c-com"># An谩lisis funcional y taxon贸mico completo</span>

<span class="c-kwd">library</span>(phyloseq)
<span class="c-kwd">library</span>(vegan)

<span class="c-com"># Crear objeto phyloseq</span>
<span class="c-var">otu_table</span> <span class="c-op"><-</span> <span class="c-fn">read.csv</span>(<span class="c-str">"otu_table.csv"</span>, <span class="c-arg">row.names</span>=<span class="c-num">1</span>)
<span class="c-var">tax_table</span> <span class="c-op"><-</span> <span class="c-fn">read.csv</span>(<span class="c-str">"taxonomy.csv"</span>, <span class="c-arg">row.names</span>=<span class="c-num">1</span>)
<span class="c-var">metadata</span> <span class="c-op"><-</span> <span class="c-fn">read.csv</span>(<span class="c-str">"metadata.csv"</span>, <span class="c-arg">row.names</span>=<span class="c-num">1</span>)

<span class="c-var">physeq</span> <span class="c-op"><-</span> <span class="c-fn">phyloseq</span>(<span class="c-fn">otu_table</span>(<span class="c-var">otu_table</span>, <span class="c-arg">taxa_are_rows</span>=<span class="c-kwd">TRUE</span>),
                   <span class="c-fn">tax_table</span>(<span class="c-fn">as.matrix</span>(<span class="c-var">tax_table</span>)),
                   <span class="c-fn">sample_data</span>(<span class="c-var">metadata</span>))

<span class="c-com"># An谩lisis de diversidad alfa</span>
<span class="c-var">alpha_div</span> <span class="c-op"><-</span> <span class="c-fn">estimate_richness</span>(<span class="c-var">physeq</span>, <span class="c-arg">measures</span>=<span class="c-fn">c</span>(<span class="c-str">"Shannon"</span>, <span class="c-str">"Simpson"</span>))`
                        }
                    };
                    
                    // Si el workflow no est谩 definido, usar un gen茅rico
                    if (!workflowTemplates[workflow]) {
                        return `<span class="c-com"># FLUJO DE TRABAJO BIOINFORMTICO</span>
<span class="c-com"># ${workflow.toUpperCase()} - Pipeline b谩sico</span>

<span class="c-com"># 1. Adquisici贸n de datos</span>
<span class="c-com"># 2. Control de calidad</span>
<span class="c-com"># 3. Procesamiento espec铆fico</span>
<span class="c-com"># 4. An谩lisis estad铆stico</span>
<span class="c-com"># 5. Visualizaci贸n e interpretaci贸n</span>`;
                    }
                    
                    // Obtener el template para el workflow y nivel
                    const template = workflowTemplates[workflow];
                    const codeTemplate = template[detailLevel] || template.intermediate;
                    
                    return codeTemplate;
                },
                explain: (p) => {
                    const workflow = p.workflow;
                    const detail = p.stage_detail;
                    
                    const workflowDescriptions = {
                        'An谩lisis Gen贸mico': {
                            title: "An谩lisis Gen贸mico",
                            description: "Estudio del genoma completo mediante secuenciaci贸n de ADN para identificar variantes gen茅ticas, mutaciones y polimorfismos.",
                            applications: [
                                "Secuenciaci贸n del genoma completo (WGS)",
                                "Secuenciaci贸n del exoma (WES)", 
                                "Identificaci贸n de variantes (SNPs, Indels)",
                                "An谩lisis de CNVs (Copy Number Variations)",
                                "Farmacogen贸mica"
                            ],
                            tools: [
                                {name: "FastQC", purpose: "Control de calidad", color: "#3498db"},
                                {name: "BWA", purpose: "Alineamiento", color: "#2ecc71"},
                                {name: "GATK", purpose: "Llamado de variantes", color: "#e74c3c"},
                                {name: "SnpEff", purpose: "Anotaci贸n", color: "#f39c12"},
                                {name: "IGV", purpose: "Visualizaci贸n", color: "#9b59b6"}
                            ],
                            outputs: "VCF (Variant Call Format), BAM (alineamientos), reportes de QC"
                        },
                        'Transcript贸mica': {
                            title: "Transcript贸mica (RNA-seq)",
                            description: "An谩lisis del transcriptoma mediante secuenciaci贸n de ARN para estudiar la expresi贸n g茅nica, splicing alternativo y variantes de ARN.",
                            applications: [
                                "Expresi贸n g茅nica diferencial",
                                "An谩lisis de splicing alternativo",
                                "Detecci贸n de fusiones g茅nicas",
                                "Identificaci贸n de nuevos transcritos",
                                "Single-cell RNA-seq"
                            ],
                            tools: [
                                {name: "STAR", purpose: "Alineamiento", color: "#3498db"},
                                {name: "DESeq2", purpose: "DEA", color: "#2ecc71"},
                                {name: "Salmon", purpose: "Cuantificaci贸n", color: "#e74c3c"},
                                {name: "StringTie", purpose: "Ensamblaje", color: "#f39c12"},
                                {name: "clusterProfiler", purpose: "Enriquecimiento", color: "#9b59b6"}
                            ],
                            outputs: "Count matrices, resultados DEA, gr谩ficos de expresi贸n"
                        },
                        'Prote贸mica': {
                            title: "Prote贸mica",
                            description: "Estudio a gran escala de prote铆nas, incluyendo su estructura, funci贸n, modificaciones post-traduccionales e interacciones.",
                            applications: [
                                "Identificaci贸n de prote铆nas",
                                "An谩lisis cuantitativo",
                                "PTMs (modificaciones post-traduccionales)",
                                "Interact贸mica",
                                "Prote贸mica dirigida"
                            ],
                            tools: [
                                {name: "MaxQuant", purpose: "Identificaci贸n", color: "#3498db"},
                                {name: "PDV", purpose: "Visualizaci贸n", color: "#2ecc71"},
                                {name: "Skyline", purpose: "Cuantificaci贸n", color: "#e74c3c"},
                                {name: "STRING", purpose: "Interacciones", color: "#f39c12"}
                            ],
                            outputs: "Listas de prote铆nas, intensidades, redes de interacci贸n"
                        },
                        'Metagen贸mica': {
                            title: "Metagen贸mica",
                            description: "Estudio de comunidades microbianas directamente de muestras ambientales sin necesidad de cultivo.",
                            applications: [
                                "Caracterizaci贸n microbiana",
                                "Diversidad alfa/beta",
                                "An谩lisis funcional",
                                "Pat贸genos emergentes",
                                "Microbioma humano"
                            ],
                            tools: [
                                {name: "QIIME2", purpose: "An谩lisis", color: "#3498db"},
                                {name: "MetaPhlAn", purpose: "Taxonom铆a", color: "#2ecc71"},
                                {name: "HUMAnN", purpose: "Rutas metab贸licas", color: "#e74c3c"},
                                {name: "Kraken2", purpose: "Clasificaci贸n", color: "#f39c12"}
                            ],
                            outputs: "Tablas OTU/ASV, perfiles taxon贸micos, perfiles funcionales"
                        }
                    };
                    
                    const desc = workflowDescriptions[workflow] || {
                        title: workflow,
                        description: "An谩lisis bioinform谩tico especializado.",
                        applications: ["An谩lisis de datos biol贸gicos"],
                        tools: [{name: "Herramientas bioinform谩ticas", purpose: "An谩lisis", color: "#3498db"}],
                        outputs: "Resultados del an谩lisis"
                    };
                    
                    return `
                    <div class="exp-highlight" style="animation: fadeIn 1s ease-out;">
                        <b>К ${desc.title}</b>
                        <p>${desc.description}</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <div>
                            <h4 style="color: var(--linux-green); margin-bottom: 10px;">
                                <i class="fas fa-flask"></i> Aplicaciones
                            </h4>
                            <ul style="font-size: 0.9rem; line-height: 1.6;">
                                ${desc.applications.map(app => `<li>${app}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div>
                            <h4 style="color: var(--linux-green); margin-bottom: 10px;">
                                <i class="fas fa-tools"></i> Herramientas Clave
                            </h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px;">
                                ${desc.tools.map(tool => `
                                    <span style="background: ${tool.color}20; color: ${tool.color}; 
                                          padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;
                                          border-left: 3px solid ${tool.color};">
                                        <b>${tool.name}</b><br>
                                        <small>${tool.purpose}</small>
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <div class="exp-note" style="animation: slideIn 0.5s ease-out;">
                        <i class="fas fa-database"></i> <b>Salidas t铆picas:</b>
                        <p style="margin: 8px 0 0 0; font-size: 0.9rem;">
                            ${desc.outputs}
                        </p>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, rgba(33, 150, 243, 0.1), rgba(76, 175, 80, 0.1)); 
                         padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #2196F3;">
                        <h4 style="color: #2196F3; margin-bottom: 10px;">
                            <i class="fas fa-lightbulb"></i> Consideraciones importantes
                        </h4>
                        <ul style="font-size: 0.9rem; line-height: 1.6;">
                            <li><b>Control de calidad:</b> Primer paso cr铆tico en cualquier an谩lisis</li>
                            <li><b>Reproducibilidad:</b> Usar contenedores (Docker/Singularity) y gestores de paquetes (conda)</li>
                            <li><b>Metadatos:</b> Documentar exhaustivamente las condiciones experimentales</li>
                            <li><b>Escalabilidad:</b> Dise帽ar pipelines que puedan escalar a grandes vol煤menes de datos</li>
                            <li><b>Interpretaci贸n biol贸gica:</b> El an谩lisis estad铆stico debe llevar a comprensi贸n biol贸gica</li>
                        </ul>
                    </div>
                    
                    <style>
                        @keyframes fadeIn {
                            from { opacity: 0; transform: translateY(-10px); }
                            to { opacity: 1; transform: translateY(0); }
                        }
                        @keyframes slideIn {
                            from { opacity: 0; transform: translateX(-20px); }
                            to { opacity: 1; transform: translateX(0); }
                        }
                    </style>`;
                },
                                render: (p, div) => {
                    div.style.cssText = "width:100%; height:100%; position:relative; overflow:hidden; background: linear-gradient(135deg, #0c2461 0%, #1e3799 50%, #4a69bd 100%);";
                    div.innerHTML = '';
                    
                    const workflow = p.workflow;
                    const animSpeed = 11 - p.animation_speed;
                    
                    const workflowViz = document.createElement('div');
                    workflowViz.style.cssText = "width:100%; height:100%; position:relative; perspective: 1200px;";
                    
                    const container3D = document.createElement('div');
                    container3D.style.cssText = `
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%) rotateX(15deg);
                        width: 800px;
                        height: 800px;
                        transform-style: preserve-3d;
                        animation: slowRotate ${animSpeed * 8}s linear infinite;
                    `;
                    
                    const workflowStages = {
                        'An谩lisis Gen贸mico': [
                            {name: "FastQ Files", icon: "fa-file-alt", color: "#3498db", desc: "Datos crudos de secuenciaci贸n"},
                            {name: "QC", icon: "fa-filter", color: "#2ecc71", desc: "Control de calidad"},
                            {name: "Alignment", icon: "fa-link", color: "#e74c3c", desc: "Alineamiento a referencia"},
                            {name: "Variant Calling", icon: "fa-search", color: "#f39c12", desc: "Identificaci贸n de variantes"},
                            {name: "Annotation", icon: "fa-tag", color: "#9b59b6", desc: "Anotaci贸n funcional"},
                            {name: "Interpretation", icon: "fa-chart-bar", color: "#1abc9c", desc: "Interpretaci贸n biol贸gica"}
                        ],
                        'Transcript贸mica': [
                            {name: "RNA-seq Data", icon: "fa-dna", color: "#3498db", desc: "Lecturas de ARN"},
                            {name: "QC & Trim", icon: "fa-cut", color: "#2ecc71", desc: "Control calidad y recorte"},
                            {name: "Alignment", icon: "fa-project-diagram", color: "#e74c3c", desc: "Alineamiento transcript贸mico"},
                            {name: "Quantification", icon: "fa-calculator", color: "#f39c12", desc: "Cuantificaci贸n expresi贸n"},
                            {name: "DE Analysis", icon: "fa-chart-line", color: "#9b59b6", desc: "Expresi贸n diferencial"},
                            {name: "Pathway Analysis", icon: "fa-sitemap", color: "#1abc9c", desc: "An谩lisis de rutas"}
                        ],
                        'Prote贸mica': [
                            {name: "Mass Spec", icon: "fa-atom", color: "#3498db", desc: "Datos espectrometr铆a"},
                            {name: "Peptide ID", icon: "fa-barcode", color: "#2ecc71", desc: "Identificaci贸n p茅ptidos"},
                            {name: "Quantification", icon: "fa-balance-scale", color: "#e74c3c", desc: "Cuantificaci贸n proteica"},
                            {name: "PTM Analysis", icon: "fa-star", color: "#f39c12", desc: "Modificaciones post-traduccionales"},
                            {name: "Network Analysis", icon: "fa-network-wired", color: "#9b59b6", desc: "An谩lisis de redes"},
                            {name: "Validation", icon: "fa-check-double", color: "#1abc9c", desc: "Validaci贸n experimental"}
                        ],
                        'Metagen贸mica': [
                            {name: "Metagenomic Reads", icon: "fa-vial", color: "#3498db", desc: "Lecturas ambientales"},
                            {name: "Assembly", icon: "fa-puzzle-piece", color: "#2ecc71", desc: "Ensamblaje metagen贸mico"},
                            {name: "Binning", icon: "fa-box", color: "#e74c3c", desc: "Agrupamiento por genoma"},
                            {name: "Taxonomy", icon: "fa-sitemap", color: "#f39c12", desc: "Clasificaci贸n taxon贸mica"},
                            {name: "Functional", icon: "fa-cogs", color: "#9b59b6", desc: "An谩lisis funcional"},
                            {name: "Diversity", icon: "fa-chart-pie", color: "#1abc9c", desc: "An谩lisis de diversidad"}
                        ]
                    };
                    
                    const stages = workflowStages[workflow] || workflowStages['An谩lisis Gen贸mico'];
                    const radius = 300;
                    const centerX = 0;
                    const centerY = 0;
                    
                    // L铆neas de conexi贸n (detr谩s)
                    stages.forEach((stage, i) => {
                        const angle = (i / stages.length) * 2 * Math.PI - Math.PI / 2;
                        const nextAngle = ((i + 1) % stages.length / stages.length) * 2 * Math.PI - Math.PI / 2;
                        
                        const x1 = centerX + radius * Math.cos(angle);
                        const y1 = centerY + radius * Math.sin(angle);
                        const x2 = centerX + radius * Math.cos(nextAngle);
                        const y2 = centerY + radius * Math.sin(nextAngle);
                        
                        const line = document.createElement('div');
                        line.style.cssText = `
                            position: absolute;
                            left: 50%;
                            top: 50%;
                            width: ${Math.hypot(x2 - x1, y2 - y1)}px;
                            height: 3px;
                            background: linear-gradient(90deg, ${stage.color}, ${stages[(i + 1) % stages.length].color});
                            transform: translate(${x1}px, ${y1}px) rotate(${Math.atan2(y2 - y1, x2 - x1)}rad);
                            transform-origin: 0 0;
                            opacity: 0.6;
                            z-index: 1;
                        `;
                        container3D.appendChild(line);
                    });
                    
                    // Nodos de etapas
                    stages.forEach((stage, i) => {
                        const angle = (i / stages.length) * 2 * Math.PI - Math.PI / 2;
                        const x = centerX + radius * Math.cos(angle);
                        const y = centerY + radius * Math.sin(angle);
                        
                        const stageElement = document.createElement('div');
                        stageElement.style.cssText = `
                            position: absolute;
                            left: 50%;
                            top: 50%;
                            transform: translate(${x - 60}px, ${y - 60}px);
                            width: 120px;
                            height: 120px;
                            background: rgba(255, 255, 255, 0.97);
                            border-radius: 20px;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            box-shadow: 0 12px 30px rgba(0,0,0,0.4);
                            border: 4px solid ${stage.color};
                            transition: transform 0.3s ease;
                            z-index: 2;
                        `;
                        stageElement.innerHTML = `
                            <i class="fas ${stage.icon}" style="font-size: 2.2rem; color: ${stage.color}; margin-bottom: 8px;"></i>
                            <div style="font-weight: bold; color: #333; font-size: 0.9rem;">${stage.name}</div>
                            <div style="font-size: 0.75rem; color: #555; text-align: center; padding: 0 8px;">${stage.desc}</div>
                        `;
                        stageElement.onmouseover = () => stageElement.style.transform = `translate(${x - 60}px, ${y - 60}px) scale(1.15)`;
                        stageElement.onmouseout = () => stageElement.style.transform = `translate(${x - 60}px, ${y - 60}px) scale(1)`;
                        
                        container3D.appendChild(stageElement);
                    });
                    
                    // Animaci贸n de rotaci贸n lenta del contenedor
                    const style = document.createElement('style');
                    style.textContent = `
                        @keyframes slowRotate {
                            from { transform: translate(-50%, -50%) rotateX(15deg) rotateY(0deg); }
                            to { transform: translate(-50%, -50%) rotateX(15deg) rotateY(360deg); }
                        }
                    `;
                    document.head.appendChild(style);
                    
                    workflowViz.appendChild(container3D);
                    div.appendChild(workflowViz);
			}
                },
                        {
                id: 2,
                title: "Tema 2. Control de Versiones (Git)",
                desc: "Git, GitHub, branching y colaboraci贸n",
                icon: "fa-code-branch",
                controls: [
                    {id: 'git_command', type: 'select', label: 'Comando Git', options: ['git init', 'git add', 'git commit', 'git branch', 'git merge', 'git pull', 'git push', 'git log', 'git stash']},
                    {id: 'branch_count', type: 'range', label: 'N煤mero de Ramas', min: 1, max: 7, step: 1, val: 3},
                    {id: 'animation_speed', type: 'range', label: 'Velocidad Animaci贸n', min: 1, max: 10, step: 1, val: 5}
                ],
                code: (p) => {
                    const command = p.git_command;
                    
                    if (command === 'git init') {
                        return `<span class="c-com"># INICIALIZAR UN REPOSITORIO GIT</span>
<span class="c-com"># Crea un nuevo repositorio Git en el directorio actual</span>

<span class="c-linux">$ git init</span>

<span class="c-com"># Esto crea un directorio .git/ con toda la configuraci贸n:</span>
<span class="c-com">#   - HEAD: Apunta a la rama actual (por defecto 'main' o 'master')</span>
<span class="c-com">#   - config: Configuraci贸n del repositorio</span>
<span class="c-com">#   - description: Descripci贸n del repositorio</span>
<span class="c-com">#   - hooks/: Directorio para hooks personalizados</span>
<span class="c-com">#   - info/: Informaci贸n adicional (exclude, etc.)</span>
<span class="c-com">#   - objects/: Almacena todos los objetos (commits, 谩rboles, blobs)</span>
<span class="c-com">#   - refs/: Referencias a ramas y tags</span>

<span class="c-com"># Inicializar con un nombre de rama espec铆fico (nueva convenci贸n)</span>
<span class="c-linux">$ git init -b main</span>

<span class="c-com"># Verificar que se cre贸 el repositorio</span>
<span class="c-linux">$ ls -la .git/</span>
<span class="c-linux">$ git status</span>

<span class="c-com"># Configuraci贸n inicial recomendada</span>
<span class="c-linux">$ git config user.name "Tu Nombre"</span>
<span class="c-linux">$ git config user.email "tu@email.com"</span>
<span class="c-linux">$ git config core.editor "nano"  # o "vim", "code --wait", etc.</span>
<span class="c-linux">$ git config --list</span>`;
                    } else if (command === 'git add') {
                        return `<span class="c-com"># AADIR ARCHIVOS AL STAGING AREA</span>
<span class="c-com"># El staging area es el 谩rea de preparaci贸n donde se colocan los cambios</span>
<span class="c-com"># antes de hacer commit. Permite seleccionar qu茅 cambios incluir en el pr贸ximo commit.</span>

<span class="c-com"># A帽adir archivos espec铆ficos</span>
<span class="c-linux">$ git add archivo.txt</span>        <span class="c-com"># A帽ade un archivo espec铆fico</span>
<span class="c-linux">$ git add *.py</span>                <span class="c-com"># A帽ade todos los archivos .py</span>
<span class="c-linux">$ git add src/</span>                <span class="c-com"># A帽ade todo el directorio src/</span>

<span class="c-com"># A帽adir todos los archivos</span>
<span class="c-linux">$ git add .</span>                   <span class="c-com"># A帽ade todos los archivos en el directorio actual</span>
<span class="c-linux">$ git add -A</span>                  <span class="c-com"># A帽ade todos los archivos (incluyendo eliminados)</span>

<span class="c-com"># Modo interactivo (muy 煤til)</span>
<span class="c-linux">$ git add -p</span>                  <span class="c-com"># A帽ade cambios de forma interactiva</span>
<span class="c-com"># Muestra cada cambio (hunk) y pregunta si a帽adirlo</span>
<span class="c-com"># Opciones: y (s铆), n (no), s (split), e (edit), q (quit), etc.</span>

<span class="c-com"># A帽adir solo archivos modificados (no nuevos)</span>
<span class="c-linux">$ git add -u</span>

<span class="c-com"># Ver estado de los archivos</span>
<span class="c-linux">$ git status</span>
<span class="c-com"># Archivos en rojo: sin trackear/modificados (working directory)</span>
<span class="c-com"># Archivos en verde: en staging listos para commit</span>

<span class="c-com"># Deshacer git add (quitar del staging)</span>
<span class="c-linux">$ git reset archivo.txt</span>       <span class="c-com"># Quita del staging pero mantiene cambios</span>
<span class="c-linux">$ git reset --hard</span>             <span class="c-com"># 隆CUIDADO! Elimina todos los cambios</span>`;
                    } else if (command === 'git commit') {
                        return `<span class="c-com"># CREAR UN NUEVO COMMIT</span>
<span class="c-com"># Un commit es una instant谩nea del proyecto en un momento dado</span>
<span class="c-com"># Cada commit tiene un hash 煤nico (SHA-1) que lo identifica</span>

<span class="c-com"># Commit b谩sico con mensaje</span>
<span class="c-linux">$ git commit -m "Mensaje descriptivo del cambio"</span>

<span class="c-com"># Commit abriendo editor para mensaje m谩s largo</span>
<span class="c-linux">$ git commit</span>                   <span class="c-com"># Abre el editor configurado (nano, vim, etc.)</span>

<span class="c-com"># Buenas pr谩cticas para mensajes de commit (Conventional Commits):</span>
<span class="c-com"># Formato: tipo(alcance): descripci贸n</span>
<span class="c-com"># Tipos comunes:</span>
<span class="c-com">#   - feat: Nueva funcionalidad</span>
<span class="c-com">#   - fix: Correcci贸n de error</span>
<span class="c-com">#   - docs: Cambios en documentaci贸n</span>
<span class="c-com">#   - style: Cambios de formato (sin afectar c贸digo)</span>
<span class="c-com">#   - refactor: Refactorizaci贸n de c贸digo</span>
<span class="c-com">#   - test: A帽adir o corregir tests</span>
<span class="c-com">#   - chore: Tareas de mantenimiento</span>

<span class="c-com"># Ejemplos de buenos mensajes:</span>
<span class="c-linux">$ git commit -m "feat(pipeline): a帽adir an谩lisis de calidad FASTQ"</span>
<span class="c-linux">$ git commit -m "fix(alignment): corregir error en alineamiento BWA"</span>
<span class="c-linux">$ git commit -m "docs(readme): actualizar instrucciones de instalaci贸n"</span>

<span class="c-com"># Commit incluyendo todos los archivos modificados (sin git add)</span>
<span class="c-linux">$ git commit -a -m "Mensaje"</span>   <span class="c-com"># Equivalente a git add -u + git commit</span>

<span class="c-com"># Corregir el 煤ltimo commit (antes de hacer push)</span>
<span class="c-linux">$ git commit --amend</span>           <span class="c-com"># Edita el mensaje del 煤ltimo commit</span>
<span class="c-linux">$ git commit --amend --no-edit</span> <span class="c-com"># A帽ade cambios al 煤ltimo commit sin cambiar mensaje</span>

<span class="c-com"># Ver historial de commits</span>
<span class="c-linux">$ git log --oneline</span>            <span class="c-com"># Muestra commits en una l铆nea</span>
<span class="c-linux">$ git log --graph --oneline --all</span>  <span class="c-com"># Muestra gr谩fico de ramas</span>`;
                    } else if (command === 'git branch') {
                        return `<span class="c-com"># TRABAJAR CON RAMAS (BRANCHES)</span>
<span class="c-com"># Las ramas permiten desarrollar funcionalidades de forma aislada</span>

<span class="c-com"># Listar ramas</span>
<span class="c-linux">$ git branch</span>                   <span class="c-com"># Lista ramas locales (* indica la actual)</span>
<span class="c-linux">$ git branch -r</span>                 <span class="c-com"># Lista ramas remotas</span>
<span class="c-linux">$ git branch -a</span>                 <span class="c-com"># Lista todas las ramas (locales y remotas)</span>
<span class="c-linux">$ git branch -v</span>                 <span class="c-com"># Lista con 煤ltimo commit de cada rama</span>

<span class="c-com"># Crear nueva rama</span>
<span class="c-linux">$ git branch nueva-rama</span>        <span class="c-com"># Crea rama pero no cambia a ella</span>

<span class="c-com"># Cambiar de rama</span>
<span class="c-linux">$ git checkout nueva-rama</span>     <span class="c-com"># Cambia a la nueva rama</span>

<span class="c-com"># Crear y cambiar a rama en un solo comando</span>
<span class="c-linux">$ git checkout -b feature/analisis</span>

<span class="c-com"># Convenciones de nombres para ramas:</span>
<span class="c-com"># - main/master: Rama principal estable</span>
<span class="c-com"># - develop: Desarrollo activo (Git Flow)</span>
<span class="c-com"># - feature/*: Nueva funcionalidad</span>
<span class="c-com"># - bugfix/*: Correcci贸n de errores</span>
<span class="c-com"># - release/*: Preparaci贸n para lanzamiento</span>
<span class="c-com"># - hotfix/*: Correcci贸n urgente en producci贸n</span>

<span class="c-com"># Ejemplos en bioinform谩tica:</span>
<span class="c-linux">$ git checkout -b feature/bwa-pipeline</span>
<span class="c-linux">$ git checkout -b bugfix/fastq-quality</span>
<span class="c-linux">$ git checkout -b experiment/new-algorithm</span>

<span class="c-com"># Renombrar rama actual</span>
<span class="c-linux">$ git branch -m nuevo-nombre</span>

<span class="c-com"># Eliminar rama</span>
<span class="c-linux">$ git branch -d rama-vieja</span>     <span class="c-com"># Elimina si est谩 fusionada</span>
<span class="c-linux">$ git branch -D rama-vieja</span>     <span class="c-com"># Elimina forzadamente (隆CUIDADO!)</span>

<span class="c-com"># Ver diferencias entre ramas</span>
<span class="c-linux">$ git diff main..feature/analisis</span>  <span class="c-com"># Compara main con feature/analisis</span>`;
                    } else if (command === 'git merge') {
                        return `<span class="c-com"># FUSIONAR RAMAS (MERGE)</span>
<span class="c-com"># Combina los cambios de una rama en otra</span>

<span class="c-com"># Fusionar rama feature en main</span>
<span class="c-linux">$ git checkout main</span>            <span class="c-com"># Primero cambiar a la rama destino</span>
<span class="c-linux">$ git merge feature/analisis</span>   <span class="c-com"># Fusionar feature/analisis en main</span>

<span class="c-com"># Tipos de merge:</span>
<span class="c-com"># 1. Fast-forward: Cuando no hay nuevos commits en la rama destino</span>
<span class="c-com"># 2. 3-way merge: Cuando ambas ramas tienen nuevos commits</span>
<span class="c-com"># 3. Merge con conflicto: Cuando Git no puede fusionar autom谩ticamente</span>

<span class="c-com"># Forzar merge no fast-forward (siempre crea commit de merge)</span>
<span class="c-linux">$ git merge --no-ff feature/analisis</span>

<span class="c-com"># Resolver conflictos de merge:</span>
<span class="c-com"># 1. Git marcar谩 los archivos con conflictos</span>
<span class="c-com"># 2. Editar los archivos para resolver los conflictos</span>
<span class="c-com"># 3. A帽adir los archivos resueltos al staging</span>
<span class="c-com"># 4. Completar el merge</span>

<span class="c-linux">$ git status</span>                    <span class="c-com"># Ver archivos con conflictos</span>
<span class="c-linux">$ git mergetool</span>                 <span class="c-com"># Usar herramienta visual para resolver</span>
<span class="c-linux">$ git add archivo_resuelto.txt</span>  <span class="c-com"># Marcar como resuelto</span>
<span class="c-linux">$ git merge --continue</span>          <span class="c-com"># Continuar con el merge</span>

<span class="c-com"># Abortar un merge en progreso</span>
<span class="c-linux">$ git merge --abort</span>

<span class="c-com"># Ver historial de merge</span>
<span class="c-linux">$ git log --merges</span>              <span class="c-com"># Solo commits de merge</span>
<span class="c-linux">$ git log --oneline --graph --all</span>  <span class="c-com"># Ver gr谩fico con merges</span>`;
                    }
                    
                    // Agregar m谩s comandos si es necesario
                    return `<span class="c-com"># Comando: ${command}</span>
<span class="c-com"># Ejemplo de uso...</span>`;
                },
                explain: (p) => {
                    const command = p.git_command;
                    
                    const commandExplanations = {
                        'git init': {
                            title: "Inicializar Repositorio",
                            details: "Crea un nuevo repositorio Git vac铆o o reinicializa uno existente.",
                            useCases: [
                                "Iniciar un nuevo proyecto de bioinform谩tica",
                                "Convertir un proyecto existente en repositorio Git",
                                "Clonar un repositorio y comenzar a trabajar"
                            ],
                            tips: [
                                "Usa <code>git init -b main</code> para usar 'main' en lugar de 'master'",
                                "Configura tu nombre y email inmediatamente despu茅s",
                                "Considera agregar un <code>.gitignore</code> desde el principio"
                            ]
                        },
                        'git add': {
                            title: "A帽adir al Staging Area",
                            details: "A帽ade cambios del working directory al staging area para el pr贸ximo commit.",
                            useCases: [
                                "Preparar archivos espec铆ficos para commit",
                                "Revisar cambios antes de commit con <code>git add -p</code>",
                                "Separar cambios relacionados en commits diferentes"
                            ],
                            tips: [
                                "Usa <code>git add -p</code> para revisar cada cambio antes de a帽adirlo",
                                "No uses <code>git add .</code> sin revisar qu茅 est谩s a帽adiendo",
                                "El staging area te permite crear commits at贸micos y bien documentados"
                            ]
                        },
                        'git commit': {
                            title: "Crear Commit",
                            details: "Crea un commit con los cambios actualmente en el staging area.",
                            useCases: [
                                "Guardar un conjunto l贸gico de cambios",
                                "Documentar el progreso del proyecto",
                                "Crear puntos de restauraci贸n seguros"
                            ],
                            tips: [
                                "Usa mensajes descriptivos y en presente",
                                "Sigue la convenci贸n Conventional Commits",
                                "Haz commits frecuentes y peque帽os en lugar de pocos y grandes"
                            ]
                        },
                        'git branch': {
                            title: "Gesti贸n de Ramas",
                            details: "Crea, lista o elimina ramas de desarrollo.",
                            useCases: [
                                "Desarrollar nuevas funcionalidades de forma aislada",
                                "Corregir bugs sin afectar la rama principal",
                                "Experimentar con diferentes enfoques"
                            ],
                            tips: [
                                "Usa nombres descriptivos para las ramas",
                                "Mant茅n las ramas de corta duraci贸n",
                                "Sincroniza las ramas con frecuencia"
                            ]
                        },
                        'git merge': {
                            title: "Fusionar Ramas",
                            details: "Combina los cambios de diferentes ramas.",
                            useCases: [
                                "Incorporar funcionalidades completadas a la rama principal",
                                "Sincronizar ramas de desarrollo",
                                "Resolver conflictos entre versiones diferentes"
                            ],
                            tips: [
                                "Siempre haz merge desde la rama destino",
                                "Revisa los cambios antes de hacer merge",
                                "Usa <code>--no-ff</code> para preservar historial en merges importantes"
                            ]
                        }
                    };
                    
                    const explanation = commandExplanations[command] || {
                        title: command,
                        details: "Comando de Git para control de versiones.",
                        useCases: ["Uso general en proyectos de bioinform谩tica"],
                        tips: ["Consulta la documentaci贸n oficial para m谩s detalles"]
                    };
                    
                    return `
                    <div class="exp-highlight">
                        <b> Control de Versiones con Git: ${explanation.title}</b>
                        <p>${explanation.details}</p>
                    </div>
                    
                    <p><b>Casos de uso en bioinform谩tica:</b></p>
                    <ul>
                        ${explanation.useCases.map(useCase => `<li>${useCase}</li>`).join('')}
                    </ul>
                    
                    <p><b>Conceptos clave relacionados:</b></p>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 15px 0;">
                        <div style="background: rgba(76, 175, 80, 0.1); padding: 8px; border-radius: 4px;">
                            <b>Working Directory</b><br>
                            <small>Archivos actuales en tu sistema</small>
                        </div>
                        <div style="background: rgba(52, 152, 219, 0.1); padding: 8px; border-radius: 4px;">
                            <b>Staging Area</b><br>
                            <small>Cambios preparados para commit</small>
                        </div>
                        <div style="background: rgba(231, 76, 60, 0.1); padding: 8px; border-radius: 4px;">
                            <b>Repository</b><br>
                            <small>Historial completo de commits</small>
                        </div>
                        <div style="background: rgba(155, 89, 182, 0.1); padding: 8px; border-radius: 4px;">
                            <b>HEAD</b><br>
                            <small>Commit y rama actual</small>
                        </div>
                    </div>
                    
                    <div class="exp-note">
                        <i class="fas fa-lightbulb"></i> <b>Buenas pr谩cticas:</b>
                        <ul style="margin-top: 5px;">
                            ${explanation.tips.map(tip => `<li>${tip}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div style="background: rgba(33, 150, 243, 0.1); padding: 12px; border-radius: 6px; margin-top: 15px; border-left: 3px solid #2196F3;">
                        <b><i class="fas fa-users"></i> Flujo de trabajo colaborativo:</b>
                        <p style="margin: 8px 0 0 0; font-size: 0.9rem;">
                         Feature Branch Workflow: Rama por funcionalidad<br>
                         Git Flow: Ramas para desarrollo, release y hotfix<br>
                         GitHub Flow: Rama main siempre desplegable + PRs<br>
                         Trunk Based Development: Commits directos a main con feature flags
                        </p>
                    </div>`;
                },
                render: (p, div) => {
                    div.style.cssText = "width:100%; height:100%; position:relative; overflow:hidden; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);";
                    div.innerHTML = '';
                    
                    const command = p.git_command;
                    const branchCount = p.branch_count;
                    const animSpeed = 11 - p.animation_speed; // Invertir para que mayor valor = m谩s lento
                    
                    // Crear gr谩fico de Git interactivo
                    const gitGraph = document.createElement('div');
                    gitGraph.style.cssText = "width:100%; height:100%; position:relative;";
                    
                    // Rama principal (main)
                    const mainBranch = document.createElement('div');
                    mainBranch.className = 'git-branch';
                    mainBranch.style.cssText = `
                        position:absolute; 
                        top:50px; 
                        left:100px; 
                        background:#f1502f40; 
                        border:2px solid var(--git-orange);
                        padding: 5px 15px;
                        border-radius: 15px;
                        font-weight: bold;
                        font-size: 0.85rem;
                        box-shadow: 0 0 15px rgba(241, 80, 47, 0.3);
                        z-index: 100;
                        transition: all 0.3s ease;
                    `;
                    mainBranch.textContent = "main";
                    gitGraph.appendChild(mainBranch);
                    
                    // Nodos de commit en main - m谩s commits para mejor visualizaci贸n
                    const commitsMain = [
                        {id: "a1b2c3d", msg: "Init project", x: 120, y: 120, type: "initial"},
                        {id: "e5f6g7h", msg: "Add pipeline", x: 120, y: 190, type: "feature"},
                        {id: "i8j9k0l", msg: "Fix QC bug", x: 120, y: 260, type: "bugfix"},
                        {id: "m1n2o3p", msg: "Update docs", x: 120, y: 330, type: "docs"}
                    ];
                    
                    // Crear l铆neas primero (para que queden detr谩s de los nodos)
                    commitsMain.forEach((commit, i) => {
                        if (i < commitsMain.length - 1) {
                            const line = document.createElement('div');
                            line.style.cssText = `
                                position:absolute; 
                                left:${commit.x + 50}px; 
                                top:${commit.y + 30}px; 
                                width:2px; 
                                height:${commitsMain[i+1].y - commit.y - 30}px; 
                                background:linear-gradient(to bottom, var(--git-orange), #ff8c66);
                                z-index:1;
                                animation: pulseLine ${animSpeed}s infinite alternate;
                            `;
                            gitGraph.appendChild(line);
                            
                            // A帽adir c铆rculo de conexi贸n
                            const connector = document.createElement('div');
                            connector.style.cssText = `
                                position:absolute;
                                left:${commit.x + 49}px;
                                top:${commit.y + 29}px;
                                width:4px;
                                height:4px;
                                background:white;
                                border-radius:50%;
                                border:2px solid var(--git-orange);
                                z-index:3;
                            `;
                            gitGraph.appendChild(connector);
                        }
                    });
                    
                    // Ahora crear los nodos de commit
                    commitsMain.forEach(commit => {
                        const node = document.createElement('div');
                        node.className = 'git-node';
                        node.style.cssText = `
                            position:absolute; 
                            left:${commit.x}px; 
                            top:${commit.y}px; 
                            background:white;
                            border: 3px solid ${commit.type === 'initial' ? '#2ecc71' : 
                                            commit.type === 'feature' ? '#3498db' : 
                                            commit.type === 'bugfix' ? '#e74c3c' : '#f39c12'};
                            animation: nodePulse ${animSpeed * 1.5}s infinite alternate;
                            cursor: pointer;
                            transition: transform 0.3s ease;
                        `;
                        node.innerHTML = `
                            <div class="git-commit" style="color:${commit.type === 'initial' ? '#2ecc71' : 
                                                            commit.type === 'feature' ? '#3498db' : 
                                                            commit.type === 'bugfix' ? '#e74c3c' : '#f39c12'}; 
                                                          font-size: 0.75rem; font-weight: bold;">
                                ${commit.msg}
                            </div>
                            <div class="git-hash" style="font-size: 0.65rem; color: #777; margin-top: 3px;">
                                ${commit.id}
                            </div>
                            <div style="position: absolute; top: -20px; left: 0; right: 0; text-align: center; 
                                 font-size: 0.6rem; color: #aaa;">
                                ${commit.type}
                            </div>
                        `;
                        
                        // A帽adir efecto hover
                        node.onmouseenter = () => {
                            node.style.transform = 'scale(1.1) translateY(-5px)';
                            node.style.boxShadow = '0 10px 20px rgba(0,0,0,0.2)';
                            node.style.zIndex = '10';
                        };
                        node.onmouseleave = () => {
                            node.style.transform = 'scale(1)';
                            node.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
                            node.style.zIndex = '2';
                        };
                        
                        gitGraph.appendChild(node);
                    });
                    
                    // Crear ramas adicionales seg煤n el control deslizante
                    const branchNames = [
                        "feature/bwa-pipeline", 
                        "bugfix/fastq-quality", 
                        "experiment/new-algo", 
                        "docs/update", 
                        "hotfix/critical", 
                        "feature/variant-caller",
                        "refactor/cleanup"
                    ];
                    
                    const branchColors = ["#3498db", "#e74c3c", "#9b59b6", "#f39c12", "#e67e22", "#1abc9c", "#34495e"];
                    
                    for (let i = 0; i < branchCount; i++) {
                        const branchY = 100 + i * 70;
                        const branchX = 250 + i * 40;
                        const branchColor = branchColors[i % branchColors.length];
                        
                        // Rama
                        const branch = document.createElement('div');
                        branch.className = 'git-branch';
                        branch.style.cssText = `
                            position:absolute; 
                            top:${branchY}px; 
                            left:${branchX}px; 
                            background:${branchColor}30;
                            border: 2px solid ${branchColor};
                            padding: 4px 12px;
                            border-radius: 12px;
                            font-size: 0.75rem;
                            font-weight: bold;
                            color: white;
                            box-shadow: 0 0 10px ${branchColor}40;
                            z-index: 5;
                            animation: branchFloat ${3 + i * 0.5}s infinite alternate ease-in-out;
                        `;
                        branch.textContent = branchNames[i] || `branch-${i+1}`;
                        gitGraph.appendChild(branch);
                        
                        // Commit en rama
                        const commitNode = document.createElement('div');
                        commitNode.className = 'git-node';
                        commitNode.style.cssText = `
                            position:absolute; 
                            left:${branchX + 40}px; 
                            top:${branchY + 50}px;
                            background: white;
                            border: 3px solid ${branchColor};
                            animation: nodePulse ${animSpeed * (1 + i * 0.2)}s infinite alternate ${i * 0.3}s;
                            opacity: ${0.7 + i * 0.05};
                        `;
                        
                        const commitMsg = branchNames[i].split('/')[1] || `feature ${i+1}`;
                        commitNode.innerHTML = `
                            <div class="git-commit" style="color:${branchColor}; font-size: 0.7rem; font-weight: bold;">
                                ${commitMsg}
                            </div>
                            <div class="git-hash" style="font-size: 0.6rem; color: #777;">
                                ${Math.random().toString(16).substr(2, 7)}
                            </div>
                        `;
                        gitGraph.appendChild(commitNode);
                        
                        // L铆nea desde main (con animaci贸n de flujo)
                        const branchLine = document.createElement('div');
                        branchLine.style.cssText = `
                            position:absolute; 
                            left:170px; 
                            top:${branchY + 15}px; 
                            width:${branchX - 170}px; 
                            height:2px; 
                            background: linear-gradient(90deg, ${branchColor}, ${branchColor}80);
                            z-index: 1;
                        `;
                        gitGraph.appendChild(branchLine);
                        
                        // Animaci贸n de flujo en la l铆nea
                        const flowDot = document.createElement('div');
                        flowDot.style.cssText = `
                            position:absolute; 
                            left:170px; 
                            top:${branchY + 13}px; 
                            width:6px; 
                            height:6px; 
                            background:${branchColor};
                            border-radius:50%;
                            z-index:2;
                            animation: flowAnimation ${animSpeed * 0.5}s linear infinite ${i * 0.2}s;
                        `;
                        gitGraph.appendChild(flowDot);
                        
                        // Flecha de ramificaci贸n
                        const arrow = document.createElement('div');
                        arrow.style.cssText = `
                            position:absolute; 
                            left:${branchX - 10}px; 
                            top:${branchY + 10}px; 
                            color:${branchColor};
                            font-size:12px;
                            z-index:3;
                            animation: pulse ${animSpeed}s infinite alternate;
                        `;
                        arrow.innerHTML = '<i class="fas fa-code-branch"></i>';
                        gitGraph.appendChild(arrow);
                        
                        // L铆nea vertical desde el commit de la rama
                        if (i < branchCount - 1) {
                            const verticalLine = document.createElement('div');
                            verticalLine.style.cssText = `
                                position:absolute;
                                left:${branchX + 90}px;
                                top:${branchY + 80}px;
                                width:2px;
                                height:${70}px;
                                background:${branchColor}60;
                                z-index:1;
                            `;
                            gitGraph.appendChild(verticalLine);
                        }
                    }
                    
                    // A帽adir animaciones CSS
                    const style = document.createElement('style');
                    style.textContent = `
                        @keyframes pulseLine {
                            0% { opacity: 0.5; }
                            100% { opacity: 1; }
                        }
                        
                        @keyframes nodePulse {
                            0% { transform: translateY(0); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
                            100% { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0,0,0,0.2); }
                        }
                        
                        @keyframes branchFloat {
                            0% { transform: translateX(0); }
                            100% { transform: translateX(5px); }
                        }
                        
                        @keyframes flowAnimation {
                            0% { left: 170px; opacity: 0; }
                            10% { opacity: 1; }
                            90% { opacity: 1; }
                            100% { left: ${250 + (branchCount - 1) * 40}px; opacity: 0; }
                        }
                        
                        @keyframes pulse {
                            0% { transform: scale(1); }
                            100% { transform: scale(1.2); }
                        }
                    `;
                    gitGraph.appendChild(style);
                    
                    // Panel de informaci贸n
                    const infoPanel = document.createElement('div');
                    infoPanel.style.cssText = `
                        position: absolute;
                        bottom: 20px;
                        right: 20px;
                        background: rgba(0, 0, 0, 0.85);
                        color: white;
                        padding: 15px;
                        border-radius: 10px;
                        width: 300px;
                        font-size: 0.8rem;
                        border-left: 4px solid var(--git-orange);
                        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                        backdrop-filter: blur(5px);
                        z-index: 1000;
                    `;
                    
                    infoPanel.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <i class="fas fa-code-branch" style="color: var(--git-orange); font-size: 1.2rem;"></i>
                            <div style="font-weight: bold; font-size: 1rem;">Git Visualization</div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div>
                                <div style="color: #aaa; font-size: 0.7rem;">Ramas activas</div>
                                <div style="font-weight: bold; color: #4CAF50;">${branchCount}</div>
                            </div>
                            <div>
                                <div style="color: #aaa; font-size: 0.7rem;">Commits totales</div>
                                <div style="font-weight: bold; color: #3498db;">${commitsMain.length + branchCount}</div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <div style="color: #aaa; font-size: 0.7rem;">Comando actual</div>
                            <div style="font-weight: bold; color: white; background: rgba(241, 80, 47, 0.2); 
                                 padding: 5px 10px; border-radius: 4px; margin-top: 5px; display: inline-block;">
                                ${command}
                            </div>
                        </div>
                        
                        <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">
                            <div style="display: flex; align-items: center; gap: 8px; color: #aaa; font-size: 0.7rem;">
                                <i class="fas fa-info-circle"></i>
                                <span>Los puntos animados muestran el flujo de cambios entre ramas</span>
                            </div>
                        </div>
                    `;
                    
                    gitGraph.appendChild(infoPanel);
                    
                    // Leyenda de colores
                    const legend = document.createElement('div');
                    legend.style.cssText = `
                        position: absolute;
                        bottom: 20px;
                        left: 20px;
                        background: rgba(0, 0, 0, 0.85);
                        color: white;
                        padding: 15px;
                        border-radius: 10px;
                        width: 200px;
                        font-size: 0.75rem;
                        border-left: 4px solid #3498db;
                        backdrop-filter: blur(5px);
                        z-index: 1000;
                    `;
                    
                    legend.innerHTML = `
                        <div style="font-weight: bold; margin-bottom: 10px; color: #3498db;">Leyenda</div>
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                            <div style="width: 12px; height: 12px; background: #2ecc71; border-radius: 2px;"></div>
                            <span>Commit inicial</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                            <div style="width: 12px; height: 12px; background: #3498db; border-radius: 2px;"></div>
                            <span>Nueva funcionalidad</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                            <div style="width: 12px; height: 12px; background: #e74c3c; border-radius: 2px;"></div>
                            <span>Correcci贸n de bug</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 12px; height: 12px; background: #f39c12; border-radius: 2px;"></div>
                            <span>Documentaci贸n</span>
                        </div>
                    `;
                    
                    gitGraph.appendChild(legend);
                    
                    div.appendChild(gitGraph);
                    
                    // Simular animaci贸n de flujo de trabajo si el comando es 'git merge'
                    if (command === 'git merge') {
                        setTimeout(() => {
                            // Crear efecto de merge
                            const mergeEffect = document.createElement('div');
                            mergeEffect.style.cssText = `
                                position: absolute;
                                top: 200px;
                                left: 200px;
                                width: 100px;
                                height: 100px;
                                border-radius: 50%;
                                background: radial-gradient(circle, rgba(241, 80, 47, 0.3) 0%, rgba(241, 80, 47, 0) 70%);
                                animation: mergePulse 2s ease-out;
                                z-index: 5;
                            `;
                            
                            const mergeStyle = document.createElement('style');
                            mergeStyle.textContent = `
                                @keyframes mergePulse {
                                    0% { transform: scale(0.5); opacity: 1; }
                                    100% { transform: scale(2); opacity: 0; }
                                }
                            `;
                            
                            gitGraph.appendChild(mergeStyle);
                            gitGraph.appendChild(mergeEffect);
                            
                            // Eliminar despu茅s de la animaci贸n
                            setTimeout(() => {
                                if (mergeEffect.parentNode) {
                                    mergeEffect.parentNode.removeChild(mergeEffect);
                                }
                            }, 2000);
                        }, 1000);
                    }
                }
            },
            {
                id: 3,
                title: "Tema 3. Prog. Cient铆fica I (Lenguajes)",
                desc: "Python, R, Perl, Bash - Comparativa y uso",
                icon: "fa-laptop-code",
                controls: [
                    {id: 'language', type: 'select', label: 'Lenguaje', options: ['Python', 'R', 'Perl', 'Bash']},
                    {id: 'task', type: 'select', label: 'Tarea', options: ['An谩lisis de Datos', 'Manipulaci贸n Texto', 'Automatizaci贸n', 'Visualizaci贸n']}
                ],
                code: (p) => {
                    const lang = p.language;
                    const task = p.task;
                    
                    if (lang === 'Python') {
                        return `<span class="c-com"># ${task} en Python</span>
<span class="c-kwd">import</span> pandas <span class="c-kwd">as</span> pd
<span class="c-kwd">import</span> numpy <span class="c-kwd">as</span> np
<span class="c-kwd">import</span> matplotlib.pyplot <span class="c-kwd">as</span> plt

<span class="c-com"># Leer datos de expresi贸n g茅nica</span>
<span class="c-var">data</span> = pd.<span class="c-fn">read_csv</span>(<span class="c-str">"expression_data.csv"</span>)

<span class="c-com"># Calcular estad铆sticas b谩sicas</span>
<span class="c-var">mean_expression</span> = data.<span class="c-fn">mean</span>(<span class="c-arg">axis</span>=<span class="c-num">0</span>)
<span class="c-var">std_expression</span> = data.<span class="c-fn">std</span>(<span class="c-arg">axis</span>=<span class="c-num">0</span>)

<span class="c-com"># Filtrar genes altamente expresados</span>
<span class="c-var">high_expr</span> = data.<span class="c-fn">loc</span>[data.<span class="c-fn">mean</span>(<span class="c-arg">axis</span>=<span class="c-num">1</span>) > <span class="c-num">100</span>]

<span class="c-com"># Visualizar distribuci贸n</span>
plt.<span class="c-fn">figure</span>(<span class="c-arg">figsize</span>=(<span class="c-num">10</span>, <span class="c-num">6</span>))
plt.<span class="c-fn">hist</span>(data.<span class="c-fn">values</span>.<span class="c-fn">flatten</span>(), <span class="c-arg">bins</span>=<span class="c-num">50</span>, <span class="c-arg">alpha</span>=<span class="c-num">0.7</span>)
plt.<span class="c-fn">xlabel</span>(<span class="c-str">"Nivel de expresi贸n"</span>)
plt.<span class="c-fn">ylabel</span>(<span class="c-str">"Frecuencia"</span>)
plt.<span class="c-fn">title</span>(<span class="c-str">"Distribuci贸n de expresi贸n g茅nica"</span>)
plt.<span class="c-fn">show</span>()`;
                    } else if (lang === 'R') {
                        return `<span class="c-com"># ${task} en R</span>
<span class="c-kwd">library</span>(tidyverse)
<span class="c-kwd">library</span>(ggplot2)

<span class="c-com"># Leer datos de expresi贸n</span>
<span class="c-var">expression_data</span> <span class="c-op"><-</span> <span class="c-fn">read.csv</span>(<span class="c-str">"expression_data.csv"</span>, <span class="c-arg">row.names</span>=<span class="c-num">1</span>)

<span class="c-com"># Calcular valores medios por gen</span>
<span class="c-var">mean_by_gene</span> <span class="c-op"><-</span> <span class="c-fn">rowMeans</span>(<span class="c-var">expression_data</span>)

<span class="c-com"># Identificar genes diferencialmente expresados (ejemplo simple)</span>
<span class="c-var">de_genes</span> <span class="c-op"><-</span> <span class="c-fn">which</span>(<span class="c-var">mean_by_gene</span> <span class="c-op">></span> <span class="c-fn">quantile</span>(<span class="c-var">mean_by_gene</span>, <span class="c-num">0.9</span>))

<span class="c-com"># Crear gr谩fico de dispersi贸n</span>
<span class="c-fn">ggplot</span>(<span class="c-fn">data.frame</span>(<span class="c-arg">Expression</span> = <span class="c-var">mean_by_gene</span>), 
       <span class="c-fn">aes</span>(<span class="c-arg">x</span> = <span class="c-var">Expression</span>)) +
  <span class="c-fn">geom_histogram</span>(<span class="c-arg">bins</span> = <span class="c-num">30</span>, <span class="c-arg">fill</span> = <span class="c-str">"steelblue"</span>, <span class="c-arg">alpha</span> = <span class="c-num">0.7</span>) +
  <span class="c-fn">theme_minimal</span>() +
  <span class="c-fn">labs</span>(<span class="c-arg">title</span> = <span class="c-str">"Distribuci贸n de expresi贸n g茅nica"</span>,
       <span class="c-arg">x</span> = <span class="c-str">"Nivel de expresi贸n"</span>,
       <span class="c-arg">y</span> = <span class="c-str">"Frecuencia"</span>)`;
                    } else if (lang === 'Perl') {
                        return `<span class="c-com"># ${task} en Perl</span>
<span class="c-perl">#!/usr/bin/perl</span>
<span class="c-kwd">use</span> strict;
<span class="c-kwd">use</span> warnings;

<span class="c-com"># Leer archivo FASTQ y calcular calidad promedio</span>
<span class="c-kwd">my</span> <span class="c-var">$fastq_file</span> = <span class="c-str">"sample.fastq"</span>;
<span class="c-kwd">my</span> <span class="c-var">$total_quality</span> = <span class="c-num">0</span>;
<span class="c-kwd">my</span> <span class="c-var">$read_count</span> = <span class="c-num">0</span>;

<span class="c-kwd">open</span>(<span class="c-var">my</span> <span class="c-var">$fh</span>, <span class="c-str">"<"</span>, <span class="c-var">$fastq_file</span>) <span class="c-kwd">or</span> <span class="c-fn">die</span> <span class="c-str">"No se pudo abrir $fastq_file: $!"</span>;

<span class="c-kwd">while</span> (<span class="c-kwd">my</span> <span class="c-var">$header</span> = <span class="c-fn">readline</span>(<span class="c-var">$fh</span>)) {
    <span class="c-kwd">my</span> <span class="c-var">$sequence</span> = <span class="c-fn">readline</span>(<span class="c-var">$fh</span>);
    <span class="c-fn">readline</span>(<span class="c-var">$fh</span>);  <span class="c-com"># l铆nea del separador '+'</span>
    <span class="c-kwd">my</span> <span class="c-var">$quality</span> = <span class="c-fn">readline</span>(<span class="c-var">$fh</span>);
    
    <span class="c-com"># Calcular calidad promedio para esta lectura</span>
    <span class="c-kwd">my</span> <span class="c-var">$sum</span> = <span class="c-num">0</span>;
    <span class="c-kwd">for</span> <span class="c-kwd">my</span> <span class="c-var">$i</span> (<span class="c-num">0</span> .. <span class="c-fn">length</span>(<span class="c-var">$quality</span>)-<span class="c-num">1</span>) {
        <span class="c-var">$sum</span> += <span class="c-fn">ord</span>(<span class="c-fn">substr</span>(<span class="c-var">$quality</span>, <span class="c-var">$i</span>, <span class="c-num">1</span>)) - <span class="c-num">33</span>;  <span class="c-com"># Convertir Phred score</span>
    }
    
    <span class="c-var">$total_quality</span> += <span class="c-var">$sum</span> / <span class="c-fn">length</span>(<span class="c-var">$quality</span>);
    <span class="c-var">$read_count</span>++;
}

<span class="c-kwd">close</span>(<span class="c-var">$fh</span>);

<span class="c-kwd">my</span> <span class="c-var">$average_quality</span> = <span class="c-var">$total_quality</span> / <span class="c-var">$read_count</span>;
<span class="c-fn">print</span> <span class="c-str">"Calidad promedio: $average_quality\\n"</span>;
<span class="c-fn">print</span> <span class="c-str">"Total de lecturas: $read_count\\n"</span>;`;
                    } else { // Bash
                        return `<span class="c-com"># ${task} en Bash</span>
<span class="c-com">#!/bin/bash</span>

<span class="c-com"># Script para procesar m煤ltiples archivos FASTQ</span>
<span class="c-var">INPUT_DIR</span>=<span class="c-str">"data/raw"</span>
<span class="c-var">OUTPUT_DIR</span>=<span class="c-str">"data/processed"</span>
<span class="c-var">THREADS</span>=<span class="c-num">8</span>

<span class="c-com"># Crear directorio de salida si no existe</span>
<span class="c-fn">mkdir</span> -p <span class="c-str">"$OUTPUT_DIR"</span>

<span class="c-com"># Procesar cada archivo FASTQ en paralelo</span>
<span class="c-kwd">for</span> fastq_file <span class="c-kwd">in</span> <span class="c-str">"$INPUT_DIR"</span>/*.fastq.gz; <span class="c-kwd">do</span>
    <span class="c-com"># Extraer nombre base del archivo</span>
    <span class="c-var">basename</span>=<span class="c-str">"$(basename "$fastq_file" .fastq.gz)"</span>
    
    <span class="c-com"># Ejecutar control de calidad con FastQC</span>
    fastqc <span class="c-str">"$fastq_file"</span> -o <span class="c-str">"$OUTPUT_DIR/qc"</span> &
    
    <span class="c-com"># Recortar adaptadores con Trimmomatic</span>
    java -jar trimmomatic.jar SE \
        <span class="c-str">"$fastq_file"</span> \
        <span class="c-str">"$OUTPUT_DIR/$basename"_trimmed.fastq.gz</span> \
        ILLUMINACLIP:adapters.fa:2:30:10 \
        LEADING:3 TRAILING:3 \
        SLIDINGWINDOW:4:15 MINLEN:36 &
    
    <span class="c-com"># Limitar el n煤mero de trabajos paralelos</span>
    <span class="c-kwd">if</span> [[ <span class="c-str">$(jobs -r -p | wc -l)</span> -ge <span class="c-str">"$THREADS"</span> ]]; <span class="c-kwd">then</span>
        <span class="c-fn">wait</span> -n
    <span class="c-kwd">fi</span>
<span class="c-kwd">done</span>

<span class="c-com"># Esperar a que todos los trabajos terminen</span>
<span class="c-fn">wait</span>

<span class="c-com"># Generar reporte consolidado con MultiQC</span>
multiqc <span class="c-str">"$OUTPUT_DIR"</span> -o <span class="c-str">"$OUTPUT_DIR/reports"</span>

<span class="c-fn">echo</span> <span class="c-str">"Procesamiento completado. Resultados en $OUTPUT_DIR"</span>`;
                    }
                },
                explain: (p) => {
                    const lang = p.language;
                    const task = p.task;
                    
                    let langInfo = "";
                    if (lang === 'Python') {
                        langInfo = "Python es un lenguaje vers谩til con un ecosistema cient铆fico robusto (pandas, numpy, scikit-learn). Ideal para pipelines complejos y aprendizaje autom谩tico.";
                    } else if (lang === 'R') {
                        langInfo = "R es especializado en an谩lisis estad铆stico y visualizaci贸n. Tiene miles de paquetes bioinform谩ticos (Bioconductor). Excelente para an谩lisis exploratorio.";
                    } else if (lang === 'Perl') {
                        langInfo = "Perl fue hist贸ricamente dominante en bioinform谩tica por su poder en procesamiento de texto. A煤n se usa para scripts r谩pidos y pipelines heredados.";
                    } else {
                        langInfo = "Bash es el lenguaje del shell de Unix/Linux. Esencial para orquestar pipelines, manejar archivos y automatizar tareas del sistema.";
                    }
                    
                    return `
                    <div class="exp-highlight">
                        <b> Programaci贸n Cient铆fica: ${lang}</b>
                        <p>${langInfo}</p>
                    </div>
                    
                    <p><b>Tarea: ${task}</b></p>
                    
                    <p><b>Fortalezas de ${lang} para bioinform谩tica:</b></p>
                    <ul>
                        ${lang === 'Python' ? `
                        <li> Amplia comunidad y documentaci贸n</li>
                        <li>К Librer铆as especializadas: Biopython, PyVCF, scikit-bio</li>
                        <li> Visualizaci贸n: Matplotlib, Seaborn, Plotly</li>
                        <li> Aprendizaje autom谩tico: scikit-learn, TensorFlow</li>
                        ` : lang === 'R' ? `
                        <li> Estad铆sticas avanzadas integradas</li>
                        <li>И Bioconductor: 2000+ paquetes bioinform谩ticos</li>
                        <li> Visualizaci贸n profesional: ggplot2, lattice</li>
                        <li> Reportes reproducibles: RMarkdown, Shiny</li>
                        ` : lang === 'Perl' ? `
                        <li> Expresiones regulares poderosas</li>
                        <li> Procesamiento de texto eficiente</li>
                        <li>К BioPerl: m贸dulos para an谩lisis biol贸gico</li>
                        <li> R谩pido para scripts de una sola pasada</li>
                        ` : `
                        <li>ワ Nativo en todos los sistemas Unix/Linux</li>
                        <li> Ideal para orquestar pipelines</li>
                        <li> Manejo eficiente de archivos y directorios</li>
                        <li>锔 Control total del sistema operativo</li>
                        `}
                    </ul>
                    
                    <div class="exp-note">
                        <i class="fas fa-lightbulb"></i> <b>Recomendaci贸n:</b>
                        <p>La mayor铆a de los bioinform谩ticos usan m煤ltiples lenguajes:
                         Bash para automatizaci贸n del sistema<br>
                         Python/R para an谩lisis principales<br>
                         Perl para scripts de procesamiento de texto heredados</p>
                    </div>`;
                },
                render: (p, div) => {
                    div.style.cssText = "width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; box-sizing:border-box;";
                    div.innerHTML = '';
                    
                    const lang = p.language;
                    const task = p.task;
                    
                    // Crear gr谩fico comparativo
                    const chartContainer = document.createElement('div');
                    chartContainer.style.cssText = "width:90%; max-width:700px; background:white; border-radius:10px; padding:20px; box-shadow:0 5px 15px rgba(0,0,0,0.1);";
                    
                    const languages = ['Python', 'R', 'Perl', 'Bash'];
                    const metrics = {
                        'Facilidad aprendizaje': [85, 70, 60, 75],
                        'Comunidad bioinfo': [90, 95, 70, 80],
                        'Velocidad ejecuci贸n': [70, 60, 85, 90],
                        'Expresiones regulares': [75, 65, 95, 85]
                    };
                    
                    const taskKey = Object.keys(metrics)[languages.indexOf(lang) % 4];
                    
                    let chartHTML = `
                    <div style="text-align:center; margin-bottom:20px;">
                        <h3 style="color:#333;">Comparativa de Lenguajes para ${task}</h3>
                        <p style="color:#666; font-size:0.9rem;">${lang} destacado en <b>${taskKey}</b></p>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:flex-end; height:200px; padding:0 20px; border-bottom:1px solid #eee;">
                    `;
                    
                    languages.forEach((l, i) => {
                        const height = metrics[taskKey][i];
                        const color = l === lang ? 
                            (lang === 'Python' ? '#3498db' : 
                             lang === 'R' ? '#e74c3c' : 
                             lang === 'Perl' ? '#0073e6' : '#4CAF50') : '#ddd';
                        
                        chartHTML += `
                        <div style="text-align:center; width:22%;">
                            <div style="height:${height}px; background:${color}; border-radius:5px 5px 0 0; position:relative;">
                                <div style="position:absolute; top:-25px; width:100%; text-align:center; font-weight:bold; color:#333;">${metrics[taskKey][i]}%</div>
                            </div>
                            <div style="margin-top:10px; font-weight:bold; color:${l === lang ? '#333' : '#777'};">${l}</div>
                            ${l === lang ? '<div style="font-size:0.8rem; color:#4CAF50;"><i class="fas fa-star"></i> Seleccionado</div>' : ''}
                        </div>
                        `;
                    });
                    
                    chartHTML += `</div>`;
                    
                    // A帽adir leyenda
                    chartHTML += `
                    <div style="margin-top:20px; display:flex; justify-content:center; gap:15px; font-size:0.8rem;">
                        <div><span style="display:inline-block; width:12px; height:12px; background:#3498db; border-radius:2px;"></span> Python</div>
                        <div><span style="display:inline-block; width:12px; height:12px; background:#e74c3c; border-radius:2px;"></span> R</div>
                        <div><span style="display:inline-block; width:12px; height:12px; background:#0073e6; border-radius:2px;"></span> Perl</div>
                        <div><span style="display:inline-block; width:12px; height:12px; background:#4CAF50; border-radius:2px;"></span> Bash</div>
                    </div>
                    `;
                    
                    chartContainer.innerHTML = chartHTML;
                    div.appendChild(chartContainer);
                    
                    // A帽adir terminal de ejemplo
                    const terminal = document.createElement('div');
                    terminal.className = 'terminal';
                    terminal.style.cssText = "width:90%; max-width:700px; margin-top:20px;";
                    terminal.innerHTML = `
                    <div class="terminal-header">
                        <div class="terminal-title">Terminal - Ejecutando ${lang}</div>
                        <div class="terminal-buttons">
                            <div class="terminal-btn close"></div>
                            <div class="terminal-btn minimize"></div>
                            <div class="terminal-btn maximize"></div>
                        </div>
                    </div>
                    <div class="terminal-body">
                        <div class="terminal-line"><span class="terminal-prompt">$</span> ${lang === 'Python' ? 'python script.py' : 
                                                                          lang === 'R' ? 'Rscript analysis.R' : 
                                                                          lang === 'Perl' ? 'perl process.pl' : 'bash pipeline.sh'}</div>
                        <div class="terminal-line">Procesando ${task.toLowerCase()}...</div>
                        <div class="terminal-line">Leyendo datos de entrada...</div>
                        <div class="terminal-line">Aplicando transformaciones...</div>
                        <div class="terminal-line">Generando resultados...</div>
                        <div class="terminal-line"><span style="color:#4CAF50;"></span> ${task} completado exitosamente</div>
                        <div class="terminal-line"><span class="terminal-prompt">$</span> <span class="terminal-cursor">_</span></div>
                    </div>
                    `;
                    
                    div.appendChild(terminal);
                }
            },
            {
                id: 4,
                title: "Tema 4. Prog. Cient铆fica II (L贸gica)",
                desc: "Algoritmos, estructuras de datos y optimizaci贸n",
                icon: "fa-sitemap",
                controls: [
                    {id: 'algorithm', type: 'select', label: 'Algoritmo', options: ['B煤squeda Binaria', 'Ordenamiento', 'Programaci贸n Din谩mica', 'Divide y Vencer谩s']},
                    {id: 'data_size', type: 'range', label: 'Tama帽o de Datos', min: 10, max: 100, step: 10, val: 50}
                ],
                code: (p) => {
                    const algo = p.algorithm;
                    
                    if (algo === 'B煤squeda Binaria') {
                        return `<span class="c-com"># BSQUEDA BINARIA - O(log n)</span>
<span class="c-com"># Encuentra un elemento en una lista ORDENADA</span>

<span class="c-kwd">def</span> <span class="c-fn">binary_search</span>(<span class="c-arg">arr</span>, <span class="c-arg">target</span>):
    <span class="c-var">left</span>, <span class="c-var">right</span> = <span class="c-num">0</span>, <span class="c-fn">len</span>(<span class="c-var">arr</span>) - <span class="c-num">1</span>
    
    <span class="c-kwd">while</span> <span class="c-var">left</span> <= <span class="c-var">right</span>:
        <span class="c-var">mid</span> = <span class="c-var">left</span> + (right - left) // <span class="c-num">2</span>  <span class="c-com"># Evitar overflow</span>
        
        <span class="c-kwd">if</span> <span class="c-var">arr</span>[mid] == <span class="c-var">target</span>:
            <span class="c-kwd">return</span> <span class="c-var">mid</span>  <span class="c-com"># Elemento encontrado</span>
        <span class="c-kwd">elif</span> <span class="c-var">arr</span>[mid] < <span class="c-var">target</span>:
            <span class="c-var">left</span> = <span class="c-var">mid</span> + <span class="c-num">1</span>  <span class="c-com"># Buscar en la mitad derecha</span>
        <span class="c-kwd">else</span>:
            <span class="c-var">right</span> = <span class="c-var">mid</span> - <span class="c-num">1</span>  <span class="c-com"># Buscar en la mitad izquierda</span>
    
    <span class="c-kwd">return</span> -<span class="c-num">1</span>  <span class="c-com"># Elemento no encontrado</span>

<span class="c-com"># Ejemplo: buscar genes en una lista ordenada</span>
<span class="c-var">genes_sorted</span> = [<span class="c-str">"ABCA1"</span>, <span class="c-str">"BRCA1"</span>, <span class="c-str">"CFTR"</span>, <span class="c-str">"EGFR"</span>, <span class="c-str">"TP53"</span>]
<span class="c-var">target_gene</span> = <span class="c-str">"EGFR"</span>

<span class="c-var">result</span> = <span class="c-fn">binary_search</span>(<span class="c-var">genes_sorted</span>, <span class="c-var">target_gene</span>)
<span class="c-fn">print</span>(<span class="c-str">f"Gen </span>{<span class="c-var">target_gene</span>}<span class="c-str"> encontrado en 铆ndice: </span>{<span class="c-var">result</span>}<span class="c-str">"</span>)`;
                    } else if (algo === 'Ordenamiento') {
                        return `<span class="c-com"># ALGORITMO DE ORDENAMIENTO - Quicksort O(n log n)</span>
<span class="c-com"># Divide y vencer谩s: eficiente para grandes conjuntos</span>

<span class="c-kwd">def</span> <span class="c-fn">quicksort</span>(<span class="c-arg">arr</span>):
    <span class="c-kwd">if</span> <span class="c-fn">len</span>(<span class="c-var">arr</span>) <= <span class="c-num">1</span>:
        <span class="c-kwd">return</span> <span class="c-var">arr</span>
    
    <span class="c-com"># Elegir pivote (estrategia: elemento del medio)</span>
    <span class="c-var">pivot</span> = <span class="c-var">arr</span>[<span class="c-fn">len</span>(<span class="c-var">arr</span>) // <span class="c-num">2</span>]
    
    <span class="c-com"># Particionar</span>
    <span class="c-var">left</span> = [x <span class="c-kwd">for</span> x <span class="c-kwd">in</span> <span class="c-var">arr</span> <span class="c-kwd">if</span> x < <span class="c-var">pivot</span>]
    <span class="c-var">middle</span> = [x <span class="c-kwd">for</span> x <span class="c-kwd">in</span> <span class="c-var">arr</span> <span class="c-kwd">if</span> x == <span class="c-var">pivot</span>]
    <span class="c-var">right</span> = [x <span class="c-kwd">for</span> x <span class="c-kwd">in</span> <span class="c-var">arr</span> <span class="c-kwd">if</span> x > <span class="c-var">pivot</span>]
    
    <span class="c-com"># Ordenar recursivamente y combinar</span>
    <span class="c-kwd">return</span> <span class="c-fn">quicksort</span>(<span class="c-var">left</span>) + <span class="c-var">middle</span> + <span class="c-fn">quicksort</span>(<span class="c-var">right</span>)

<span class="c-com"># Ejemplo: ordenar valores de expresi贸n g茅nica</span>
<span class="c-var">expression_values</span> = [<span class="c-num">12.5</span>, <span class="c-num">8.3</span>, <span class="c-num">45.2</span>, <span class="c-num">3.7</span>, <span class="c-num">22.1</span>, <span class="c-num">15.8</span>]
<span class="c-var">sorted_values</span> = <span class="c-fn">quicksort</span>(<span class="c-var">expression_values</span>)

<span class="c-fn">print</span>(<span class="c-str">"Valores originales:"</span>, <span class="c-var">expression_values</span>)
<span class="c-fn">print</span>(<span class="c-str">"Valores ordenados:"</span>, <span class="c-var">sorted_values</span>)
<span class="c-fn">print</span>(<span class="c-str">"Mediana:"</span>, <span class="c-var">sorted_values</span>[<span class="c-fn">len</span>(<span class="c-var">sorted_values</span>)//<span class="c-num">2</span>])`;
                    }
                    
                    return code;
                },
                explain: (p) => {
                    const algo = p.algorithm;
                    const size = p.data_size;
                    
                    let algoInfo = "";
                    let complexity = "";
                    
                    if (algo === 'B煤squeda Binaria') {
                        algoInfo = "Divide repetidamente el espacio de b煤squeda a la mitad. Requiere que los datos est茅n ordenados.";
                        complexity = "O(log n) - Muy eficiente incluso para grandes conjuntos de datos.";
                    } else if (algo === 'Ordenamiento') {
                        algoInfo = "Reorganiza los elementos en orden ascendente o descendente. Quicksort es un algoritmo eficiente de 'divide y vencer谩s'.";
                        complexity = "O(n log n) en promedio - Eficiente para la mayor铆a de casos.";
                    } else if (algo === 'Programaci贸n Din谩mica') {
                        algoInfo = "Resuelve problemas complejos dividi茅ndolos en subproblemas m谩s simples y almacenando sus soluciones.";
                        complexity = "Var铆a - Generalmente O(n虏) o O(n鲁) dependiendo del problema.";
                    } else {
                        algoInfo = "Divide el problema en subproblemas m谩s peque帽os, los resuelve independientemente y combina las soluciones.";
                        complexity = "O(n log n) t铆picamente - Muy eficiente para problemas que pueden dividirse.";
                    }
                    
                    return `
                    <div class="exp-highlight">
                        <b>锔 Algoritmo: ${algo}</b>
                        <p>${algoInfo}</p>
                    </div>
                    
                    <p><b>Complejidad computacional:</b> ${complexity}</p>
                    
                    <p><b>Aplicaci贸n en bioinform谩tica:</b></p>
                    <ul>
                        ${algo === 'B煤squeda Binaria' ? `
                        <li> Buscar genes en bases de datos ordenadas</li>
                        <li>К B煤squeda de motivos en secuencias</li>
                        <li> Encontrar valores en matrices ordenadas</li>
                        ` : algo === 'Ordenamiento' ? `
                        <li> Ordenar genes por nivel de expresi贸n</li>
                        <li>И Ordenar prote铆nas por peso molecular</li>
                        <li> Preparar datos para visualizaci贸n</li>
                        ` : algo === 'Programaci贸n Din谩mica' ? `
                        <li>К Alineamiento de secuencias (Needleman-Wunsch)</li>
                        <li> B煤squeda de motivos comunes</li>
                        <li> Predicci贸n de estructura de prote铆nas</li>
                        ` : `
                        <li>К Algoritmos de ensamblaje de genomas</li>
                        <li> Construcci贸n de 谩rboles filogen茅ticos</li>
                        <li> B煤squeda en grandes conjuntos de datos</li>
                        `}
                    </ul>
                    
                    <div class="exp-note">
                        <i class="fas fa-chart-line"></i> <b>Rendimiento:</b>
                        <p>Con ${size} elementos:<br>
                         B煤squeda lineal: ~${size} operaciones<br>
                         B煤squeda binaria: ~${Math.ceil(Math.log2(size))} operaciones<br>
                         Ordenamiento 贸ptimo: ~${Math.ceil(size * Math.log2(size))} operaciones</p>
                    </div>`;
                },
                render: (p, div) => {
                    div.style.cssText = "width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; box-sizing:border-box;";
                    div.innerHTML = '';
                    
                    const algo = p.algorithm;
                    const size = p.data_size;
                    
                    // Crear visualizaci贸n del algoritmo
                    const algoViz = document.createElement('div');
                    algoViz.style.cssText = "width:90%; max-width:700px; background:white; border-radius:10px; padding:20px; box-shadow:0 5px 15px rgba(0,0,0,0.1);";
                    
                    if (algo === 'B煤squeda Binaria') {
                        // Visualizaci贸n de b煤squeda binaria
                        const numbers = Array.from({length: size}, (_, i) => i * 2 + 1); // N煤meros impares
                        const target = numbers[Math.floor(Math.random() * numbers.length)];
                        
                        let vizHTML = `
                        <div style="text-align:center; margin-bottom:20px;">
                            <h3 style="color:#333;">B煤squeda Binaria</h3>
                            <p style="color:#666;">Buscando: <b>${target}</b> en array de ${size} elementos</p>
                        </div>
                        <div style="display:flex; flex-wrap:wrap; gap:5px; justify-content:center; margin-bottom:20px;">
                        `;
                        
                        // Crear cajas para cada n煤mero
                        numbers.forEach((num, i) => {
                            const isTarget = num === target;
                            vizHTML += `
                            <div style="width:40px; height:40px; border:2px solid ${isTarget ? '#e74c3c' : '#3498db'}; 
                                 display:flex; align-items:center; justify-content:center; 
                                 background:${isTarget ? '#ffeaa7' : 'white'}; 
                                 font-weight:${isTarget ? 'bold' : 'normal'};">
                                ${num}
                            </div>
                            `;
                        });
                        
                        vizHTML += `</div>`;
                        
                        // Mostrar pasos del algoritmo
                        vizHTML += `
                        <div style="background:#f8f9fa; padding:15px; border-radius:5px; margin-top:20px;">
                            <h4 style="color:#333; margin-bottom:10px;">Pasos del algoritmo:</h4>
                            <ol style="color:#555; padding-left:20px;">
                                <li>Array ordenado de ${size} elementos</li>
                                <li>Comparar elemento central (铆ndice ${Math.floor(size/2)}) con ${target}</li>
                                <li>${target > numbers[Math.floor(size/2)] ? 'Target es mayor  buscar en mitad derecha' : 'Target es menor  buscar en mitad izquierda'}</li>
                                <li>Repetir hasta encontrar ${target}</li>
                                <li><b>Total de comparaciones: ${Math.ceil(Math.log2(size))} (O(log n))</b></li>
                            </ol>
                        </div>
                        `;
                        
                        algoViz.innerHTML = vizHTML;
                        
                    } else if (algo === 'Ordenamiento') {
                        // Visualizaci贸n de ordenamiento
                        const numbers = Array.from({length: size}, () => Math.floor(Math.random() * 100));
                        const sorted = [...numbers].sort((a, b) => a - b);
                        
                        let vizHTML = `
                        <div style="text-align:center; margin-bottom:20px;">
                            <h3 style="color:#333;">Algoritmo de Ordenamiento (Quicksort)</h3>
                            <p style="color:#666;">Ordenando ${size} valores aleatorios</p>
                        </div>
                        `;
                        
                        // Mostrar array original y ordenado
                        vizHTML += `
                        <div style="display:flex; justify-content:space-between; margin-bottom:30px;">
                            <div style="flex:1;">
                                <h4 style="color:#333;">Array Original</h4>
                                <div style="display:flex; flex-wrap:wrap; gap:3px; margin-top:10px;">
                        `;
                        
                        numbers.forEach(num => {
                            const height = (num / 100) * 50;
                            vizHTML += `
                            <div style="width:${80/size}px; height:${height}px; background:#3498db; 
                                 display:flex; align-items:flex-end; justify-content:center; 
                                 font-size:10px; color:white; padding-bottom:2px;">
                                ${num}
                            </div>
                            `;
                        });
                        
                        vizHTML += `
                                </div>
                            </div>
                            
                            <div style="flex:1; margin-left:20px;">
                                <h4 style="color:#333;">Array Ordenado</h4>
                                <div style="display:flex; flex-wrap:wrap; gap:3px; margin-top:10px;">
                        `;
                        
                        sorted.forEach(num => {
                            const height = (num / 100) * 50;
                            vizHTML += `
                            <div style="width:${80/size}px; height:${height}px; background:#2ecc71; 
                                 display:flex; align-items:flex-end; justify-content:center; 
                                 font-size:10px; color:white; padding-bottom:2px;">
                                ${num}
                            </div>
                            `;
                        });
                        
                        vizHTML += `
                                </div>
                            </div>
                        </div>
                        `;
                        
                        // Explicaci贸n del algoritmo
                        vizHTML += `
                        <div style="background:#f8f9fa; padding:15px; border-radius:5px;">
                            <h4 style="color:#333; margin-bottom:10px;">Proceso Quicksort:</h4>
                            <ol style="color:#555; padding-left:20px;">
                                <li>Elegir pivote (elemento central)</li>
                                <li>Particionar: elementos < pivote a izquierda, > pivote a derecha</li>
                                <li>Aplicar recursivamente a sub-arrays</li>
                                <li>Combinar resultados</li>
                                <li><b>Complejidad promedio: O(${size} log ${size})  ${Math.ceil(size * Math.log2(size))} operaciones</b></li>
                            </ol>
                        </div>
                        `;
                        
                        algoViz.innerHTML = vizHTML;
                    }
                    
                    div.appendChild(algoViz);
                }
            },
            {
                id: 5,
                title: "Tema 5. Sistemas Operativos",
                desc: "Arquitectura, procesos, memoria y sistemas de archivos",
                icon: "fa-desktop",
                controls: [
                    {id: 'os_component', type: 'select', label: 'Componente', options: ['Gesti贸n de Procesos', 'Gesti贸n de Memoria', 'Sistema de Archivos', 'Sistema de Entrada/Salida']},
                    {id: 'process_count', type: 'range', label: 'N煤mero de Procesos', min: 1, max: 10, step: 1, val: 5}
                ],
                code: (p) => {
                    const component = p.os_component;
                    
                    if (component === 'Gesti贸n de Procesos') {
                        return `<span class="c-com"># GESTIN DE PROCESOS EN LINUX</span>
<span class="c-com"># Comandos para monitorear y controlar procesos</span>

<span class="c-com"># 1. Ver procesos en ejecuci贸n</span>
<span class="c-linux">$ ps aux</span>                    <span class="c-com"># Ver todos los procesos</span>
<span class="c-linux">$ top</span>                       <span class="c-com"># Monitor interactivo</span>
<span class="c-linux">$ htop</span>                      <span class="c-com"># Versi贸n mejorada (instalar)</span>

<span class="c-com"># 2. Informaci贸n detallada de un proceso</span>
<span class="c-linux">$ ps -p [PID] -o pid,user,%cpu,%mem,cmd</span>

<span class="c-com"># 3. Matar procesos</span>
<span class="c-linux">$ kill [PID]</span>                 <span class="c-com"># Se帽al TERM (terminaci贸n suave)</span>
<span class="c-linux">$ kill -9 [PID]</span>              <span class="c-com"># Se帽al KILL (terminaci贸n forzosa)</span>
<span class="c-linux">$ pkill [nombre]</span>             <span class="c-com"># Matar por nombre</span>

<span class="c-com"># 4. Prioridades (nice values)</span>
<span class="c-linux">$ nice -n 10 ./script.sh</span>    <span class="c-com"># Ejecutar con baja prioridad</span>
<span class="c-linux">$ renice 5 [PID]</span>             <span class="c-com"># Cambiar prioridad de proceso existente</span>

<span class="c-com"># 5. Procesos en segundo plano</span>
<span class="c-linux">$ ./programa &</span>               <span class="c-com"># Ejecutar en background</span>
<span class="c-linux">$ jobs</span>                       <span class="c-com"># Listar trabajos en background</span>
<span class="c-linux">$ fg %1</span>                      <span class="c-com"># Traer trabajo 1 a foreground</span>
<span class="c-linux">$ bg %1</span>                      <span class="c-com"># Enviar trabajo 1 a background</span>

<span class="c-com"># 6. Monitoreo de recursos por proceso</span>
<span class="c-linux">$ pidstat -p [PID] 1</span>         <span class="c-com"># Estad铆sticas cada segundo</span>
<span class="c-linux">$ strace -p [PID]</span>            <span class="c-com"># Seguimiento de llamadas al sistema</span>`;
                    } else if (component === 'Gesti贸n de Memoria') {
                        return `<span class="c-com"># GESTIN DE MEMORIA EN LINUX</span>
<span class="c-com"># Comandos para monitorear uso de memoria</span>

<span class="c-com"># 1. Memoria del sistema</span>
<span class="c-linux">$ free -h</span>                    <span class="c-com"># Memoria total, usada, libre</span>
<span class="c-linux">$ cat /proc/meminfo</span>          <span class="c-com"># Informaci贸n detallada</span>

<span class="c-com"># 2. Memoria por proceso</span>
<span class="c-linux">$ ps aux --sort=-%mem | head -10</span>  <span class="c-com"># Top 10 procesos por uso de memoria</span>
<span class="c-linux">$ pmap [PID]</span>                  <span class="c-com"># Mapa de memoria del proceso</span>

<span class="c-com"># 3. Memoria de cach茅 y buffers</span>
<span class="c-linux">$ sync; echo 3 > /proc/sys/vm/drop_caches</span>  <span class="c-com"># Limpiar cach茅 (solo root)</span>

<span class="c-com"># 4. Monitoreo continuo</span>
<span class="c-linux">$ vmstat 1</span>                    <span class="c-com"># Estad铆sticas cada segundo</span>
<span class="c-linux">$ sar -r 1 10</span>                 <span class="c-com"># Informe de memoria cada 1s por 10 veces</span>

<span class="c-com"># 5. Swap (memoria virtual)</span>
<span class="c-linux">$ swapon --show</span>               <span class="c-com"># Ver particiones swap activas</span>
<span class="c-linux">$ swapon -a</span>                   <span class="c-com"># Activar todas las swaps</span>
<span class="c-linux">$ swapoff -a</span>                  <span class="c-com"># Desactivar todas las swaps</span>

<span class="c-com"># 6. L铆mites de memoria</span>
<span class="c-linux">$ ulimit -a</span>                   <span class="c-com"># Ver l铆mites actuales</span>
<span class="c-linux">$ ulimit -v 1000000</span>           <span class="c-com"># Limitar memoria virtual a 1GB</span>`;
                    }
                    
                    return code;
                },
                explain: (p) => {
                    const component = p.os_component;
                    const processCount = p.process_count;
                    
                    let componentInfo = "";
                    
                    if (component === 'Gesti贸n de Procesos') {
                        componentInfo = `
                        <p>Un proceso es un programa en ejecuci贸n. Linux asigna a cada proceso un PID 煤nico y gestiona su ejecuci贸n mediante el scheduler.</p>
                        
                        <p><b>Estados de un proceso:</b></p>
                        <ul>
                            <li><b>Running (R):</b> Ejecut谩ndose en CPU</li>
                            <li><b>Sleeping (S):</b> Esperando un evento</li>
                            <li><b>Stopped (T):</b> Detenido por se帽al</li>
                            <li><b>Zombie (Z):</b> Terminado pero no recolectado</li>
                        </ul>
                        
                        <div class="exp-note">
                            <i class="fas fa-microchip"></i> <b>En bioinform谩tica:</b>
                            <p>Se ejecutan m煤ltiples procesos en paralelo (aligners, callers, QC tools). Es crucial monitorear el uso de CPU y memoria para optimizar recursos.</p>
                        </div>`;
                    } else if (component === 'Gesti贸n de Memoria') {
                        componentInfo = `
                        <p>Linux gestiona memoria f铆sica y virtual mediante paginaci贸n. Cada proceso tiene su propio espacio de direcciones virtual.</p>
                        
                        <p><b>Tipos de memoria:</b></p>
                        <ul>
                            <li><b>RAM:</b> Memoria f铆sica principal</li>
                            <li><b>Swap:</b> Memoria virtual en disco</li>
                            <li><b>Cache/Buffers:</b> Memoria usada para acelerar acceso a disco</li>
                            <li><b>Shared:</b> Memoria compartida entre procesos</li>
                        </ul>
                        
                        <div class="exp-note">
                            <i class="fas fa-memory"></i> <b>En bioinform谩tica:</b>
                            <p>Algunas herramientas (como algunos aligners) pueden consumir grandes cantidades de memoria. Es importante monitorear y optimizar el uso.</p>
                        </div>`;
                    }
                    
                    return `
                    <div class="exp-highlight">
                        <b> Sistema Operativo: ${component}</b>
                        ${componentInfo}
                    </div>`;
                },
                render: (p, div) => {
                    div.style.cssText = "width:100%; height:100%; position:relative; overflow:hidden;";
                    div.innerHTML = '';
                    
                    const component = p.os_component;
                    const processCount = p.process_count;
                    
                    if (component === 'Gesti贸n de Procesos') {
                        // Visualizaci贸n de procesos
                        const processViz = document.createElement('div');
                        processViz.style.cssText = "width:100%; height:100%; position:relative; background:#1a1a1a;";
                        
                        // Crear "CPU" en el centro
                        const cpu = document.createElement('div');
                        cpu.style.cssText = `
                            position:absolute; 
                            left:50%; top:50%; 
                            transform:translate(-50%, -50%);
                            width:120px; height:120px; 
                            background:linear-gradient(135deg, #3498db, #2980b9);
                            border-radius:50%;
                            display:flex; 
                            align-items:center; 
                            justify-content:center;
                            color:white;
                            font-weight:bold;
                            box-shadow:0 0 30px rgba(52, 152, 219, 0.5);
                            z-index:10;
                        `;
                        cpu.textContent = "CPU";
                        processViz.appendChild(cpu);
                        
                        // Crear procesos orbitando
                        const processNames = ["BWA", "samtools", "GATK", "FastQC", "Rscript", "Python", "Perl", "bash", "java", "bedtools"];
                        const colors = ["#e74c3c", "#2ecc71", "#3498db", "#f39c12", "#9b59b6", "#1abc9c", "#d35400", "#c0392b", "#8e44ad", "#16a085"];
                        
                        for (let i = 0; i < processCount; i++) {
                            const angle = (i / processCount) * 2 * Math.PI;
                            const radius = 150;
                            const x = 50 + radius * Math.cos(angle);
                            const y = 50 + radius * Math.sin(angle);
                            
                            const process = document.createElement('div');
                            process.className = 'os-process';
                            process.style.cssText = `
                                position:absolute;
                                left:${x}%;
                                top:${y}%;
                                background:${colors[i % colors.length]};
                                transform:translate(-50%, -50%);
                                animation: processFloat ${2 + Math.random()}s infinite alternate ${i * 0.2}s;
                            `;
                            process.textContent = processNames[i] || `P${i+1}`;
                            
                            // L铆nea conectando al CPU
                            const line = document.createElement('div');
                            line.style.cssText = `
                                position:absolute;
                                left:50%;
                                top:50%;
                                width:${radius}%;
                                height:2px;
                                background:rgba(255,255,255,0.1);
                                transform-origin:0 0;
                                transform:rotate(${angle}rad);
                            `;
                            processViz.appendChild(line);
                            
                            processViz.appendChild(process);
                        }
                        
                        // Leyenda
                        const legend = document.createElement('div');
                        legend.style.cssText = `
                            position:absolute;
                            bottom:20px;
                            left:20px;
                            background:rgba(0,0,0,0.7);
                            color:white;
                            padding:10px;
                            border-radius:5px;
                            font-size:0.8rem;
                        `;
                        legend.innerHTML = `
                            <div><b>${processCount} procesos ejecut谩ndose</b></div>
                            <div style="margin-top:5px;"> Circulo central: CPU</div>
                            <div> C铆rculos orbitando: Procesos</div>
                            <div> L铆neas: Asignaci贸n de tiempo de CPU</div>
                        `;
                        processViz.appendChild(legend);
                        
                        div.appendChild(processViz);
                    }
                }
            },
            {
                id: 6,
                title: "Tema 6. Introducci贸n a Linux",
                desc: "Historia, distribuciones, terminal y comandos b谩sicos",
                icon: "fa-terminal",
                controls: [
                    {id: 'command_type', type: 'select', label: 'Tipo de Comando', options: ['Navegaci贸n', 'Archivos', 'Permisos', 'B煤squeda', 'Red']},
                    {id: 'terminal_size', type: 'range', label: 'Tama帽o Terminal', min: 1, max: 5, step: 1, val: 3}
                ],
                code: (p) => {
                    const type = p.command_type;
                    
                    if (type === 'Navegaci贸n') {
                        return `<span class="c-com"># COMANDOS DE NAVEGACIN EN LINUX</span>

<span class="c-com"># 1. Directorio actual</span>
<span class="c-linux">$ pwd</span>                        <span class="c-com"># Print Working Directory</span>

<span class="c-com"># 2. Cambiar directorio</span>
<span class="c-linux">$ cd /ruta/al/directorio</span>    <span class="c-com"># Cambiar a ruta absoluta</span>
<span class="c-linux">$ cd ..</span>                      <span class="c-com"># Subir un nivel</span>
<span class="c-linux">$ cd ~</span>                       <span class="c-com"># Ir al home directory</span>
<span class="c-linux">$ cd -</span>                       <span class="c-com"># Volver al directorio anterior</span>

<span class="c-com"># 3. Listar archivos</span>
<span class="c-linux">$ ls</span>                         <span class="c-com"># Listar archivos</span>
<span class="c-linux">$ ls -l</span>                      <span class="c-com"># Listar con detalles</span>
<span class="c-linux">$ ls -la</span>                     <span class="c-com"># Listar TODO incluyendo ocultos</span>
<span class="c-linux">$ ls -lh</span>                     <span class="c-com"># Listar con tama帽o legible</span>
<span class="c-linux">$ ls -ltr</span>                    <span class="c-com"># Listar por fecha (m谩s viejo primero)</span>
<span class="c-linux">$ ls *.fastq</span>                  <span class="c-com"># Listar solo archivos FASTQ</span>

<span class="c-com"># 4. Variables de entorno 煤tiles</span>
<span class="c-linux">$ echo $HOME</span>                  <span class="c-com"># Ruta del home directory</span>
<span class="c-linux">$ echo $PATH</span>                  <span class="c-com"># Directorios de ejecutables</span>
<span class="c-linux">$ echo $PWD</span>                   <span class="c-com"># Directorio actual</span>

<span class="c-com"># 5. Atajos de teclado</span>
<span class="c-com"># Ctrl+L: Limpiar pantalla (clear)</span>
<span class="c-com"># Ctrl+A: Ir al inicio de la l铆nea</span>
<span class="c-com"># Ctrl+E: Ir al final de la l铆nea</span>
<span class="c-com"># Tab: Autocompletar</span>`;
                    } else if (type === 'Archivos') {
                        return `<span class="c-com"># COMANDOS DE MANEJO DE ARCHIVOS</span>

<span class="c-com"># 1. Crear archivos/directorios</span>
<span class="c-linux">$ touch archivo.txt</span>           <span class="c-com"># Crear archivo vac铆o</span>
<span class="c-linux">$ mkdir directorio</span>            <span class="c-com"># Crear directorio</span>
<span class="c-linux">$ mkdir -p ruta/completa</span>      <span class="c-com"># Crear ruta completa</span>

<span class="c-com"># 2. Copiar</span>
<span class="c-linux">$ cp origen destino</span>           <span class="c-com"># Copiar archivo</span>
<span class="c-linux">$ cp -r dir_origen dir_destino</span> <span class="c-com"># Copiar directorio recursivamente</span>

<span class="c-com"># 3. Mover/Renombrar</span>
<span class="c-linux">$ mv origen destino</span>           <span class="c-com"># Mover o renombrar</span>
<span class="c-linux">$ mv *.fastq data/</span>            <span class="c-com"># Mover todos los FASTQ a data/</span>

<span class="c-com"># 4. Eliminar</span>
<span class="c-linux">$ rm archivo.txt</span>              <span class="c-com"># Eliminar archivo</span>
<span class="c-linux">$ rm -r directorio</span>            <span class="c-com"># Eliminar directorio recursivamente</span>
<span class="c-linux">$ rm -rf directorio</span>           <span class="c-com"># Eliminar forzadamente (隆CUIDADO!)</span>

<span class="c-com"># 5. Ver contenido</span>
<span class="c-linux">$ cat archivo.txt</span>             <span class="c-com"># Mostrar contenido completo</span>
<span class="c-linux">$ less archivo.txt</span>            <span class="c-com"># Ver con paginaci贸n (q para salir)</span>
<span class="c-linux">$ head -n 20 archivo.txt</span>      <span class="c-com"># Mostrar primeras 20 l铆neas</span>
<span class="c-linux">$ tail -n 20 archivo.txt</span>      <span class="c-com"># Mostrar 煤ltimas 20 l铆neas</span>
<span class="c-linux">$ tail -f log.txt</span>             <span class="c-com"># Seguir archivo en tiempo real</span>

<span class="c-com"># 6. Buscar contenido</span>
<span class="c-linux">$ grep "patr贸n" archivo.txt</span>   <span class="c-com"># Buscar patr贸n en archivo</span>
<span class="c-linux">$ grep -r "gen" directorio/</span>   <span class="c-com"># Buscar recursivamente</span>
<span class="c-linux">$ grep -i "gen" archivo.txt</span>   <span class="c-com"># Buscar ignorando may煤sculas</span>`;
                    }
                    
                    return code;
                },
                explain: (p) => {
                    const type = p.command_type;
                    
                    let typeInfo = "";
                    
                    if (type === 'Navegaci贸n') {
                        typeInfo = `
                        <p>La navegaci贸n en Linux se realiza principalmente a trav茅s de la terminal. El sistema de archivos es jer谩rquico, comenzando desde la ra铆z (/).</p>
                        
                        <p><b>Estructura t铆pica de directorios:</b></p>
                        <ul>
                            <li><b>/</b> - Ra铆z del sistema</li>
                            <li><b>/home/usuario/</b> - Directorio personal</li>
                            <li><b>/bin, /usr/bin</b> - Ejecutables del sistema</li>
                            <li><b>/etc</b> - Archivos de configuraci贸n</li>
                            <li><b>/var</b> - Archivos variables (logs, datos)</li>
                            <li><b>/tmp</b> - Archivos temporales</li>
                        </ul>
                        
                        <div class="exp-note">
                            <i class="fas fa-folder-open"></i> <b>Consejo para bioinform谩ticos:</b>
                            <p>Organiza tus proyectos en directorios estructurados:<br>
                             <code>~/projects/proyecto_bioinfo/</code><br>
                             <code> data/raw/</code> (datos crudos)<br>
                             <code> data/processed/</code> (datos procesados)<br>
                             <code> scripts/</code> (c贸digo)<br>
                             <code> results/</code> (resultados)</p>
                        </div>`;
                    } else if (type === 'Archivos') {
                        typeInfo = `
                        <p>Linux trata todo como archivos: dispositivos, directorios, enlaces, etc. Los comandos de manejo de archivos son esenciales para el trabajo diario.</p>
                        
                        <p><b>Tipos de archivos:</b></p>
                        <ul>
                            <li><b>-</b> - Archivo regular</li>
                            <li><b>d</b> - Directorio</li>
                            <li><b>l</b> - Enlace simb贸lico</li>
                            <li><b>c</b> - Dispositivo de caracteres</li>
                            <li><b>b</b> - Dispositivo de bloques</li>
                        </ul>
                        
                        <div class="exp-note">
                            <i class="fas fa-exclamation-triangle"></i> <b>隆Precauci贸n con rm -rf!</b>
                            <p>El comando <code>rm -rf</code> elimina archivos y directorios recursivamente y forzadamente. Puede causar p茅rdida de datos irreparable. Siempre verifica antes de ejecutar.</p>
                        </div>`;
                    }
                    
                    return `
                    <div class="exp-highlight">
                        <b> Linux: ${type}</b>
                        ${typeInfo}
                    </div>`;
                },
                render: (p, div) => {
                    div.style.cssText = "width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center;";
                    div.innerHTML = '';
                    
                    const type = p.command_type;
                    const size = p.terminal_size;
                    
                    // Crear terminal interactiva
                    const terminal = document.createElement('div');
                    terminal.className = 'terminal';
                    terminal.style.cssText = `width:${60 + size * 10}%; height:${60 + size * 10}%;`;
                    
                    let terminalContent = `
                    <div class="terminal-header">
                        <div class="terminal-title">Terminal Linux - ${type}</div>
                        <div class="terminal-buttons">
                            <div class="terminal-btn close"></div>
                            <div class="terminal-btn minimize"></div>
                            <div class="terminal-btn maximize"></div>
                        </div>
                    </div>
                    <div class="terminal-body">
                        <div class="terminal-line"><span class="terminal-prompt">usuario@bioinfo:~$</span> pwd</div>
                        <div class="terminal-line">/home/usuario/projects/bioinformatics</div>
                    `;
                    
                    if (type === 'Navegaci贸n') {
                        terminalContent += `
                        <div class="terminal-line"><span class="terminal-prompt">usuario@bioinfo:~$</span> ls -la</div>
                        <div class="terminal-line">total 48</div>
                        <div class="terminal-line">drwxr-xr-x 6 usuario usuario  4096 Mar 15 10:30 <span style="color:#4CAF50;">.</span></div>
                        <div class="terminal-line">drwxr-xr-x 3 usuario usuario  4096 Mar 10 09:15 <span style="color:#4CAF50;">..</span></div>
                        <div class="terminal-line">drwxr-xr-x 2 usuario usuario  4096 Mar 12 14:20 <span style="color:#3498db;">data</span></div>
                        <div class="terminal-line">drwxr-xr-x 2 usuario usuario  4096 Mar 14 11:45 <span style="color:#3498db;">scripts</span></div>
                        <div class="terminal-line">drwxr-xr-x 2 usuario usuario  4096 Mar 15 09:30 <span style="color:#3498db;">results</span></div>
                        <div class="terminal-line">-rw-r--r-- 1 usuario usuario   128 Mar 10 10:15 README.md</div>
                        <div class="terminal-line">-rwxr-xr-x 1 usuario usuario  2048 Mar 14 16:20 <span style="color:#e74c3c;">pipeline.sh</span></div>
                        <div class="terminal-line"><span class="terminal-prompt">usuario@bioinfo:~$</span> cd data</div>
                        <div class="terminal-line"><span class="terminal-prompt">usuario@bioinfo:~/data$</span> ls</div>
                        <div class="terminal-line">sample1.fastq.gz  sample2.fastq.gz  reference.fasta</div>
                        <div class="terminal-line"><span class="terminal-prompt">usuario@bioinfo:~/data$</span> cd ..</div>
                        <div class="terminal-line"><span class="terminal-prompt">usuario@bioinfo:~$</span> <span class="terminal-cursor">_</span></div>
                        `;
                    } else if (type === 'Archivos') {
                        terminalContent += `
                        <div class="terminal-line"><span class="terminal-prompt">usuario@bioinfo:~$</span> mkdir -p project/{data,scripts,results}</div>
                        <div class="terminal-line"><span class="terminal-prompt">usuario@bioinfo:~$</span> tree project -L 2</div>
                        <div class="terminal-line">project/</div>
                        <div class="terminal-line"> data</div>
                        <div class="terminal-line"> results</div>
                        <div class="terminal-line"> scripts</div>
                        <div class="terminal-line"></div>
                        <div class="terminal-line"><span class="terminal-prompt">usuario@bioinfo:~$</span> touch project/scripts/analysis.R</div>
                        <div class="terminal-line"><span class="terminal-prompt">usuario@bioinfo:~$</span> cp *.fastq project/data/</div>
                        <div class="terminal-line"><span class="terminal-prompt">usuario@bioinfo:~$</span> head -n 5 project/data/sample1.fastq</div>
                        <div class="terminal-line">@SEQ_ID:1</div>
                        <div class="terminal-line">GATTTGGGGTTCAAAGCAGTATCGATCAAATAGTAAATCCATTTGTTCAACTCACAGTTT</div>
                        <div class="terminal-line">+</div>
                        <div class="terminal-line">!''*((((***+))%%%++)(%%%%).1***-+*''))**55CCF>>>>>>CCCCCCC65</div>
                        <div class="terminal-line"><span class="terminal-prompt">usuario@bioinfo:~$</span> grep -c "@" project/data/sample1.fastq</div>
                        <div class="terminal-line">100000</div>
                        <div class="terminal-line"><span class="terminal-prompt">usuario@bioinfo:~$</span> <span class="terminal-cursor">_</span></div>
                        `;
                    }
                    
                    terminalContent += `</div>`;
                    terminal.innerHTML = terminalContent;
                    
                    div.appendChild(terminal);
                }
            },
                       {
                id: 7,
                title: "Tema 7. Shell Scripting & Permisos",
                desc: "Bash scripting avanzado y gesti贸n de permisos en Linux",
                icon: "fa-file-code",
                controls: [
                    {id: 'script_type', type: 'select', label: 'Tipo de Script', options: ['Automatizaci贸n', 'Pipeline', 'Monitorizaci贸n', 'Backup']},
                    {id: 'permission_type', type: 'select', label: 'Tipo de Permiso', options: ['Lectura (r)', 'Escritura (w)', 'Ejecuci贸n (x)', 'Combinado']}
                ],
                code: (p) => {
                    const scriptType = p.script_type;
                    
                    if (scriptType === 'Pipeline') {
                        return `<span class="c-com">#!/bin/bash</span>
<span class="c-com"># SCRIPT DE PIPELINE BIOINFORMTICO</span>
<span class="c-com"># Orquesta m煤ltiples herramientas en un flujo de trabajo</span>

<span class="c-com"># Configuraci贸n</span>
<span class="c-var">INPUT_DIR</span>=<span class="c-str">"$1"</span>          <span class="c-com"># Directorio de entrada como par谩metro</span>
<span class="c-var">OUTPUT_DIR</span>=<span class="c-str">"results/$(date +%Y%m%d_%H%M%S)"</span>
<span class="c-var">THREADS</span>=<span class="c-str">"$(nproc)"</span>      <span class="c-com"># Usar todos los cores disponibles</span>
<span class="c-var">REFERENCE</span>=<span class="c-str">"hg38.fasta"</span>

<span class="c-com"># Funci贸n para logging</span>
<span class="c-fn">log</span>() {
    <span class="c-fn">echo</span> <span class="c-str">"[$(date '+%Y-%m-%d %H:%M:%S')] $1"</span> | <span class="c-fn">tee</span> -a <span class="c-str">"$OUTPUT_DIR/pipeline.log"</span>
}

<span class="c-com"># Funci贸n para manejar errores</span>
<span class="c-fn">error_exit</span>() {
    <span class="c-fn">log</span> <span class="c-str">"ERROR: $1"</span>
    <span class="c-fn">exit</span> <span class="c-num">1</span>
}

<span class="c-com"># Verificar dependencias</span>
<span class="c-fn">check_dependency</span>() {
    <span class="c-kwd">if</span> ! <span class="c-fn">command</span> -v <span class="c-str">"$1"</span> &> /dev/null; <span class="c-kwd">then</span>
        <span class="c-fn">error_exit</span> <span class="c-str">"'$1' no encontrado. Por favor inst谩lalo."</span>
    <span class="c-kwd">fi</span>
}

<span class="c-com"># Verificar todas las dependencias</span>
<span class="c-kwd">for</span> tool <span class="c-kwd">in</span> bwa samtools bcftools fastqc; <span class="c-kwd">do</span>
    <span class="c-fn">check_dependency</span> <span class="c-str">"$tool"</span>
<span class="c-kwd">done</span>

<span class="c-com"># Crear directorios de salida</span>
<span class="c-fn">mkdir</span> -p <span class="c-str">"$OUTPUT_DIR"</span> <span class="c-str">"$OUTPUT_DIR/qc"</span> <span class="c-str">"$OUTPUT_DIR/aligned"</span> <span class="c-str">"$OUTPUT_DIR/variants"</span>

<span class="c-com"># Iniciar pipeline</span>
<span class="c-fn">log</span> <span class="c-str">"Iniciando pipeline bioinform谩tico"</span>
<span class="c-fn">log</span> <span class="c-str">"Input: $INPUT_DIR, Output: $OUTPUT_DIR, Threads: $THREADS"</span>

<span class="c-com"># Paso 1: Control de calidad</span>
<span class="c-fn">log</span> <span class="c-str">"Paso 1: Control de calidad con FastQC"</span>
<span class="c-kwd">for</span> fastq <span class="c-kwd">in</span> <span class="c-str">"$INPUT_DIR"</span>/*.fastq.gz; <span class="c-kwd">do</span>
    <span class="c-var">sample</span>=<span class="c-str">"$(basename "$fastq" .fastq.gz)"</span>
    fastqc <span class="c-str">"$fastq"</span> -o <span class="c-str">"$OUTPUT_DIR/qc"</span> -t <span class="c-str">"$THREADS"</span> &
<span class="c-kwd">done</span>
<span class="c-fn">wait</span>

<span class="c-com"># Paso 2: Alineamiento</span>
<span class="c-fn">log</span> <span class="c-str">"Paso 2: Alineamiento con BWA-MEM"</span>
<span class="c-kwd">for</span> fastq <span class="c-kwd">in</span> <span class="c-str">"$INPUT_DIR"</span>/*_R1.fastq.gz; <span class="c-kwd">do</span>
    <span class="c-var">sample</span>=<span class="c-str">"$(basename "$fastq" _R1.fastq.gz)"</span>
    <span class="c-var">r1</span>=<span class="c-str">"$fastq"</span>
    <span class="c-var">r2</span>=<span class="c-str">"${fastq/_R1/_R2}"</span>
    
    <span class="c-fn">log</span> <span class="c-str">"Alineando muestra: $sample"</span>
    bwa mem -t <span class="c-str">"$THREADS"</span> <span class="c-str">"$REFERENCE"</span> <span class="c-str">"$r1"</span> <span class="c-str">"$r2"</span> | \
        samtools view -@ <span class="c-str">"$THREADS"</span> -bS - | \
        samtools sort -@ <span class="c-str">"$THREADS"</span> -o <span class="c-str">"$OUTPUT_DIR/aligned/$sample.bam"</span> -
<span class="c-kwd">done</span>

<span class="c-com"># Paso 3: Llamado de variantes</span>
<span class="c-fn">log</span> <span class="c-str">"Paso 3: Llamado de variantes con bcftools"</span>
samtools mpileup -f <span class="c-str">"$REFERENCE"</span> <span class="c-str">"$OUTPUT_DIR/aligned"</span>/*.bam | \
    bcftools call -mv -Ov -o <span class="c-str">"$OUTPUT_DIR/variants/final.vcf"</span>

<span class="c-com"># Resumen final</span>
<span class="c-var">total_variants</span>=<span class="c-str">"$(grep -v '^#' "$OUTPUT_DIR/variants/final.vcf" | wc -l)"</span>
<span class="c-fn">log</span> <span class="c-str">"Pipeline completado exitosamente"</span>
<span class="c-fn">log</span> <span class="c-str">"Total de variantes identificadas: $total_variants"</span>
<span class="c-fn">log</span> <span class="c-str">"Resultados disponibles en: $OUTPUT_DIR"</span>`;
                    } else {
                        // Para los otros tipos de script, devolver un c贸digo simple
                        return `<span class="c-com"># Script de ${scriptType} en Bash</span>
<span class="c-com"># C贸digo para ${scriptType}...</span>`;
                    }
                },
                explain: (p) => {
                    const scriptType = p.script_type;
                    const permType = p.permission_type;
                    
                    return `
                    <div class="exp-highlight">
                        <b> Shell Scripting & Permisos</b>
                        <p>Los scripts de Bash permiten automatizar tareas repetitivas en bioinform谩tica. Los permisos controlan qui茅n puede leer, escribir o ejecutar archivos.</p>
                    </div>
                    
                    <p><b>Tipo de script: ${scriptType}</b></p>
                    <p>Los scripts de ${scriptType.toLowerCase()} son esenciales para:</p>
                    <ul>
                        ${scriptType === 'Pipeline' ? `
                        <li>К Orquestar m煤ltiples herramientas bioinform谩ticas</li>
                        <li> Conectar la salida de un programa con la entrada de otro</li>
                        <li> Ejecutar an谩lisis en paralelo cuando sea posible</li>
                        <li> Generar reportes consolidados</li>
                        ` : scriptType === 'Automatizaci贸n' ? `
                        <li> Ejecutar tareas programadas (cron jobs)</li>
                        <li> Organizar y limpiar archivos temporales</li>
                        <li> Descargar datos de repositorios p煤blicos</li>
                        <li> Subir resultados a servidores</li>
                        ` : scriptType === 'Monitorizaci贸n' ? `
                        <li> Supervisar uso de CPU, memoria y disco</li>
                        <li> Verificar que pipelines est茅n ejecut谩ndose correctamente</li>
                        <li>锔 Enviar alertas por email cuando haya errores</li>
                        <li> Generar dashboards de estado</li>
                        ` : `
                        <li> Hacer copias de seguridad de datos cr铆ticos</li>
                        <li> Sincronizar datos entre servidores</li>
                        <li> Comprimir y archivar resultados antiguos</li>
                        <li>锔 Rotar logs y archivos temporales</li>
                        `}
                    </ul>
                    
                    <div class="exp-note">
                        <i class="fas fa-shield-alt"></i> <b>Permisos en Linux (${permType}):</b>
                        <p>Los permisos se representan como: <code>rwxrwxrwx</code><br>
                         Primer grupo (rwx): Propietario<br>
                         Segundo grupo (rwx): Grupo<br>
                         Tercer grupo (rwx): Otros<br><br>
                        
                        <b>Valores num茅ricos (chmod):</b><br>
                         r (read/lectura) = 4<br>
                         w (write/escritura) = 2<br>
                         x (execute/ejecuci贸n) = 1</p>
                    </div>`;
                },
                render: (p, div) => {
                    div.style.cssText = "width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; box-sizing:border-box;";
                    div.innerHTML = '';
                    
                    const scriptType = p.script_type;
                    const permType = p.permission_type;
                    
                    // Crear visualizaci贸n de permisos
                    const permViz = document.createElement('div');
                    permViz.style.cssText = "width:90%; max-width:600px; background:white; border-radius:10px; padding:20px; box-shadow:0 5px 15px rgba(0,0,0,0.1); margin-bottom:20px;";
                    
                    // Representaci贸n visual de permisos
                    const permissions = {
                        'Lectura (r)': {symbol: 'r', value: 4, color: '#3498db'},
                        'Escritura (w)': {symbol: 'w', value: 2, color: '#e74c3c'},
                        'Ejecuci贸n (x)': {symbol: 'x', value: 1, color: '#2ecc71'}
                    };
                    
                    let permHTML = `
                    <div style="text-align:center; margin-bottom:20px;">
                        <h3 style="color:#333;">Sistema de Permisos en Linux</h3>
                        <p style="color:#666;">Permiso seleccionado: <b>${permType}</b></p>
                    </div>
                    
                    <div style="display:flex; justify-content:center; gap:30px; margin-bottom:30px;">
                    `;
                    
                    Object.keys(permissions).forEach(permName => {
                        const perm = permissions[permName];
                        const isSelected = permType.includes(perm.symbol) || permType === 'Combinado';
                        
                        permHTML += `
                        <div style="text-align:center; width:100px;">
                            <div style="width:80px; height:80px; border-radius:50%; background:${isSelected ? perm.color : '#ecf0f1'}; 
                                 color:${isSelected ? 'white' : '#bdc3c7'}; display:flex; align-items:center; justify-content:center; 
                                 font-size:2rem; font-weight:bold; margin:0 auto 10px; border:3px solid ${isSelected ? perm.color : '#ddd'};">
                                ${perm.symbol}
                            </div>
                            <div style="font-weight:bold; color:#333;">${permName}</div>
                            <div style="font-size:0.9rem; color:#777;">Valor: ${perm.value}</div>
                        </div>
                        `;
                    });
                    
                    permHTML += `</div>`;
                    
                    // Ejemplo de chmod
                    permHTML += `
                    <div style="background:#f8f9fa; padding:15px; border-radius:5px; margin-top:20px;">
                        <h4 style="color:#333; margin-bottom:10px;">Ejemplo: Comando chmod</h4>
                        <div style="font-family:'Fira Code', monospace; background:#2c3e50; color:white; padding:10px; border-radius:3px;">
                            <span style="color:#4CAF50;">$</span> chmod ${permType === 'Lectura (r)' ? 'u+r' : 
                                                                        permType === 'Escritura (w)' ? 'u+w' : 
                                                                        permType === 'Ejecuci贸n (x)' ? 'u+x' : '755'} script.sh
                        </div>
                        <div style="margin-top:10px; font-size:0.9rem; color:#666;">
                            ${permType === 'Combinado' ? '755 = rwxr-xr-x (Propietario: rwx, Grupo: r-x, Otros: r-x)' :
                            'u = usuario/propietario, g = grupo, o = otros, a = todos'}
                        </div>
                    </div>
                    `;
                    
                    permViz.innerHTML = permHTML;
                    div.appendChild(permViz);
                    
                    // Crear visualizaci贸n de pipeline
                    const pipelineViz = document.createElement('div');
                    pipelineViz.style.cssText = "width:90%; max-width:600px; background:white; border-radius:10px; padding:20px; box-shadow:0 5px 15px rgba(0,0,0,0.1);";
                    
                    const pipelineSteps = [
                        {name: "FastQC", desc: "Control de calidad", color: "#3498db", status: "completed"},
                        {name: "Trimmomatic", desc: "Recorte de adaptadores", color: "#e74c3c", status: "completed"},
                        {name: "BWA-MEM", desc: "Alineamiento", color: "#2ecc71", status: "running"},
                        {name: "samtools", desc: "Procesamiento BAM", color: "#f39c12", status: "pending"},
                        {name: "GATK", desc: "Llamado de variantes", color: "#9b59b6", status: "pending"}
                    ];
                    
                    let pipelineHTML = `
                    <div style="text-align:center; margin-bottom:20px;">
                        <h3 style="color:#333;">Pipeline Bioinform谩tico</h3>
                        <p style="color:#666;">${scriptType} - Ejecuci贸n paso a paso</p>
                    </div>
                    
                    <div style="position:relative; padding-left:30px;">
                    `;
                    
                    pipelineSteps.forEach((step, i) => {
                        pipelineHTML += `
                        <div style="margin-bottom:25px; position:relative;">
                            <div style="position:absolute; left:-30px; top:0; width:20px; height:20px; border-radius:50%; 
                                 background:${step.status === 'completed' ? step.color : 
                                            step.status === 'running' ? step.color : '#ecf0f1'}; 
                                 border:2px solid ${step.status === 'pending' ? '#ddd' : step.color};"></div>
                            
                            <div style="background:${step.status === 'completed' ? step.color + '20' : 
                                                   step.status === 'running' ? step.color + '20' : '#f8f9fa'}; 
                                 padding:10px 15px; border-radius:5px; border-left:4px solid ${step.color};">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <div>
                                        <div style="font-weight:bold; color:#333;">${step.name}</div>
                                        <div style="font-size:0.9rem; color:#666;">${step.desc}</div>
                                    </div>
                                    <div style="font-size:0.8rem; color:${step.status === 'completed' ? '#2ecc71' : 
                                                                        step.status === 'running' ? '#f39c12' : '#95a5a6'}; 
                                         font-weight:bold;">
                                        ${step.status === 'completed' ? ' Completado' : 
                                          step.status === 'running' ? ' Ejecutando' : ' Pendiente'}
                                    </div>
                                </div>
                            </div>
                        </div>
                        `;
                        
                        if (i < pipelineSteps.length - 1) {
                            pipelineHTML += `
                            <div style="position:absolute; left:-21px; top:20px; bottom:-5px; width:2px; 
                                 background:${step.status === 'completed' ? step.color : '#ecf0f1'};"></div>
                            `;
                        }
                    });
                    
                    pipelineHTML += `</div>`;
                    pipelineViz.innerHTML = pipelineHTML;
                    div.appendChild(pipelineViz);
                }
            },
            {
                id: 8,
                title: "Tema 8. Introducci贸n a Perl",
                desc: "Sintaxis b谩sica, variables, estructuras de control y expresiones regulares",
                icon: "fa-code",
                controls: [
                    {id: 'perl_concept', type: 'select', label: 'Concepto Perl', options: ['Variables y Tipos', 'Estructuras de Control', 'Expresiones Regulares', 'Subrutinas']},
                    {id: 'regex_pattern', type: 'select', label: 'Patr贸n Regex', options: ['ADN/ARN', 'Prote铆nas', 'N煤meros', 'Correos']}
                ],
                code: (p) => {
                    const concept = p.perl_concept;
                    const regex = p.regex_pattern;
                    
                    if (concept === 'Variables y Tipos') {
                        return `<span class="c-perl">#!/usr/bin/perl</span>
<span class="c-kwd">use</span> strict;
<span class="c-kwd">use</span> warnings;

<span class="c-com"># VARIABLES EN PERL</span>
<span class="c-com"># Tipos fundamentales: escalares, arrays y hashes</span>

<span class="c-com"># 1. Escalares (prefijo $)</span>
<span class="c-kwd">my</span> <span class="c-var">$gen_name</span> = <span class="c-str">"TP53"</span>;              <span class="c-com"># Cadena</span>
<span class="c-kwd">my</span> <span class="c-var">$expression_level</span> = <span class="c-num">45.67</span>;     <span class="c-com"># N煤mero</span>
<span class="c-kwd">my</span> <span class="c-var">$is_expressed</span> = <span class="c-num">1</span>;            <span class="c-com"># Booleano (1 = true, 0 = false)</span>

<span class="c-com"># 2. Arrays (prefijo @)</span>
<span class="c-kwd">my</span> <span class="c-var">@genes</span> = (<span class="c-str">"BRCA1"</span>, <span class="c-str">"BRCA2"</span>, <span class="c-str">"TP53"</span>, <span class="c-str">"EGFR"</span>);
<span class="c-kwd">my</span> <span class="c-var">@expression_levels</span> = (<span class="c-num">12.5</span>, <span class="c-num">8.9</span>, <span class="c-num">45.6</span>, <span class="c-num">3.2</span>);

<span class="c-com"># Acceder a elementos del array (usa $)</span>
<span class="c-var">$genes</span>[<span class="c-num">0</span>] = <span class="c-str">"BRCA1_updated"</span>;          <span class="c-com"># Modificar primer elemento</span>
<span class="c-kwd">my</span> <span class="c-var">$third_gene</span> = <span class="c-var">$genes</span>[<span class="c-num">2</span>];       <span class="c-com"># Acceder al tercer elemento</span>

<span class="c-com"># 3. Hashes (prefijo %)</span>
<span class="c-kwd">my</span> <span class="c-var">%gene_functions</span> = (
    <span class="c-str">"TP53"</span>    => <span class="c-str">"Supresor tumoral"</span>,
    <span class="c-str">"EGFR"</span>    => <span class="c-str">"Receptor factor crecimiento"</span>,
    <span class="c-str">"BRCA1"</span>   => <span class="c-str">"Reparaci贸n ADN"</span>,
    <span class="c-str">"HER2"</span>    => <span class="c-str">"Receptor tirosina quinasa"</span>
);

<span class="c-com"># Acceder a valores del hash</span>
<span class="c-kwd">my</span> <span class="c-var">$tp53_func</span> = <span class="c-var">$gene_functions</span>{<span class="c-str">"TP53"</span>};
<span class="c-var">$gene_functions</span>{<span class="c-str">"KRAS"</span>} = <span class="c-str">"Proto-oncog茅n"</span>;  <span class="c-com"># Agregar nuevo par</span>

<span class="c-com"># 4. Contextos en Perl (muy importante)</span>
<span class="c-kwd">my</span> <span class="c-var">@genes_copy</span> = <span class="c-var">@genes</span>;            <span class="c-com"># Contexto lista: copia todo el array</span>
<span class="c-kwd">my</span> <span class="c-var">$genes_count</span> = <span class="c-var">@genes</span>;           <span class="c-com"># Contexto escalar: n煤mero de elementos</span>

<span class="c-fn">print</span> <span class="c-str">"Total de genes: $genes_count\\n"</span>;
<span class="c-fn">print</span> <span class="c-str">"Funci贸n de TP53: $tp53_func\\n"</span>;`;
                    } else if (concept === 'Expresiones Regulares') {
                        let pattern = "";
                        let example = "";
                        
                        if (regex === 'ADN/ARN') {
                            pattern = '^[ACGTUacgtu]+$';
                            example = 'ATGCTAGCTAGCTAGCTAGCTA';
                        } else if (regex === 'Prote铆nas') {
                            pattern = '^[ACDEFGHIKLMNPQRSTVWYacdefghiklmnpqrstvwy]+$';
                            example = 'MVLSPADKTNVKAAWGKVGAHAGEYGAEALERMFLSFPTTKTYFPHFDLSHGSAQVKGHGKKVADALTNAVAHVDDMPNALSALSDLHAHKLRVDPVNFKLLSHCLLVTLAAHLPAEFTPAVHASLDKFLASVSTVLTSKYR';
                        } else if (regex === 'N煤meros') {
                            pattern = '^-?\\d+(\\.\\d+)?([eE][+-]?\\d+)?$';
                            example = '3.14159e-10';
                        } else {
                            pattern = '^[\\w.%+-]+@[\\w.-]+\\.[A-Za-z]{2,}$';
                            example = 'investigador@instituto.edu';
                        }
                        
                        return `<span class="c-perl">#!/usr/bin/perl</span>
<span class="c-kwd">use</span> strict;
<span class="c-kwd">use</span> warnings;

<span class="c-com"># EXPRESIONES REGULARES EN PERL</span>
<span class="c-com"># Una de las fortalezas principales de Perl</span>

<span class="c-com"># Sintaxis b谩sica: m// (match) y s/// (substitute)</span>
<span class="c-kwd">my</span> <span class="c-var">$sequence</span> = <span class="c-str">"${example}"</span>;

<span class="c-com"># 1. Verificar patr贸n (match)</span>
<span class="c-kwd">if</span> (<span class="c-var">$sequence</span> =~ <span class="c-fn">m/${pattern}/</span>) {
    <span class="c-fn">print</span> <span class="c-str">"La secuencia coincide con el patr贸n\\n"</span>;
} <span class="c-kwd">else</span> {
    <span class="c-fn">print</span> <span class="c-str">"La secuencia NO coincide con el patr贸n\\n"</span>;
}

<span class="c-com"># 2. Extraer partes espec铆ficas (capturing groups)</span>
<span class="c-kwd">my</span> <span class="c-var">$fasta_entry</span> = <span class="c-str">">gene_001 Homo sapiens TP53 gene\\nATGCTAGCTAGCTAGCTAGCTA"</span>;

<span class="c-kwd">if</span> (<span class="c-var">$fasta_entry</span> =~ <span class="c-fn">m/^>([^\\s]+)\\s+(.+)$/m</span>) {
    <span class="c-kwd">my</span> <span class="c-var">$gene_id</span> = <span class="c-var">$1</span>;      <span class="c-com"># gene_001</span>
    <span class="c-kwd">my</span> <span class="c-var">$description</span> = <span class="c-var">$2</span>;  <span class="c-com"># Homo sapiens TP53 gene</span>
    <span class="c-fn">print</span> <span class="c-str">"ID: $gene_id\\nDescripci贸n: $description\\n"</span>;
}

<span class="c-com"># 3. Sustituci贸n (substitute)</span>
<span class="c-kwd">my</span> <span class="c-var">$dna_sequence</span> = <span class="c-str">"ATGCTAGCTAGCTAGCTAGCTA"</span>;

<span class="c-com"># Cambiar todas las T por U (ADN -> ARN)</span>
<span class="c-var">$dna_sequence</span> =~ <span class="c-fn">s/T/U/g</span>;
<span class="c-fn">print</span> <span class="c-str">"Secuencia de ARN: $dna_sequence\\n"</span>;

<span class="c-com"># 4. B煤squeda global</span>
<span class="c-kwd">my</span> <span class="c-var">$text</span> = <span class="c-str">"El gen TP53 est谩 mutado en 50% de c谩nceres. TP53 es crucial."</span>;
<span class="c-kwd">my</span> <span class="c-var">@matches</span> = <span class="c-var">$text</span> =~ <span class="c-fn">m/TP53/g</span>;
<span class="c-fn">print</span> <span class="c-str">"TP53 aparece "</span> . <span class="c-fn">scalar</span>(<span class="c-var">@matches</span>) . <span class="c-str">" veces\\n"</span>;

<span class="c-com"># 5. Modificadores comunes</span>
<span class="c-com">#   /i - case insensitive</span>
<span class="c-com">#   /g - global (todas las ocurrencias)</span>
<span class="c-com">#   /m - multil铆nea</span>
<span class="c-com">#   /s - single line (trata cadena como una sola l铆nea)</span>
<span class="c-com">#   /x - permite espacios y comentarios en el patr贸n</span>

<span class="c-kwd">my</span> <span class="c-var">$seq</span> = <span class="c-str">"atgctagc"</span>;
<span class="c-kwd">if</span> (<span class="c-var">$seq</span> =~ <span class="c-fn">m/ATG/i</span>) {  <span class="c-com"># /i ignora may煤sculas/min煤sculas</span>
    <span class="c-fn">print</span> <span class="c-str">"Encontrado cod贸n de inicio (ignorando case)\\n"</span>;
}

<span class="c-com"># 6. Patrones comunes en bioinform谩tica</span>
<span class="c-kwd">my</span> <span class="c-var">$protein_seq</span> = <span class="c-str">"MVLSPADKTNVK"</span>;

<span class="c-com"># Buscar sitios de fosforilaci贸n (S, T, Y seguidas de P)</span>
<span class="c-kwd">if</span> (<span class="c-var">$protein_seq</span> =~ <span class="c-fn">m/[STY]P/</span>) {
    <span class="c-fn">print</span> <span class="c-str">"Posible sitio de fosforilaci贸n encontrado\\n"</span>;
}

<span class="c-com"># Buscar patrones de N-glicosilaci贸n (N seguido de cualquier cosa excepto P, luego S o T)</span>
<span class="c-kwd">if</span> (<span class="c-var">$protein_seq</span> =~ <span class="c-fn">m/N[^P][ST]/</span>) {
    <span class="c-fn">print</span> <span class="c-str">"Posible sitio de N-glicosilaci贸n encontrado\\n"</span>;
}`;
                    }
                    
                    return code;
                },
                explain: (p) => {
                    const concept = p.perl_concept;
                    const regex = p.regex_pattern;
                    
                    let conceptInfo = "";
                    
                    if (concept === 'Variables y Tipos') {
                        conceptInfo = `
                        <p>Perl tiene tres tipos fundamentales de variables:</p>
                        
                        <p><b>1. Escalares ($):</b> Almacenan un solo valor (cadena, n煤mero, referencia)</p>
                        <p><b>2. Arrays (@):</b> Listas ordenadas de escalares</p>
                        <p><b>3. Hashes (%):</b> Pares clave-valor (diccionarios)</p>
                        
                        <div class="exp-note">
                            <i class="fas fa-exclamation-circle"></i> <b>隆Atenci贸n al contexto!</b>
                            <p>En Perl, el significado de una variable depende del contexto:<br>
                             <code>@genes</code> en contexto lista: todos los elementos<br>
                             <code>@genes</code> en contexto escalar: n煤mero de elementos</p>
                        </div>`;
                    } else if (concept === 'Expresiones Regulares') {
                        let regexInfo = "";
                        
                        if (regex === 'ADN/ARN') {
                            regexInfo = "Patr贸n para secuencias de ADN/ARN: solo letras A, C, G, T, U (may煤sculas o min煤sculas)";
                        } else if (regex === 'Prote铆nas') {
                            regexInfo = "Patr贸n para secuencias de prote铆nas: solo los 20 amino谩cidos est谩ndar";
                        } else if (regex === 'N煤meros') {
                            regexInfo = "Patr贸n para n煤meros (enteros, decimales, notaci贸n cient铆fica)";
                        } else {
                            regexInfo = "Patr贸n para validar direcciones de correo electr贸nico";
                        }
                        
                        conceptInfo = `
                        <p>Las expresiones regulares son una de las fortalezas de Perl. Permiten buscar y manipular patrones en texto.</p>
                        
                        <p><b>Patr贸n seleccionado: ${regex}</b><br>
                        ${regexInfo}</p>
                        
                        <p><b>Sintaxis b谩sica:</b></p>
                        <ul>
                            <li><code>m/patr贸n/</code> - Buscar patr贸n</li>
                            <li><code>s/patr贸n/reemplazo/</code> - Sustituir</li>
                            <li><code>=~</code> - Operador de coincidencia</li>
                            <li><code>!~</code> - Operador de no coincidencia</li>
                        </ul>
                        
                        <div class="exp-note">
                            <i class="fas fa-dna"></i> <b>Aplicaci贸n en bioinform谩tica:</b>
                            <p>Las regex son esenciales para:<br>
                             Parsear formatos de archivo (FASTA, FASTQ, GenBank)<br>
                             Buscar motivos en secuencias<br>
                             Validar datos de entrada<br>
                             Extraer informaci贸n espec铆fica</p>
                        </div>`;
                    }
                    
                    return `
                    <div class="exp-highlight">
                        <b> Introducci贸n a Perl</b>
                        <p>Perl fue dise帽ado para procesamiento de texto y sigue siendo muy utilizado en bioinform谩tica, especialmente para scripts r谩pidos y pipelines heredados.</p>
                    </div>
                    
                    ${conceptInfo}`;
                },
                render: (p, div) => {
                    div.style.cssText = "width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; box-sizing:border-box;";
                    div.innerHTML = '';
                    
                    const concept = p.perl_concept;
                    const regex = p.regex_pattern;
                    
                    if (concept === 'Variables y Tipos') {
                        // Visualizaci贸n de tipos de datos Perl
                        const typeViz = document.createElement('div');
                        typeViz.style.cssText = "width:90%; max-width:700px; background:white; border-radius:10px; padding:20px; box-shadow:0 5px 15px rgba(0,0,0,0.1);";
                        
                        const types = [
                            {name: "Escalares ($)", desc: "Un solo valor", example: "$gene = 'TP53'", color: "#3498db", icon: "fa-hashtag"},
                            {name: "Arrays (@)", desc: "Lista ordenada", example: "@genes = ('BRCA1', 'TP53')", color: "#2ecc71", icon: "fa-list"},
                            {name: "Hashes (%)", desc: "Pares clave-valor", example: "%functions = ('TP53' => 'Supresor tumoral')", color: "#e74c3c", icon: "fa-key"}
                        ];
                        
                        let typeHTML = `
                        <div style="text-align:center; margin-bottom:20px;">
                            <h3 style="color:#333;">Tipos de Datos en Perl</h3>
                            <p style="color:#666;">Cada tipo usa un s铆mbolo diferente (sigil)</p>
                        </div>
                        
                        <div style="display:flex; justify-content:space-between; gap:20px; margin-bottom:30px;">
                        `;
                        
                        types.forEach(type => {
                            typeHTML += `
                            <div style="flex:1; background:${type.color}10; border-left:4px solid ${type.color}; padding:15px; border-radius:0 5px 5px 0;">
                                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                                    <i class="fas ${type.icon}" style="color:${type.color}; font-size:1.2rem;"></i>
                                    <div style="font-weight:bold; color:#333;">${type.name}</div>
                                </div>
                                <div style="font-size:0.9rem; color:#666; margin-bottom:10px;">${type.desc}</div>
                                <div style="font-family:'Fira Code', monospace; background:#2c3e50; color:white; padding:8px; border-radius:3px; font-size:0.8rem;">
                                    ${type.example}
                                </div>
                            </div>
                            `;
                        });
                        
                        typeHTML += `</div>`;
                        
                        // Ejemplo de contexto
                        typeHTML += `
                        <div style="background:#f8f9fa; padding:15px; border-radius:5px;">
                            <h4 style="color:#333; margin-bottom:10px;">隆Importante! Contexto en Perl</h4>
                            <div style="display:flex; gap:20px;">
                                <div style="flex:1;">
                                    <div style="font-weight:bold; color:#333;">Contexto Lista</div>
                                    <div style="font-family:'Fira Code', monospace; background:#e3f2fd; padding:8px; border-radius:3px; font-size:0.8rem;">
                                        my @copy = @genes;  # Copia todos los elementos
                                    </div>
                                </div>
                                <div style="flex:1;">
                                    <div style="font-weight:bold; color:#333;">Contexto Escalar</div>
                                    <div style="font-family:'Fira Code', monospace; background:#e8f5e9; padding:8px; border-radius:3px; font-size:0.8rem;">
                                        my $count = @genes;  # Cuenta elementos: $count = 4
                                    </div>
                                </div>
                            </div>
                        </div>
                        `;
                        
                        typeViz.innerHTML = typeHTML;
                        div.appendChild(typeViz);
                        
                    } else if (concept === 'Expresiones Regulares') {
                        // Visualizaci贸n de expresiones regulares
                        const regexViz = document.createElement('div');
                        regexViz.style.cssText = "width:90%; max-width:700px; background:white; border-radius:10px; padding:20px; box-shadow:0 5px 15px rgba(0,0,0,0.1);";
                        
                        let pattern = "";
                        let example = "";
                        let matches = [];
                        
                        if (regex === 'ADN/ARN') {
                            pattern = "^[ACGTUacgtu]+$";
                            example = "ATGCTAGCTAGCTAGCTAGCTA";
                            matches = example.split('').map((char, i) => ({
                                char,
                                isMatch: /[ACGTUacgtu]/.test(char),
                                position: i
                            }));
                        } else if (regex === 'Prote铆nas') {
                            pattern = "^[ACDEFGHIKLMNPQRSTVWYacdefghiklmnpqrstvwy]+$";
                            example = "MVLSPADKTNVKAAWGKVGAHAGEYGAEALERMFLSFPTTK";
                            matches = example.split('').map((char, i) => ({
                                char,
                                isMatch: /[ACDEFGHIKLMNPQRSTVWYacdefghiklmnpqrstvwy]/.test(char),
                                position: i
                            }));
                        }
                        
                        let regexHTML = `
                        <div style="text-align:center; margin-bottom:20px;">
                            <h3 style="color:#333;">Expresiones Regulares en Perl</h3>
                            <p style="color:#666;">Patr贸n: ${regex}</p>
                        </div>
                        
                        <div style="background:#2c3e50; color:white; padding:15px; border-radius:5px; margin-bottom:20px; font-family:'Fira Code', monospace;">
                            <div style="color:#4CAF50;">Patr贸n:</div>
                            <div style="margin-left:10px;">${pattern}</div>
                            <div style="color:#4CAF50; margin-top:10px;">Ejemplo:</div>
                            <div style="margin-left:10px;">${example}</div>
                        </div>
                        `;
                        
                        if (matches.length > 0) {
                            regexHTML += `
                            <div style="margin-bottom:20px;">
                                <div style="font-weight:bold; color:#333; margin-bottom:10px;">An谩lisis de coincidencias:</div>
                                <div style="display:flex; flex-wrap:wrap; gap:5px;">
                            `;
                            
                            matches.forEach(match => {
                                regexHTML += `
                                <div style="width:30px; height:30px; display:flex; align-items:center; justify-content:center; 
                                     background:${match.isMatch ? '#2ecc71' : '#e74c3c'}; color:white; font-weight:bold; 
                                     border-radius:3px; position:relative;">
                                    ${match.char}
                                    <div style="position:absolute; bottom:-15px; left:0; right:0; text-align:center; font-size:0.6rem; color:#777;">
                                        ${match.position}
                                    </div>
                                </div>
                                `;
                            });
                            
                            regexHTML += `
                                </div>
                                <div style="display:flex; gap:20px; margin-top:25px; font-size:0.9rem;">
                                    <div><span style="display:inline-block; width:12px; height:12px; background:#2ecc71; border-radius:2px;"></span> Coincide</div>
                                    <div><span style="display:inline-block; width:12px; height:12px; background:#e74c3c; border-radius:2px;"></span> No coincide</div>
                                </div>
                            </div>
                            `;
                        }
                        
                        // Explicaci贸n del patr贸n
                        regexHTML += `
                        <div style="background:#f8f9fa; padding:15px; border-radius:5px;">
                            <h4 style="color:#333; margin-bottom:10px;">Explicaci贸n del patr贸n:</h4>
                            <div style="font-family:'Fira Code', monospace; font-size:0.9rem; color:#555;">
                        `;
                        
                        if (regex === 'ADN/ARN') {
                            regexHTML += `
                            <div><span style="color:#e74c3c;">^</span>         # Inicio de la cadena</div>
                            <div><span style="color:#e74c3c;">[ACGTUacgtu]</span>  # Cualquier letra de ADN/ARN</div>
                            <div><span style="color:#e74c3c;">+</span>         # Una o m谩s ocurrencias</div>
                            <div><span style="color:#e74c3c;">$</span>         # Fin de la cadena</div>
                            `;
                        } else if (regex === 'Prote铆nas') {
                            regexHTML += `
                            <div><span style="color:#e74c3c;">^</span>         # Inicio de la cadena</div>
                            <div><span style="color:#e74c3c;">[ACDEFGHIKLMNPQRSTVWYacdefghiklmnpqrstvwy]</span>  # Amino谩cidos est谩ndar</div>
                            <div><span style="color:#e74c3c;">+</span>         # Una o m谩s ocurrencias</div>
                            <div><span style="color:#e74c3c;">$</span>         # Fin de la cadena</div>
                            `;
                        }
                        
                        regexHTML += `
                            </div>
                        </div>
                        `;
                        
                        regexViz.innerHTML = regexHTML;
                        div.appendChild(regexViz);
                    }
                }
            },
                        {
                id: 9,
                title: "Tema 9. Manipulaci贸n Archivos (Perl)",
                desc: "Lectura, escritura y procesamiento de archivos en Perl",
                icon: "fa-file-alt",
                controls: [
                    {id: 'file_operation', type: 'select', label: 'Operaci贸n', options: ['Leer FASTA', 'Escribir resultados', 'Procesar FASTQ', 'Parsear GenBank']},
                    {id: 'file_size', type: 'range', label: 'Tama帽o Archivo', min: 1, max: 100, step: 1, val: 50}
                ],
                code: (p) => {
                    const operation = p.file_operation;
                    
                    if (operation === 'Leer FASTA') {
                        return `<span class="c-perl">#!/usr/bin/perl</span>
<span class="c-kwd">use</span> strict;
<span class="c-kwd">use</span> warnings;

<span class="c-com"># LECTOR DE ARCHIVOS FASTA EN PERL</span>
<span class="c-kwd">my</span> <span class="c-var">$fasta_file</span> = <span class="c-str">"secuencias.fasta"</span>;

<span class="c-fn">open</span>(<span class="c-kwd">my</span> <span class="c-var">$fh</span>, <span class="c-str">"<"</span>, <span class="c-var">$fasta_file</span>) <span class="c-kwd">or</span> <span class="c-fn">die</span> <span class="c-str">"No se pudo abrir $fasta_file: $!"</span>;

<span class="c-kwd">my</span> <span class="c-var">%sequences</span>;      <span class="c-com"># Hash para almacenar secuencias</span>
<span class="c-kwd">my</span> <span class="c-var">$current_id</span>;    <span class="c-com"># ID de la secuencia actual</span>
<span class="c-kwd">my</span> <span class="c-var">$current_seq</span> = <span class="c-str">""</span>;  <span class="c-com"># Secuencia actual</span>

<span class="c-kwd">while</span> (<span class="c-kwd">my</span> <span class="c-var">$line</span> = <span class="c-fn">readline</span>(<span class="c-var">$fh</span>)) {
    <span class="c-fn">chomp</span> <span class="c-var">$line</span>;  <span class="c-com"># Eliminar salto de l铆nea</span>
    
    <span class="c-kwd">if</span> (<span class="c-var">$line</span> =~ <span class="c-fn">m/^>/</span>) {  <span class="c-com"># L铆nea de encabezado</span>
        <span class="c-com"># Guardar secuencia anterior si existe</span>
        <span class="c-kwd">if</span> (<span class="c-var">$current_id</span>) {
            <span class="c-var">$sequences</span>{<span class="c-var">$current_id</span>} = <span class="c-var">$current_seq</span>;
            <span class="c-var">$current_seq</span> = <span class="c-str">""</span>;
        }
        
        <span class="c-com"># Extraer nuevo ID (todo hasta el primer espacio)</span>
        <span class="c-var">$line</span> =~ <span class="c-fn">s/^>//</span>;  <span class="c-com"># Eliminar '>'</span>
        <span class="c-var">$current_id</span> = (<span class="c-var">$line</span> =~ <span class="c-fn">m/^(\\S+)/</span>) ? <span class="c-var">$1</span> : <span class="c-str">"unknown"</span>;
    } <span class="c-kwd">else</span> {
        <span class="c-com"># L铆nea de secuencia, a帽adir a la secuencia actual</span>
        <span class="c-var">$current_seq</span> .= <span class="c-var">$line</span>;
    }
}

<span class="c-com"># Guardar la 煤ltima secuencia</span>
<span class="c-kwd">if</span> (<span class="c-var">$current_id</span>) {
    <span class="c-var">$sequences</span>{<span class="c-var">$current_id</span>} = <span class="c-var">$current_seq</span>;
}

<span class="c-kwd">close</span>(<span class="c-var">$fh</span>);

<span class="c-com"># Mostrar estad铆sticas</span>
<span class="c-fn">print</span> <span class="c-str">"\\n=== ESTADSTICAS FASTA ===\\n"</span>;
<span class="c-fn">print</span> <span class="c-str">"Total de secuencias: "</span> . <span class="c-fn">scalar</span>(<span class="c-kwd">keys</span> <span class="c-var">%sequences</span>) . <span class="c-str">"\\n"</span>;

<span class="c-com"># Calcular longitud de cada secuencia</span>
<span class="c-kwd">my</span> <span class="c-var">$total_length</span> = <span class="c-num">0</span>;
<span class="c-kwd">my</span> <span class="c-var">$max_length</span> = <span class="c-num">0</span>;
<span class="c-kwd">my</span> <span class="c-var">$min_length</span> = <span class="c-num">9e9</span>;  <span class="c-com"># Un n煤mero muy grande</span>

<span class="c-kwd">foreach</span> <span class="c-kwd">my</span> <span class="c-var">$id</span> (<span class="c-kwd">keys</span> <span class="c-var">%sequences</span>) {
    <span class="c-kwd">my</span> <span class="c-var">$length</span> = <span class="c-fn">length</span>(<span class="c-var">$sequences</span>{<span class="c-var">$id</span>});
    <span class="c-var">$total_length</span> += <span class="c-var">$length</span>;
    
    <span class="c-var">$max_length</span> = <span class="c-var">$length</span> <span class="c-kwd">if</span> <span class="c-var">$length</span> > <span class="c-var">$max_length</span>;
    <span class="c-var">$min_length</span> = <span class="c-var">$length</span> <span class="c-kwd">if</span> <span class="c-var">$length</span> < <span class="c-var">$min_length</span>;
}

<span class="c-kwd">my</span> <span class="c-var">$avg_length</span> = <span class="c-var">$total_length</span> / <span class="c-fn">scalar</span>(<span class="c-kwd">keys</span> <span class="c-var">%sequences</span>);

<span class="c-fn">print</span> <span class="c-str">"Longitud promedio: "</span> . <span class="c-fn">sprintf</span>(<span class="c-str">"%.2f"</span>, <span class="c-var">$avg_length</span>) . <span class="c-str">" bp\\n"</span>;
<span class="c-fn">print</span> <span class="c-str">"Longitud m谩xima: $max_length bp\\n"</span>;
<span class="c-fn">print</span> <span class="c-str">"Longitud m铆nima: $min_length bp\\n"</span>;

<span class="c-com"># Mostrar las primeras 3 secuencias como ejemplo</span>
<span class="c-fn">print</span> <span class="c-str">"\\nPrimeras 3 secuencias:\\n"</span>;
<span class="c-kwd">my</span> <span class="c-var">$count</span> = <span class="c-num">0</span>;
<span class="c-kwd">foreach</span> <span class="c-kwd">my</span> <span class="c-var">$id</span> (<span class="c-kwd">keys</span> <span class="c-var">%sequences</span>) {
    <span class="c-fn">print</span> <span class="c-str">"$id: " </span> . <span class="c-fn">substr</span>(<span class="c-var">$sequences</span>{<span class="c-var">$id</span>}, <span class="c-num">0</span>, <span class="c-num">50</span>) . <span class="c-str">"...\\n"</span>;
    <span class="c-var">$count</span>++;
    <span class="c-kwd">last</span> <span class="c-kwd">if</span> <span class="c-var">$count</span> >= <span class="c-num">3</span>;
}`;
                    } else if (operation === 'Procesar FASTQ') {
                        return `<span class="c-perl">#!/usr/bin/perl</span>
<span class="c-kwd">use</span> strict;
<span class="c-kwd">use</span> warnings;

<span class="c-com"># PROCESADOR DE ARCHIVOS FASTQ</span>
<span class="c-com"># Calcula estad铆sticas de calidad y filtra lecturas</span>

<span class="c-kwd">my</span> <span class="c-var">$fastq_file</span> = <span class="c-str">"secuencias.fastq"</span>;
<span class="c-kwd">my</span> <span class="c-var">$output_file</span> = <span class="c-str">"secuencias_filtradas.fastq"</span>;
<span class="c-kwd">my</span> <span class="c-var">$quality_threshold</span> = <span class="c-num">20</span>;  <span class="c-com"># Phred score m铆nimo</span>
<span class="c-kwd">my</span> <span class="c-var">$min_length</span> = <span class="c-num">50</span>;        <span class="c-com"># Longitud m铆nima</span>

<span class="c-fn">open</span>(<span class="c-kwd">my</span> <span class="c-var">$in_fh</span>, <span class="c-str">"<"</span>, <span class="c-var">$fastq_file</span>) <span class="c-kwd">or</span> <span class="c-fn">die</span> <span class="c-str">"No se pudo abrir $fastq_file: $!"</span>;
<span class="c-fn">open</span>(<span class="c-kwd">my</span> <span class="c-var">$out_fh</span>, <span class="c-str">">"</span>, <span class="c-var">$output_file</span>) <span class="c-kwd">or</span> <span class="c-fn">die</span> <span class="c-str">"No se pudo crear $output_file: $!"</span>;

<span class="c-kwd">my</span> <span class="c-var">$total_reads</span> = <span class="c-num">0</span>;
<span class="c-kwd">my</span> <span class="c-var">$passed_reads</span> = <span class="c-num">0</span>;
<span class="c-kwd">my</span> <span class="c-var">$total_bases</span> = <span class="c-num">0</span>;
<span class="c-kwd">my</span> <span class="c-var">@quality_scores</span>;  <span class="c-com"># Para calcular promedio</span>

<span class="c-com"># Buffer para almacenar un read completo (4 l铆neas)</span>
<span class="c-kwd">my</span> <span class="c-var">@read_buffer</span>;

<span class="c-kwd">while</span> (<span class="c-kwd">my</span> <span class="c-var">$line</span> = <span class="c-fn">readline</span>(<span class="c-var">$in_fh</span>)) {
    <span class="c-fn">push</span> <span class="c-var">@read_buffer</span>, <span class="c-var">$line</span>;
    
    <span class="c-com"># Cuando tenemos 4 l铆neas, procesar el read completo</span>
    <span class="c-kwd">if</span> (<span class="c-fn">scalar</span>(<span class="c-var">@read_buffer</span>) == <span class="c-num">4</span>) {
        <span class="c-var">$total_reads</span>++;
        
        <span class="c-kwd">my</span> (<span class="c-var">$header</span>, <span class="c-var">$sequence</span>, <span class="c-var">$separator</span>, <span class="c-var">$quality</span>) = <span class="c-var">@read_buffer</span>;
        
        <span class="c-fn">chomp</span>(<span class="c-var">$header</span>, <span class="c-var">$sequence</span>, <span class="c-var">$separator</span>, <span class="c-var">$quality</span>);
        
        <span class="c-com"># 1. Verificar longitud m铆nima</span>
        <span class="c-kwd">my</span> <span class="c-var">$seq_length</span> = <span class="c-fn">length</span>(<span class="c-var">$sequence</span>);
        <span class="c-var">$total_bases</span> += <span class="c-var">$seq_length</span>;
        
        <span class="c-kwd">next</span> <span class="c-kwd">if</span> <span class="c-var">$seq_length</span> < <span class="c-var">$min_length</span>;
        
        <span class="c-com"># 2. Calcular calidad promedio</span>
        <span class="c-kwd">my</span> <span class="c-var">$total_quality</span> = <span class="c-num">0</span>;
        
        <span class="c-kwd">for</span> <span class="c-kwd">my</span> <span class="c-var">$i</span> (<span class="c-num">0</span> .. <span class="c-var">$seq_length</span>-<span class="c-num">1</span>) {
            <span class="c-com"># Convertir car谩cter de calidad a Phred score</span>
            <span class="c-kwd">my</span> <span class="c-var">$phred</span> = <span class="c-fn">ord</span>(<span class="c-fn">substr</span>(<span class="c-var">$quality</span>, <span class="c-var">$i</span>, <span class="c-num">1</span>)) - <span class="c-num">33</span>;
            <span class="c-var">$total_quality</span> += <span class="c-var">$phred</span>;
            <span class="c-fn">push</span> <span class="c-var">@quality_scores</span>, <span class="c-var">$phred</span>;
        }
        
        <span class="c-kwd">my</span> <span class="c-var">$avg_quality</span> = <span class="c-var">$total_quality</span> / <span class="c-var">$seq_length</span>;
        
        <span class="c-com"># 3. Filtrar por calidad</span>
        <span class="c-kwd">if</span> (<span class="c-var">$avg_quality</span> >= <span class="c-var">$quality_threshold</span>) {
            <span class="c-var">$passed_reads</span>++;
            <span class="c-fn">print</span> <span class="c-var">$out_fh</span> <span class="c-str">"$header\\n$sequence\\n$separator\\n$quality\\n"</span>;
        }
        
        <span class="c-com"># Limpiar buffer para el pr贸ximo read</span>
        <span class="c-var">@read_buffer</span> = ();
    }
}

<span class="c-kwd">close</span>(<span class="c-var">$in_fh</span>);
<span class="c-kwd">close</span>(<span class="c-var">$out_fh</span>);

<span class="c-com"># Calcular estad铆sticas finales</span>
<span class="c-kwd">my</span> <span class="c-var">$pass_rate</span> = (<span class="c-var">$passed_reads</span> / <span class="c-var">$total_reads</span>) * <span class="c-num">100</span>;

<span class="c-com"># Calcular calidad promedio general</span>
<span class="c-kwd">my</span> <span class="c-var">$total_qscore</span> = <span class="c-num">0</span>;
<span class="c-var">$total_qscore</span> += <span class="c-var">$_</span> <span class="c-kwd">foreach</span> <span class="c-var">@quality_scores</span>;
<span class="c-kwd">my</span> <span class="c-var">$overall_avg_quality</span> = <span class="c-var">$total_qscore</span> / <span class="c-fn">scalar</span>(<span class="c-var">@quality_scores</span>);

<span class="c-fn">print</span> <span class="c-str">"\\n=== ESTADSTICAS FASTQ ===\\n"</span>;
<span class="c-fn">print</span> <span class="c-str">"Total de lecturas: $total_reads\\n"</span>;
<span class="c-fn">print</span> <span class="c-str">"Lecturas que pasan filtros: $passed_reads ("</span> . <span class="c-fn">sprintf</span>(<span class="c-str">"%.2f"</span>, <span class="c-var">$pass_rate</span>) . <span class="c-str">"%)\\n"</span>;
<span class="c-fn">print</span> <span class="c-str">"Total de bases: $total_bases\\n"</span>;
<span class="c-fn">print</span> <span class="c-str">"Calidad promedio (Phred): "</span> . <span class="c-fn">sprintf</span>(<span class="c-str">"%.2f"</span>, <span class="c-var">$overall_avg_quality</span>) . <span class="c-str">"\\n"</span>;
<span class="c-fn">print</span> <span class="c-str">"Archivo filtrado guardado en: $output_file\\n"</span>`;
                    } else {
                        // Para las otras opciones, devolver un c贸digo simple
                        return `<span class="c-com"># C贸digo para ${operation} en Perl</span>`;
                    }
                },
                explain: (p) => {
                    const operation = p.file_operation;
                    const size = p.file_size;
                    
                    let operationInfo = "";
                    
                    if (operation === 'Leer FASTA') {
                        operationInfo = `
                        <p>El formato FASTA es uno de los m谩s utilizados en bioinform谩tica para almacenar secuencias biol贸gicas.</p>
                        
                        <p><b>Estructura FASTA:</b></p>
                        <ul>
                            <li><b>L铆nea de encabezado:</b> Comienza con '>' seguido del identificador y descripci贸n</li>
                            <li><b>L铆neas de secuencia:</b> Secuencia en una o m煤ltiples l铆neas</li>
                        </ul>
                        
                        <p><b>Algoritmo de lectura:</b></p>
                        <ol>
                            <li>Abrir archivo en modo lectura</li>
                            <li>Leer l铆nea por l铆nea</li>
                            <li>Detectar l铆neas de encabezado (comienzan con '>')</li>
                            <li>Acumular secuencia hasta el siguiente encabezado o EOF</li>
                            <li>Almacenar en estructura de datos (hash en Perl)</li>
                        </ol>
                        
                        <div class="exp-note">
                            <i class="fas fa-database"></i> <b>Importante en bioinform谩tica:</b>
                            <p>Los archivos FASTA pueden ser enormes (genomas completos). Es crucial usar memoria eficientemente y procesar en streaming cuando sea posible.</p>
                        </div>`;
                    } else if (operation === 'Procesar FASTQ') {
                        operationInfo = `
                        <p>El formato FASTQ almacena secuencias y sus calidades de forma intercalada. Es el est谩ndar en secuenciaci贸n de nueva generaci贸n.</p>
                        
                        <p><b>Estructura FASTQ (4 l铆neas por lectura):</b></p>
                        <ol>
                            <li><b>Encabezado:</b> @ID opcionalmente con descripci贸n</li>
                            <li><b>Secuencia:</b> Bases nucleot铆dicas</li>
                            <li><b>Separador:</b> + opcionalmente con ID</li>
                            <li><b>Calidad:</b> Caracteres ASCII representando Phred scores</li>
                        </ol>
                        
                        <p><b>Filtrado por calidad:</b></p>
                        <p>Los Phred scores (Q) indican la probabilidad de error: Q = -10log(P_error).</p>
                        <ul>
                            <li>Q20: 1% probabilidad de error (99% de precisi贸n)</li>
                            <li>Q30: 0.1% probabilidad de error (99.9% de precisi贸n)</li>
                            <li>Q40: 0.01% probabilidad de error (99.99% de precisi贸n)</li>
                        </ul>
                        
                        <div class="exp-note">
                            <i class="fas fa-filter"></i> <b>Filtros comunes:</b>
                            <p> Calidad promedio por lectura<br>
                             Longitud m铆nima/m谩xima<br>
                             Presencia de adaptadores<br>
                             Contenido de Ns (bases desconocidas)</p>
                        </div>`;
                    }
                    
                    return `
                    <div class="exp-highlight">
                        <b> Manipulaci贸n de Archivos en Perl</b>
                        <p>Perl es excepcional para procesar archivos de texto, formato com煤n en bioinform谩tica.</p>
                    </div>
                    
                    <p><b>Operaci贸n: ${operation}</b></p>
                    
                    ${operationInfo}`;
                },
                render: (p, div) => {
                    div.style.cssText = "width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; box-sizing:border-box;";
                    div.innerHTML = '';
                    
                    const operation = p.file_operation;
                    const size = p.file_size;
                    
                    // Crear visualizaci贸n de procesamiento de archivos
                    const fileViz = document.createElement('div');
                    fileViz.style.cssText = "width:90%; max-width:700px; background:white; border-radius:10px; padding:20px; box-shadow:0 5px 15px rgba(0,0,0,0.1);";
                    
                    let fileHTML = `
                    <div style="text-align:center; margin-bottom:20px;">
                        <h3 style="color:#333;">${operation} en Perl</h3>
                        <p style="color:#666;">Tama帽o simulado: ${size}MB</p>
                    </div>
                    
                    <div style="display:flex; gap:20px; margin-bottom:30px;">
                        <div style="flex:1; text-align:center;">
                            <div style="width:80px; height:80px; border-radius:50%; background:#3498db; color:white; 
                                 display:flex; align-items:center; justify-content:center; margin:0 auto 10px; font-size:2rem;">
                                <i class="fas fa-file-import"></i>
                            </div>
                            <div style="font-weight:bold; color:#333;">Archivo de Entrada</div>
                            <div style="font-size:0.9rem; color:#666;">${size}MB</div>
                        </div>
                        
                        <div style="flex:1; text-align:center;">
                            <div style="width:80px; height:80px; border-radius:50%; background:#f39c12; color:white; 
                                 display:flex; align-items:center; justify-content:center; margin:0 auto 10px; font-size:2rem;">
                                <i class="fas fa-cogs"></i>
                            </div>
                            <div style="font-weight:bold; color:#333;">Procesando</div>
                            <div style="font-size:0.9rem; color:#666;">Perl script</div>
                        </div>
                        
                        <div style="flex:1; text-align:center;">
                            <div style="width:80px; height:80px; border-radius:50%; background:#2ecc71; color:white; 
                                 display:flex; align-items:center; justify-content:center; margin:0 auto 10px; font-size:2rem;">
                                <i class="fas fa-file-export"></i>
                            </div>
                            <div style="font-weight:bold; color:#333;">Resultados</div>
                            <div style="font-size:0.9rem; color:#666;">${Math.floor(size * 0.8)}MB</div>
                        </div>
                    </div>
                    `;
                    
                    // Barras de progreso
                    fileHTML += `
                    <div style="margin-bottom:20px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <div style="font-weight:bold; color:#333;">Progreso de lectura</div>
                            <div id="readProgress" style="color:#3498db; font-weight:bold;">0%</div>
                        </div>
                        <div style="width:100%; height:10px; background:#ecf0f1; border-radius:5px; overflow:hidden;">
                            <div id="readBar" style="height:100%; background:#3498db; width:0%; transition:width 2s ease-in-out;"></div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom:20px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <div style="font-weight:bold; color:#333;">Procesamiento</div>
                            <div id="processProgress" style="color:#f39c12; font-weight:bold;">0%</div>
                        </div>
                        <div style="width:100%; height:10px; background:#ecf0f1; border-radius:5px; overflow:hidden;">
                            <div id="processBar" style="height:100%; background:#f39c12; width:0%; transition:width 2s ease-in-out 1s;"></div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom:20px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <div style="font-weight:bold; color:#333;">Escritura de resultados</div>
                            <div id="writeProgress" style="color:#2ecc71; font-weight:bold;">0%</div>
                        </div>
                        <div style="width:100%; height:10px; background:#ecf0f1; border-radius:5px; overflow:hidden;">
                            <div id="writeBar" style="height:100%; background:#2ecc71; width:0%; transition:width 2s ease-in-out 2s;"></div>
                        </div>
                    </div>
                    `;
                    
                    // Simulaci贸n de contenido de archivo
                    if (operation === 'Leer FASTA') {
                        fileHTML += `
                        <div style="background:#f8f9fa; padding:15px; border-radius:5px; font-family:'Fira Code', monospace; font-size:0.9rem;">
                            <div style="color:#e74c3c;">>gene_001 Homo sapiens TP53 gene</div>
                            <div style="color:#333;">ATGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTA</div>
                            <div style="color:#e74c3c;">>gene_002 BRCA1 DNA repair associated</div>
                            <div style="color:#333;">ATGCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCG</div>
                            <div style="color:#e74c3c;">>gene_003 EGFR epidermal growth factor receptor</div>
                            <div style="color:#333;">ATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCGATCG</div>
                        </div>
                        `;
                    } else if (operation === 'Procesar FASTQ') {
                        fileHTML += `
                        <div style="background:#f8f9fa; padding:15px; border-radius:5px; font-family:'Fira Code', monospace; font-size:0.8rem;">
                            <div style="color:#e74c3c;">@SEQ_ID:1</div>
                            <div style="color:#333;">GATTTGGGGTTCAAAGCAGTATCGATCAAATAGTAAATCCATTTGTTCAACTCACAGTTT</div>
                            <div style="color:#3498db;">+</div>
                            <div style="color:#2ecc71;">!''*((((***+))%%%++)(%%%%).1***-+*''))**55CCF>>>>>>CCCCCCC65</div>
                            <div style="border-top:1px dashed #ddd; margin:10px 0; padding-top:10px;">
                                <div style="color:#777;">Calidad Phred: 20-35 (buena calidad)</div>
                                <div style="color:#777;">Longitud: 60 bp</div>
                                <div style="color:#777;">Estado: <span id="readStatus" style="color:#2ecc71;"> Aceptada</span></div>
                            </div>
                        </div>
                        `;
                    }
                    
                    fileViz.innerHTML = fileHTML;
                    div.appendChild(fileViz);
                    
                    // Animar las barras de progreso
                    setTimeout(() => {
                        const readBar = document.getElementById('readBar');
                        const readProgress = document.getElementById('readProgress');
                        const processBar = document.getElementById('processBar');
                        const processProgress = document.getElementById('processProgress');
                        const writeBar = document.getElementById('writeBar');
                        const writeProgress = document.getElementById('writeProgress');
                        
                        if (readBar && readProgress) {
                            readBar.style.width = "100%";
                            readProgress.textContent = "100%";
                        }
                        
                        setTimeout(() => {
                            if (processBar && processProgress) {
                                processBar.style.width = "100%";
                                processProgress.textContent = "100%";
                            }
                        }, 1000);
                        
                        setTimeout(() => {
                            if (writeBar && writeProgress) {
                                writeBar.style.width = "100%";
                                writeProgress.textContent = "100%";
                            }
                        }, 2000);
                    }, 500);
                }
            },
            {
                id: 10,
                title: "Tema 10. Expresiones Regulares",
                desc: "Patrones, b煤squeda y manipulaci贸n avanzada de texto",
                icon: "fa-search",
                controls: [
                    {id: 'regex_type', type: 'select', label: 'Tipo de Regex', options: ['Patrones ADN', 'Patrones Prote铆nas', 'Parseo de Formatos', 'Validaci贸n']},
                    {id: 'complexity', type: 'range', label: 'Complejidad Patr贸n', min: 1, max: 10, step: 1, val: 5}
                ],
                code: (p) => {
                    const type = p.regex_type;
                    
                    if (type === 'Patrones ADN') {
                        return `<span class="c-perl">#!/usr/bin/perl</span>
<span class="c-kwd">use</span> strict;
<span class="c-kwd">use</span> warnings;

<span class="c-com"># PATRONES COMUNES EN SECUENCIAS DE ADN</span>

<span class="c-kwd">my</span> <span class="c-var">$dna_sequence</span> = <span class="c-str">"ATGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTA"</span>;

<span class="c-com"># 1. Buscar cod贸n de inicio (ATG)</span>
<span class="c-kwd">if</span> (<span class="c-var">$dna_sequence</span> =~ <span class="c-fn">m/ATG/</span>) {
    <span class="c-fn">print</span> <span class="c-str">"Cod贸n de inicio encontrado en posici贸n "</span> . <span class="c-fn">pos</span>(<span class="c-var">$dna_sequence</span>) . <span class="c-str">"\\n"</span>;
}

<span class="c-com"># 2. Buscar codones de parada (TAA, TAG, TGA)</span>
<span class="c-kwd">while</span> (<span class="c-var">$dna_sequence</span> =~ <span class="c-fn">m/(TAA|TAG|TGA)/g</span>) {
    <span class="c-fn">print</span> <span class="c-str">"Cod贸n de parada encontrado: $1 en posici贸n "</span> . (<span class="c-fn">pos</span>(<span class="c-var">$dna_sequence</span>) - <span class="c-num">3</span>) . <span class="c-str">"\\n"</span>;
}

<span class="c-com"># 3. Buscar marcos de lectura abiertos (ORFs)</span>
<span class="c-com"># Un ORF comienza con ATG y termina con cod贸n de parada</span>
<span class="c-kwd">while</span> (<span class="c-var">$dna_sequence</span> =~ <span class="c-fn">m/ATG(?:[ACGT]{3})*?(?:TAA|TAG|TGA)/g</span>) {
    <span class="c-kwd">my</span> <span class="c-var">$orf</span> = <span class="c-var">$&</span>;
    <span class="c-fn">print</span> <span class="c-str">"ORF encontrado: $orf (longitud: "</span> . <span class="c-fn">length</span>(<span class="c-var">$orf</span>) . <span class="c-str">")\\n"</span>;
}

<span class="c-com"># 4. Buscar sitios de restricci贸n comunes</span>
<span class="c-kwd">my</span> <span class="c-var">%restriction_sites</span> = (
    <span class="c-str">"EcoRI"</span>   => <span class="c-str">"GAATTC"</span>,
    <span class="c-str">"BamHI"</span>   => <span class="c-str">"GGATCC"</span>,
    <span class="c-str">"HindIII"</span> => <span class="c-str">"AAGCTT"</span>,
    <span class="c-str">"NotI"</span>    => <span class="c-str">"GCGGCCGC"</span>,
);

<span class="c-fn">print</span> <span class="c-str">"\\nSitios de restricci贸n encontrados:\\n"</span>;
<span class="c-kwd">foreach</span> <span class="c-kwd">my</span> <span class="c-var">$enzyme</span> (<span class="c-kwd">keys</span> <span class="c-var">%restriction_sites</span>) {
    <span class="c-kwd">my</span> <span class="c-var">$site</span> = <span class="c-var">$restriction_sites</span>{<span class="c-var">$enzyme</span>};
    <span class="c-kwd">my</span> <span class="c-var">$count</span> = <span class="c-num">0</span>;
    
    <span class="c-com"># Contar ocurrencias</span>
    <span class="c-var">$count</span>++ <span class="c-kwd">while</span> <span class="c-var">$dna_sequence</span> =~ <span class="c-fn">m/$site/g</span>;
    
    <span class="c-fn">print</span> <span class="c-str">"$enzyme ($site): $count ocurrencias\\n"</span> <span class="c-kwd">if</span> <span class="c-var">$count</span> > <span class="c-num">0</span>;
}

<span class="c-com"># 5. Buscar repeticiones de nucle贸tidos</span>
<span class="c-com"># Ejemplo: 3 o m谩s repeticiones consecutivas del mismo nucle贸tido</span>
<span class="c-kwd">while</span> (<span class="c-var">$dna_sequence</span> =~ <span class="c-fn">m/([ACGT])\\1{2,}/g</span>) {
    <span class="c-fn">print</span> <span class="c-str">"Repetici贸n encontrada: $& (posici贸n "</span> . (<span class="c-fn">pos</span>(<span class="c-var">$dna_sequence</span>) - <span class="c-fn">length</span>(<span class="c-var">$&</span>)) . <span class="c-str">")\\n"</span>;
}

<span class="c-com"># 6. Buscar motivos espec铆ficos</span>
<span class="c-com"># Ejemplo: motivo TATA box (TATAAA o variantes)</span>
<span class="c-kwd">if</span> (<span class="c-var">$dna_sequence</span> =~ <span class="c-fn">m/TATA[AT]A[AT]/</span>) {
    <span class="c-fn">print</span> <span class="c-str">"Posible TATA box encontrado\\n"</span>;
}

<span class="c-com"># 7. Transformar ADN a ARN (T -> U)</span>
<span class="c-kwd">my</span> <span class="c-var">$rna_sequence</span> = <span class="c-var">$dna_sequence</span>;
<span class="c-var">$rna_sequence</span> =~ <span class="c-fn">s/T/U/g</span>;
<span class="c-fn">print</span> <span class="c-str">"\\nSecuencia de ARN: $rna_sequence\\n"</span>;

<span class="c-com"># 8. Calcular contenido GC</span>
<span class="c-kwd">my</span> <span class="c-var">$gc_count</span> = <span class="c-num">0</span>;
<span class="c-var">$gc_count</span> += <span class="c-fn">length</span>(<span class="c-var">$1</span>) <span class="c-kwd">while</span> <span class="c-var">$dna_sequence</span> =~ <span class="c-fn">m/([GC])/g</span>;
<span class="c-kwd">my</span> <span class="c-var">$gc_percentage</span> = (<span class="c-var">$gc_count</span> / <span class="c-fn">length</span>(<span class="c-var">$dna_sequence</span>)) * <span class="c-num">100</span>;

<span class="c-fn">print</span> <span class="c-str">"Contenido GC: "</span> . <span class="c-fn">sprintf</span>(<span class="c-str">"%.2f"</span>, <span class="c-var">$gc_percentage</span>) . <span class="c-str">"%\\n"</span>;</span>`;
                    }
                    
                    return code;
                },
                explain: (p) => {
                    const type = p.regex_type;
                    const complexity = p.complexity;
                    
                    let typeInfo = "";
                    
                    if (type === 'Patrones ADN') {
                        typeInfo = `
                        <p>Las expresiones regulares son esenciales para buscar patrones en secuencias biol贸gicas.</p>
                        
                        <p><b>Patrones comunes en ADN:</b></p>
                        <ul>
                            <li><b>Codones de inicio:</b> ATG</li>
                            <li><b>Codones de parada:</b> TAA, TAG, TGA</li>
                            <li><b>Sitios de restricci贸n:</b> Secuencias espec铆ficas reconocidas por enzimas</li>
                            <li><b>Repeticiones:</b> Motivos que se repiten</li>
                            <li><b>Marcos de lectura abiertos (ORFs):</b> Secuencias entre cod贸n de inicio y de parada</li>
                        </ul>
                        
                        <p><b>Consideraciones importantes:</b></p>
                        <ol>
                            <li>El ADN puede estar en ambas hebras (sentido y antisentido)</li>
                            <li>Las secuencias pueden contener ambig眉edades (N, R, Y, etc.)</li>
                            <li>Los patrones pueden buscar en marcos de lectura diferentes</li>
                            <li>La complementariedad inversa debe considerarse</li>
                        </ol>
                        
                        <div class="exp-note">
                            <i class="fas fa-dna"></i> <b>Notaci贸n IUPAC para nucle贸tidos:</b>
                            <p>A = Adenina, C = Citosina, G = Guanina, T = Timina<br>
                            R = A/G (purina), Y = C/T (pirimidina)<br>
                            S = G/C, W = A/T, K = G/T, M = A/C<br>
                            B = C/G/T, D = A/G/T, H = A/C/T, V = A/C/G<br>
                            N = A/C/G/T (cualquiera)</p>
                        </div>`;
                    }
                    
                    return `
                    <div class="exp-highlight">
                        <b> Expresiones Regulares Avanzadas</b>
                        <p>Las expresiones regulares (regex) permiten buscar patrones complejos en texto. En bioinform谩tica, son cruciales para an谩lisis de secuencias.</p>
                    </div>
                    
                    <p><b>Tipo: ${type}</b></p>
                    <p><b>Complejidad del patr贸n: ${complexity}/10</b></p>
                    
                    ${typeInfo}
                    
                    <div class="exp-note">
                        <i class="fas fa-lightbulb"></i> <b>Optimizaci贸n de regex en Perl:</b>
                        <p>1. Usar <code>/o</code> para compilar una sola vez<br>
                        2. Precompilar patrones con <code>qr//</code><br>
                        3. Evitar backtracking excesivo<br>
                        4. Usar caracteres espec铆ficos en lugar de <code>.</code> cuando sea posible<br>
                        5. Considerar usar <code>study()</code> para cadenas grandes</p>
                    </div>`;
                },
                render: (p, div) => {
                    div.style.cssText = "width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; box-sizing:border-box;";
                    div.innerHTML = '';
                    
                    const type = p.regex_type;
                    const complexity = p.complexity;
                    
                    // Crear visualizaci贸n de expresiones regulares
                    const regexViz = document.createElement('div');
                    regexViz.style.cssText = "width:90%; max-width:700px; background:white; border-radius:10px; padding:20px; box-shadow:0 5px 15px rgba(0,0,0,0.1);";
                    
                    // Secuencia de ADN de ejemplo
                    const dnaSequence = "ATGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTAGCTA";
                    
                    // Definir patrones a buscar
                    const patterns = [
                        {name: "Cod贸n Inicio", pattern: /ATG/g, color: "#e74c3c"},
                        {name: "Cod贸n Parada", pattern: /(TAA|TAG|TGA)/g, color: "#3498db"},
                        {name: "EcoRI Site", pattern: /GAATTC/g, color: "#2ecc71"},
                        {name: "Repeticiones", pattern: /([ACGT])\1{2,}/g, color: "#f39c12"}
                    ];
                    
                    // Encontrar todas las coincidencias
                    let matches = [];
                    patterns.forEach(pattern => {
                        const regex = new RegExp(pattern.pattern.source, 'g');
                        let match;
                        while ((match = regex.exec(dnaSequence)) !== null) {
                            matches.push({
                                start: match.index,
                                end: match.index + match[0].length,
                                pattern: pattern.name,
                                color: pattern.color,
                                text: match[0]
                            });
                        }
                    });
                    
                    // Ordenar coincidencias por posici贸n
                    matches.sort((a, b) => a.start - b.start);
                    
                    let regexHTML = `
                    <div style="text-align:center; margin-bottom:20px;">
                        <h3 style="color:#333;">An谩lisis de Secuencia con Expresiones Regulares</h3>
                        <p style="color:#666;">${type} - Complejidad: ${complexity}/10</p>
                    </div>
                    
                    <div style="background:#f8f9fa; padding:15px; border-radius:5px; margin-bottom:20px;">
                        <div style="font-weight:bold; color:#333; margin-bottom:10px;">Secuencia de ADN:</div>
                        <div style="font-family:'Fira Code', monospace; font-size:0.9rem; background:#2c3e50; color:white; padding:10px; border-radius:3px; position:relative; overflow-x:auto;">
                            <div id="dnaSequence" style="letter-spacing:2px; line-height:1.8; white-space:nowrap;">
                    `;
                    
                    // Mostrar secuencia con resaltado
                    let lastPos = 0;
                    const sequenceDiv = document.createElement('div');
                    
                    matches.forEach((match, i) => {
                        // A帽adir texto antes de la coincidencia
                        if (match.start > lastPos) {
                            regexHTML += dnaSequence.substring(lastPos, match.start);
                        }
                        
                        // A帽adir coincidencia resaltada
                        regexHTML += `<span style="background:${match.color}; color:white; padding:2px 0; border-radius:2px; position:relative;" title="${match.pattern}: ${match.text}">${match.text}</span>`;
                        
                        lastPos = match.end;
                    });
                    
                    // A帽adir texto restante
                    if (lastPos < dnaSequence.length) {
                        regexHTML += dnaSequence.substring(lastPos);
                    }
                    
                    regexHTML += `
                            </div>
                        </div>
                    </div>
                    `;
                    
                    // Leyenda de patrones
                    regexHTML += `
                    <div style="margin-bottom:20px;">
                        <div style="font-weight:bold; color:#333; margin-bottom:10px;">Patrones encontrados:</div>
                        <div style="display:flex; flex-wrap:wrap; gap:10px;">
                    `;
                    
                    patterns.forEach(pattern => {
                        const patternMatches = matches.filter(m => m.pattern === pattern.name);
                        regexHTML += `
                        <div style="display:flex; align-items:center; gap:5px;">
                            <div style="width:12px; height:12px; background:${pattern.color}; border-radius:2px;"></div>
                            <div style="font-size:0.9rem;">${pattern.name}: ${patternMatches.length}</div>
                        </div>
                        `;
                    });
                    
                    regexHTML += `</div></div>`;
                    
                    // Gr谩fico de complejidad
                    regexHTML += `
                    <div style="margin-bottom:20px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <div style="font-weight:bold; color:#333;">Complejidad del patr贸n</div>
                            <div style="color:#333; font-weight:bold;">${complexity}/10</div>
                        </div>
                        <div style="width:100%; height:10px; background:#ecf0f1; border-radius:5px; overflow:hidden;">
                            <div style="height:100%; background:linear-gradient(to right, #2ecc71, #f39c12, #e74c3c); width:${complexity * 10}%;"></div>
                        </div>
                        <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#666; margin-top:5px;">
                            <div>Simple</div>
                            <div>Moderado</div>
                            <div>Complejo</div>
                        </div>
                    </div>
                    `;
                    
                    // Estad铆sticas
                    const totalMatches = matches.length;
                    const uniquePatterns = [...new Set(matches.map(m => m.pattern))].length;
                    
                    regexHTML += `
                    <div style="background:#f8f9fa; padding:15px; border-radius:5px;">
                        <div style="font-weight:bold; color:#333; margin-bottom:10px;">Estad铆sticas:</div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                            <div>
                                <div style="font-size:0.9rem; color:#666;">Longitud secuencia</div>
                                <div style="font-weight:bold; color:#333;">${dnaSequence.length} bp</div>
                            </div>
                            <div>
                                <div style="font-size:0.9rem; color:#666;">Coincidencias totales</div>
                                <div style="font-weight:bold; color:#333;">${totalMatches}</div>
                            </div>
                            <div>
                                <div style="font-size:0.9rem; color:#666;">Tipos de patrones</div>
                                <div style="font-weight:bold; color:#333;">${uniquePatterns}</div>
                            </div>
                            <div>
                                <div style="font-size:0.9rem; color:#666;">Cobertura</div>
                                <div style="font-weight:bold; color:#333;">${((matches.reduce((sum, m) => sum + (m.end - m.start), 0) / dnaSequence.length) * 100).toFixed(1)}%</div>
                            </div>
                        </div>
                    </div>
                    `;
                    
                    regexViz.innerHTML = regexHTML;
                    div.appendChild(regexViz);
                }
            }
        ];

        // --- VARIABLES GLOBALES ---
        let currentLesson = 0;
        let params = {};

        // --- INICIALIZACIN ---
        function init() {
            renderMenu();
            loadLesson(0);
            updateProgress();
        }

        // --- RENDERIZAR MEN ---
        function renderMenu() {
            const menu = document.getElementById('menuList');
            menu.innerHTML = '';
            
            lessons.forEach((lesson, index) => {
                const item = document.createElement('div');
                item.className = `menu-item ${index === currentLesson ? 'active' : ''}`;
                item.onclick = () => loadLesson(index);
                
                item.innerHTML = `
                    <div class="menu-icon"><i class="fas ${lesson.icon}"></i></div>
                    <div class="menu-text">
                        <h4>${lesson.title}</h4>
                        <p>${lesson.desc}</p>
                    </div>
                `;
                
                menu.appendChild(item);
            });
        }

        // --- CARGAR LECCIN ---
        function loadLesson(index) {
            currentLesson = index;
            const lesson = lessons[index];
            
            // Actualizar men煤
            renderMenu();
            
            // Inicializar par谩metros por defecto
            if (!params[index]) {
                params[index] = {};
                lesson.controls.forEach(control => {
                    if (control.type === 'range') {
                        params[index][control.id] = control.val || control.min;
                    } else if (control.type === 'select') {
                        params[index][control.id] = control.options[0];
                    }
                });
            }
            
            // Renderizar controles
            renderControls(lesson);
            
            // Renderizar c贸digo
            renderCode(lesson);
            
            // Renderizar explicaci贸n
            renderExplanation(lesson);
            
            // Renderizar visualizaci贸n
            renderVisualization(lesson);
            
            // Actualizar progreso
            updateProgress();
        }

        // --- RENDERIZAR CONTROLES ---
        function renderControls(lesson) {
            const controlsDiv = document.getElementById('controlsArea');
            controlsDiv.innerHTML = '';
            
            lesson.controls.forEach(control => {
                const group = document.createElement('div');
                group.className = 'control-group';
                
                const label = document.createElement('span');
                label.className = 'control-label';
                label.textContent = control.label;
                group.appendChild(label);
                
                if (control.type === 'select') {
                    const select = document.createElement('select');
                    select.id = control.id;
                    
                    control.options.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option;
                        opt.textContent = option;
                        if (params[currentLesson][control.id] === option) {
                            opt.selected = true;
                        }
                        select.appendChild(opt);
                    });
                    
                    select.onchange = (e) => {
                        params[currentLesson][control.id] = e.target.value;
                        updateLesson();
                    };
                    
                    group.appendChild(select);
                } else if (control.type === 'range') {
                    const range = document.createElement('input');
                    range.type = 'range';
                    range.id = control.id;
                    range.min = control.min;
                    range.max = control.max;
                    range.step = control.step || 1;
                    range.value = params[currentLesson][control.id] || control.val;
                    
                    const valueDisplay = document.createElement('span');
                    valueDisplay.textContent = range.value;
                    valueDisplay.style.minWidth = '20px';
                    valueDisplay.style.textAlign = 'center';
                    
                    range.oninput = (e) => {
                        params[currentLesson][control.id] = e.target.value;
                        valueDisplay.textContent = e.target.value;
                        updateLesson();
                    };
                    
                    group.appendChild(range);
                    group.appendChild(valueDisplay);
                }
                
                controlsDiv.appendChild(group);
            });
        }

        // --- RENDERIZAR CDIGO ---
        function renderCode(lesson) {
            const editor = document.getElementById('codeEditor');
            editor.innerHTML = lesson.code(params[currentLesson]);
        }

        // --- RENDERIZAR EXPLICACIN ---
        function renderExplanation(lesson) {
            const explanation = document.getElementById('explanationText');
            explanation.innerHTML = lesson.explain(params[currentLesson]);
        }

        // --- RENDERIZAR VISUALIZACIN ---
        function renderVisualization(lesson) {
            const canvas = document.getElementById('canvasArea');
            if (lesson.render) {
                lesson.render(params[currentLesson], canvas);
            } else {
                canvas.innerHTML = '<div style="color:#666; font-size:1.2rem; text-align:center; width:100%; padding:50px;">Visualizaci贸n interactiva para esta lecci贸n</div>';
            }
        }

        // --- ACTUALIZAR LECCIN ---
        function updateLesson() {
            const lesson = lessons[currentLesson];
            renderCode(lesson);
            renderExplanation(lesson);
            renderVisualization(lesson);
        }

        // --- ACTUALIZAR BARRA DE PROGRESO ---
        function updateProgress() {
            const progress = document.getElementById('progressFill');
            const percent = ((currentLesson + 1) / lessons.length) * 100;
            progress.style.width = percent + '%';
        }

        // --- INICIALIZAR APLICACIN ---
        window.onload = init;
    </script>
</body>
</html>